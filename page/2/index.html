<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Page 2 | 阿鹏的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="java go devops kubernetes docker">
<meta name="keywords" content="java go devops kubernetes docker">
<meta property="og:type" content="website">
<meta property="og:title" content="阿鹏的博客">
<meta property="og:url" content="http://sunshanpeng.com/page/2/index.html">
<meta property="og:site_name" content="阿鹏的博客">
<meta property="og:description" content="java go devops kubernetes docker">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="阿鹏的博客">
<meta name="twitter:description" content="java go devops kubernetes docker">
  
    <link rel="alternate" href="/atom.xml" title="阿鹏的博客" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body>


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg,https://source.unsplash.com/collection/954550/1920x1080,https://source.unsplash.com/collection/954550/1920x1081".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="阿鹏的博客" rel="home"> 阿鹏的博客 </a>
            
          </h1>
          
          
            <div class="site-description">java go devops kubernetes docker</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-使用同一个deployment实现金丝雀（灰度）发布" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/使用同一个deployment实现金丝雀（灰度）发布/">使用同一个deployment实现金丝雀（灰度）发布</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/使用同一个deployment实现金丝雀（灰度）发布/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、发布前"><a href="#一、发布前" class="headerlink" title="一、发布前"></a>一、发布前</h2><p>发布前，nginx运行三个实例（pod），<em>副本（replicaset）版本编号855b564c8d</em>，此时运行状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="二、发布中"><a href="#二、发布中" class="headerlink" title="二、发布中"></a>二、发布中</h2><h3 id="步骤一：发布"><a href="#步骤一：发布" class="headerlink" title="步骤一：发布"></a>步骤一：发布</h3><p>此时进行发布，<em>新副本版本编号77b6c7b585</em>，此时发布状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                         0/1       Running            0          21s       172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="步骤二：暂停"><a href="#步骤二：暂停" class="headerlink" title="步骤二：暂停"></a>步骤二：暂停</h3><p><strong>执行暂停命令<code>kubectl rollout pause deployment -n qa nginx</code></strong></p>
<p>等待第一个实例运行成功，此时状态如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                         1/1       Running            0          1m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时为暂停发布状态，三个旧版本实例正常运行，一个新版本实例运行成功，流量将分摊到这四个实例上。</p>
</blockquote>
<h3 id="步骤三：恢复"><a href="#步骤三：恢复" class="headerlink" title="步骤三：恢复"></a>步骤三：恢复</h3><p><strong>执行恢复命令<code>kubectl rollout resume deployment -n qa nginx</code></strong></p>
<p>此时状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                         0/1       Running            0          33s       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                        1/1       Running            0          1m        172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>恢复后会执行正常的滚动升级操作，即新增一个新副本实例，删除一个旧副本实例。<br>滚动升级时，新旧版本同时存在，总实例最大数量不会超过目标数量的25%，最小数量不会低于目标数量的75%。</p>
</blockquote>
<h2 id="三、发布完成"><a href="#三、发布完成" class="headerlink" title="三、发布完成"></a>三、发布完成</h2><p>实例的副本版本编号都变成77b6c7b585，说明全部升级成功，此时状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                       1/1       Running            0          36m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                      1/1       Running            0          36m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                      1/1       Running            0          2m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="四、回滚"><a href="#四、回滚" class="headerlink" title="四、回滚"></a>四、回滚</h2><p>发布中发现功能与预期不符，需要取消发布并回滚至上个发布版本，此时可以执行回滚操作。<br><strong>执行回滚命令<code>kubectl rollout undo deployment -n qa nginx</code></strong>。<br>回滚操作在发布中，发布后都可以执行。</p>
<h3 id="发布中回滚"><a href="#发布中回滚" class="headerlink" title="发布中回滚"></a>发布中回滚</h3><p>当暂停发布进行灰度验证时，发现功能不符合预期，需要取消发布。<br>暂停时灰度验证状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                         1/1       Running            0          2m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>回滚后状态:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-jqbjk                         1/1       Running            0          2m        172.20.235.215   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>副本编号变成855b564c8d，说明回滚成功，恢复到新版本。</p>
</blockquote>
<h3 id="发布完成后回滚"><a href="#发布完成后回滚" class="headerlink" title="发布完成后回滚"></a>发布完成后回滚</h3><p>全部升级成功后，发现功能异常，回滚到之前版本。<br>回滚前状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                        1/1       Running            0          36m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                       1/1       Running            0          36m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                       1/1       Running            0          2m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>回滚后状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                      1/1       Running            0          6m       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-jqbjk                        1/1       Running            0          6m        172.20.235.215   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                      1/1       Running            0          6m       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="滚动升级状态"><a href="#滚动升级状态" class="headerlink" title="滚动升级状态"></a>滚动升级状态</h2><p>目标实例数3个，旧实例数3个，总实例数3个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                       1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                        1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                       1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，旧实例数3个，新实例数1个，总实例数4个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                        1/1       Running            0          1m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                        1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，旧实例数2个，新实例数2个，总实例数4个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-pmw2f                       1/1       Running            0          15s       172.20.190.51    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-vzc9g                        1/1       Running            0          3m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，旧实例数1个，新实例数3个，总实例数4个<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                        1/1       Running            0          35m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                       1/1       Running            0          35m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                       1/1       Running            0          1m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                       1/1       Running            0          13h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，新实例数3个，总实例数3个<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                        1/1       Running            0          36m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                       1/1       Running            0          36m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                       1/1       Running            0          2m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-修改Kubernetes集群Pod容器的内核参数" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/修改Kubernetes集群Pod容器的内核参数/">修改Kubernetes集群Pod容器的内核参数</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/修改Kubernetes集群Pod容器的内核参数/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>容器的本质是一个进程，共享Node的内核。原以为修改了Node的内核参数容器中也会改，但实际上并不是这样，容器的内核参数可以和Node不同。</p>
<h2 id="Docker-Daemon"><a href="#Docker-Daemon" class="headerlink" title="Docker Daemon"></a>Docker Daemon</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --sysctl net.core.somaxconn=65535 busybox cat /proc/sys/net/core/somaxconn</span><br></pre></td></tr></table></figure>
<p>多个参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --restart=always --net=host \</span><br><span class="line">--name=centos01 --hostname=centos01 \</span><br><span class="line">--sysctl kernel.msgmnb=13107200 \</span><br><span class="line">--sysctl kernel.msgmni=256 \</span><br><span class="line">--sysctl kernel.msgmax=65536 \</span><br><span class="line">--sysctl kernel.shmmax=69719476736 \</span><br><span class="line">--sysctl kernel.sem=<span class="string">'500 256000 250 1024'</span> \</span><br><span class="line">-v /mnt:/update \</span><br><span class="line">centos /bin/bash</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">docker <span class="built_in">exec</span> centos01 sysctl -a |grep -E \</span><br><span class="line"><span class="string">'kernel.msgmnb|kernel.msgmni|kernel.msgmax|kernel.shmmax|kernel.sem'</span></span><br></pre></td></tr></table></figure>
<h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><h3 id="Kubernetes-Sysctls"><a href="#Kubernetes-Sysctls" class="headerlink" title="Kubernetes Sysctls"></a>Kubernetes Sysctls</h3><ol>
<li><p>增加Kubelet启动参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubelet --allowed-unsafe-sysctls=net.*</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新加载配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启kubelet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Pod的securityContext参数（注意是pod不是container）</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">securityContext:</span><br><span class="line">  sysctls:</span><br><span class="line">  - name: net.ipv4.tcp_keepalive_time</span><br><span class="line">    value: &quot;180&quot;</span><br></pre></td></tr></table></figure>
<p>Kubernetes允许配置的内核参数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kernel.shm*,</span><br><span class="line">kernel.msg*,</span><br><span class="line">kernel.sem,</span><br><span class="line">fs.mqueue.*,</span><br><span class="line">net.*.</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>使用Kubernetes Sysctls推荐指定几台Node，利用污点或者节点亲和性把需要修改内核参数的pod调度到指定节点，而不是修改所有Node。</p>
</blockquote>
<h3 id="Kubernetes-Init-Container"><a href="#Kubernetes-Init-Container" class="headerlink" title="Kubernetes Init Container"></a>Kubernetes Init Container</h3><p>使用init container不需要修改kubelet参数<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">initContainers:</span></span><br><span class="line"><span class="attr">- command:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">sysctl</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">-w</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">net.ipv4.tcp_keepalive_time=180</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">busybox:1.27</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">init-sysctl</span></span><br><span class="line"><span class="attr">  securityContext:</span></span><br><span class="line"><span class="attr">    privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.cnblogs.com/DaweiJ/articles/8528687.html" target="_blank" rel="noopener">https://www.cnblogs.com/DaweiJ/articles/8528687.html</a></li>
<li><a href="https://yq.aliyun.com/articles/603745?utm_content=m_1000003707" target="_blank" rel="noopener">https://yq.aliyun.com/articles/603745?utm_content=m_1000003707</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/</a></li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-常用的IntelliJ IDEA 插件推荐" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/常用的IntelliJ IDEA 插件推荐/">常用的IntelliJ IDEA 插件推荐</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/常用的IntelliJ IDEA 插件推荐/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、Free-Mybatis-plugin"><a href="#一、Free-Mybatis-plugin" class="headerlink" title="一、Free Mybatis plugin"></a>一、Free Mybatis plugin</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/8321-free-mybatis-plugin/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/8321-free-mybatis-plugin/</a></p>
</blockquote>
<p>1.把mybatis的xml文件和代码关联上，可以在mapper接口直接跳转到对应的SQL语句。</p>
<p><img src="http://image.sunshanpeng.com/201908181216_569.png" alt="mybatis"></p>
<p>2.如果没有对应的SQL语句，可以快捷补全（当然具体SQL语句还是要自己写）。</p>
<p><img src="http://image.sunshanpeng.com/201908181217_431.png" alt="sql"></p>
<h3 id="二、Maven-Helper"><a href="#二、Maven-Helper" class="headerlink" title="二、Maven Helper"></a>二、Maven Helper</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/7179-maven-helper/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/7179-maven-helper/</a></p>
</blockquote>
<p>简单、方便的查看maven依赖和冲突</p>
<p><img src="http://image.sunshanpeng.com/201908181217_88.png" alt="maven helper"></p>
<p><img src="http://image.sunshanpeng.com/201908181218_140.png" alt="maven helper"></p>
<h3 id="三、GenerateAllSetter"><a href="#三、GenerateAllSetter" class="headerlink" title="三、GenerateAllSetter"></a>三、GenerateAllSetter</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/9360-generateallsetter/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/9360-generateallsetter/</a></p>
</blockquote>
<p>一键调用一个对象的所有的set方法</p>
<p><img src="http://image.sunshanpeng.com/201908181219_563.png" alt="generateAllSetter"></p>
<h3 id="四、RestfulToolkit"><a href="#四、RestfulToolkit" class="headerlink" title="四、RestfulToolkit"></a>四、RestfulToolkit</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/10292-restfultoolkit/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/10292-restfultoolkit/</a></p>
</blockquote>
<p>通过URL查询对应的方法，可以根据请求方法过滤，另外支持简单的HTTP调用。</p>
<p><img src="http://image.sunshanpeng.com/201908181219_755.png" alt="restfulToolkit"></p>
<p><img src="http://image.sunshanpeng.com/201908181220_291.png" alt></p>
<h3 id="五、Key-Promoter-X"><a href="#五、Key-Promoter-X" class="headerlink" title="五、Key Promoter X"></a>五、Key Promoter X</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/9792-key-promoter-x/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/9792-key-promoter-x/</a></p>
</blockquote>
<p>帮助我们快速的掌握 <strong>IntelliJ IDEA</strong>的快捷键。</p>
<p><img src="http://image.sunshanpeng.com/201908181221_36.gif" alt></p>
<h3 id="六、GsonFormat"><a href="#六、GsonFormat" class="headerlink" title="六、GsonFormat"></a>六、GsonFormat</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/7654-gsonformat/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/7654-gsonformat/</a></p>
</blockquote>
<p>快速方便的把json字符串转换为实体类（快捷键ALT+S）。</p>
<p><img src="http://image.sunshanpeng.com/201908181221_537.png" alt></p>
<h3 id="七、String-Manipulation"><a href="#七、String-Manipulation" class="headerlink" title="七、String Manipulation"></a>七、String Manipulation</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/2162-string-manipulation/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/2162-string-manipulation/</a></p>
</blockquote>
<p>快捷方便的把字符串在驼峰、大小写等格式之间转换（快捷键Alt+M)。</p>
<p><img src="http://image.sunshanpeng.com/201908181222_332.png" alt></p>
<p><img src="https://plugins.jetbrains.com/files/2162/screenshot_16015.png" alt="Screenshot 2"></p>
<h3 id="八、Alibaba-Java-Coding-Guidelines"><a href="#八、Alibaba-Java-Coding-Guidelines" class="headerlink" title="八、Alibaba Java Coding Guidelines"></a>八、Alibaba Java Coding Guidelines</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/10046-alibaba-java-coding-guidelines/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/10046-alibaba-java-coding-guidelines/</a></p>
</blockquote>
<p>扫描代码是否符合规范</p>
<p><img src="http://image.sunshanpeng.com/201908181222_445.png" alt></p>
<h3 id="九、Lombok"><a href="#九、Lombok" class="headerlink" title="九、Lombok"></a>九、Lombok</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/6317-lombok/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/6317-lombok/</a></p>
</blockquote>
<p>简化java bean的代码量，自动生成get set toString EqualsAndHashCode 构造器。</p>
<blockquote>
<p>需要引入依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;dependency&gt;  </span><br><span class="line">&gt;           &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;  </span><br><span class="line">&gt;           &lt;artifactId&gt;lombok&lt;/artifactId&gt;   </span><br><span class="line">&gt; &lt;/dependency&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="十、-ignore"><a href="#十、-ignore" class="headerlink" title="十、.ignore"></a>十、.ignore</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/7495--ignore/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/7495--ignore/</a></p>
</blockquote>
<p>使用协作或者打包工具时，方便的处理要忽略的文件和文件夹。</p>
<p><img src="https://plugins.jetbrains.com/files/7495/screenshot_14958.png" alt="Screenshot 1"></p>
<h3 id="十一、Vue-js"><a href="#十一、Vue-js" class="headerlink" title="十一、Vue.js"></a>十一、Vue.js</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/9442-vue-js/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/9442-vue-js/</a></p>
</blockquote>
<p>用IDEA开发Vue的插件。</p>
<h3 id="十二、element"><a href="#十二、element" class="headerlink" title="十二、element"></a>十二、element</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/10524-element/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/10524-element/</a></p>
</blockquote>
<p>饿了么开源前端框架element的插件。</p>
<p><img src="https://plugins.jetbrains.com/files/10524/screenshot_17918.png" alt="element"></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/idea/">idea</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Docker的本质" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/Docker的本质/">Docker的本质</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/Docker的本质/" class="article-date">
	  <time datetime="2019-02-24T14:26:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Docker容器其实是一种沙盒技术，能够像一个集装箱一样，把应用“装”起来。</p>
<p>这样应用与应用之间，就因为有了边界而<strong>不会相互干扰</strong>；</p>
<p>被装进集装箱的应用，也<strong>可以被方便地搬来搬去</strong>。</p>
<p><strong>容器的本质，是由Namespace、Cgroups和rootfs三种技术构建出来的进程的隔离环境。</strong></p>
<p>Docke容器技术的核心功能，是通过约束和修改进程的动态表现，从而为其创造出一个“边界”。</p>
<p>Namespace技术是用来修改进程视图的主要方法，Cgroups技术是用来制造约束的主要手段，rootfs技术是用来限制进程文件系统的主要方式。</p>
<h2 id="Namespace："><a href="#Namespace：" class="headerlink" title="Namespace："></a>Namespace：</h2><p>正常情况下，每当我们在宿主机上运行一个程序的时候，操作系统都会给它分配一个进程编号，比如PID=100。这是进程的唯一标识，就像员工的工号一样。</p>
<p>而通过Docker把程序运行在容器中的时候，利用Namespace技术给进程施一个“障眼法”，让它看不到其他的进程，误以为只有它一个进程。</p>
<p>这种机制对被隔离的应用的进程空间做了限制，使其只能看到重新计算过的进程编号，比如PID=1，但事实上它在宿主机的操作系统里，还是原来的100号进程。</p>
<p>除了PID Namespace，Linux系统还提供了Mount、UTS、IPC、Network和User这些Namespace，用来对各种不同的进程上下文进行“障眼法”操作。</p>
<p>比如用Mount Namespace让被隔离的进程只能看到当前Namespace里的挂载点信息；Network Namespace让被隔离的进程只能看到当前Namespace的网络设备和配置。</p>
<p>所以，实际上Docker容器只是指定了这个进程所需要启用的一组Namespace参数，从而让进程只能看到当前Namespace所限定的资源、文件、设备、状态和配置等，对宿主机和其他不相关的程序完全看不到。</p>
<p>所以也可以说，容器其实就是一种特殊的进程而已。</p>
<h3 id="虚拟机和Docker容器比较"><a href="#虚拟机和Docker容器比较" class="headerlink" title="虚拟机和Docker容器比较"></a>虚拟机和Docker容器比较</h3><p> <img src="http://image.sunshanpeng.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20181013171129.jpg" alt="img"></p>
<p>在理解Docker的时候，通常会用这张图来比较虚拟机和Docker。</p>
<p>左边画出了虚拟机的工作原理：其中Hypervisor是虚拟机最主要的部分，它通过硬件虚拟化功能，模拟出运行一个操作系统需要的各种硬件，比如CPU、内存、I/O设备等等。然后它在这些虚拟的硬件上安装了一个新的操作系统，即Guest OS。</p>
<p>这样，用户的应用进程就可以运行在这个虚拟机的机器中，它能够看到的自然也只有Guest OS的文件和目录，以及这个机器里的虚拟设备。</p>
<p>右边用一个名为Docker Engine的软件替换了Hypervisor，把虚拟机的概念套在了容器上，实际上这个说法是不严谨的，跟真正存在的虚拟机不同，实际上并没有Docker Engine这一层。</p>
<p>Docker帮助用户启动的还是原来的应用进程，只不过在创建这些进程时给它们加上了各种各样的Namespace参数。</p>
<p>这样，这些进程就会觉得自己是各自PID Namespace里的第1号进程，只能看到各自Mount Namespace里挂载的目录和文件，只能访问各自Network Namespace里的网络设备，就好像运行在一个个独立的容器里。</p>
<p><img src="http://image.sunshanpeng.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20181013173339.jpg" alt="img"></p>
<p>Docker的架构其实这样画更合适</p>
<p>如果用虚拟化技术作为应用沙盒，就必须要由Hypervisor来负责创建虚拟机，这个虚拟机是真实存在的，并且它里面必须运行一个完整的Guest OS才能执行用户的应用进程。这就不可避免的带来的额外的资源消耗和占用。</p>
<p>根据实验，一个运行着CentOS的KVM虚拟机启动后，在不做优化的情况下，虚拟机自己就需要占用100~·200内存。此外，用户应用运行在虚拟机里面，对宿主机操作系统的调用就不可避免地进过虚拟化软件的拦截和处理，这本身又是一层性能损失。</p>
<p>使用Docker容器化后的用户应用，依然还是一个宿主机上的普通进程，这就意味着因为虚拟化而带来的性能损耗都是不存在的；</p>
<p>另一方面，使用Namespace作为隔离手段的容器并不需要单独的Guest OS，这使得容器额外的资源占用几乎可以忽略不计。</p>
<p>所以“敏捷”和“高性能”是容器相较于虚拟化最大的优势。</p>
<p>当然有利就有弊，Docker容器相较于虚拟化最大的弊端就是隔离的不彻底。</p>
<p>因为容器只是运行在宿主机上的一种特殊的进程，所以多个容器之间使用的还是同一个宿主机的操作系统内核。</p>
<p>另外，很多资源和对象不能被Namespace化，比如：时间。</p>
<h2 id="Cgroups："><a href="#Cgroups：" class="headerlink" title="Cgroups："></a>Cgroups：</h2><p>虽然容器内的进程在Namespace的作用下只能看到容器里的情况，但是在宿主机上，它作为第100号进程，与其它所有的进程之间依然是平等的竞争关系。</p>
<p>这就意味着，虽然这个进程表面上被隔离起来了，但它所能够使用到的资源（CPU、内存），却是可以随时被宿主机的其他进程（或者其他容器）占用。</p>
<p>当然这个进程也可能把所有的资源吃光，而Linux Cgroups就是Linux内核中用来为进程设置资源限制的一个重要功能。</p>
<p>跟Namespace的情况类似，Cgroups对资源的限制能力也有很多不完善的地方，比如/proc文件系统的问题。</p>
<p>/proc目录存储的是记录当前内核运行状态的一系列特殊文件，用户可以通过访问这些文件，查看系统以及当前正在运行的进程的信息，比如CPU使用情况，内存占用率等。</p>
<p>当我们在容器内执行top命令的时候，会发现它显示的信息是宿主机的CPU和内存，而不是当前容器的数据。</p>
<h2 id="rootfs："><a href="#rootfs：" class="headerlink" title="rootfs："></a>rootfs：</h2><p>在Linux操作系统里，有一个名为chroot的命令，作用是帮助我们“change root file”，即改变进程的根目录到指定的位置。</p>
<p>而对于被chroot的进程来说，它并不知道自己的根目录已经被修改了。Mount Namespace就是基于chroot的不断改良被发明出来的。</p>
<p>为了让容器的根目录更加真实，一般会在这个容器的根目录下挂载一个完整操作系统的文件系统，比如Ubuntu 16.04的ISO。</p>
<p>这样，在容器启动之后，我们在容器里通过执行“ls /”查看根目录下的内容，就是Ubuntu 16.04的所有目录和文件。</p>
<p>这个挂载在容器根目录上，用来为容器进程提供隔离后执行环境的文件系统，就是容器镜像，专业名字rootfs(根文件系统)。</p>
<p>一个常见的rootfs，或者说容器镜像，会包含比如bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  test  tmp  usr  var等的目录和文件。</p>
<p>进入容器后执行的/bin/bash，就是/bin目录下的可执行文件，与宿主机的/bin/bash完全不同。</p>
<p>rootfs只是一个操作系统所包含的文件、配置和目录，并不包括操作系统内核。</p>
<p>所以说rootfs只包括了操作系统的“躯壳”，并没有包括操作系统的“灵魂”，同一台机器上的所有容器，都是共享宿主机操作系统的内核。</p>
<p>这意味着，容器进程需要配置内核参数、加载额外的内核模块，以及跟内核进行直接交互的时候，需要注意这些操作和依赖的对象，都是宿主机操作系统的内核，对该机器上的所有容器生效。</p>
<p>不过也真是由于rootfs，容器才有了一个被反复宣传至今的重要特性：一致性。</p>
<p>由于rootfs里打包的不只是应用，而是整个操作系统的文件和目录，也就意味着，应用以及它运行所需要的所有依赖，都被封装在了一起。</p>
<p>有了容器镜像“打包操作系统”的能力，这个最基础的依赖环境也变成了应用沙盒的一部分，这就赋予了容器的所谓一致性。</p>
<p>无论在本地、云端，还是在任何机器上，用户只需要解压打包好的容器镜像，那么这个应用运行所需要的完整的执行环境就被重现出来了。</p>
<p>这种深入到操作系统级别的运行环境一致性，打通了应用在本地开发和远端执行环境之间难以逾越的鸿沟。</p>
<p>另外，Docker在镜像的设计中，引入了层（layer）的概念，也就是说，用户制作镜像的每一步操作，都会生成一个层，也就是一个增量的rootfs。</p>
<p>这个设计用到了一种叫做联合文件系统（Union File System）的能力，也叫UnionFS,最主要的功能是将多个不同位置的目录联合挂载到同一个目录下。</p>
<p><img src="http://image.sunshanpeng.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20181014213926.jpg" alt="img"></p>
<p>如图所示，容器中的rootfs分为只读层、Init层、可读写层。</p>
<p>只读层：包含了操作系统的一部分。</p>
<p>Init层：夹在只读层和可读写层中间，是Docker项目单独生成的一个内部层，用来存在/etc/hosts、/etc/resolv.conf等信息。</p>
<p>可读写层：用来存放修改rootfs后产生的增量，无论增、删、改，都发生在这里。</p>
<p>使用docker commit和push指令保存并上传被修改过的容器的时候，只读层和Init层不会有任何变化，变化的只是可读写层。</p>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>实际操作中，我们不会使用docker commit命令来把一个运行中的docker容器提交成为一个docker镜像。</p>
<p>使用 <code>docker commit</code> 意味着所有对镜像的操作都是黑箱操作，生成的镜像也被称为黑箱镜像，换句话说，就是除了制作镜像的人知道执行过什么命令、怎么生成的镜像，别人根本无从得知。</p>
<p>另外结合之前的分层，任何修改的结果仅仅是在当前层进行标记、添加、修改，而不会改动上一层。</p>
<p>这样每一次修改都会让镜像更加臃肿一次，所删除的上一层的东西并不会丢失，会一直如影随形的跟着这个镜像，即使根本无法访问到。</p>
<p>把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决，这个脚本就是 Dockerfile。</p>
<p>Dockerfile 是一个文本文件，其内包含了一条条的指令(Instruction)，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建。</p>
<p>每一个 <code>RUN</code> 的行为，就和手动docker commit建立镜像的过程一样：新建立一层，在其上执行这些命令，执行结束后，<code>commit</code> 这一层的修改，构成新的镜像。</p>
<p><em>Union FS 是有最大层数限制的，比如 AUFS，曾经是最大不得超过 42 层，现在是不得超过 127 层。</em></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Kubectl常用命令" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/Kubectl常用命令/">Kubectl常用命令</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/Kubectl常用命令/" class="article-date">
	  <time datetime="2019-02-24T14:26:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h2><h3 id="前台运行的容器"><a href="#前台运行的容器" class="headerlink" title="前台运行的容器"></a>前台运行的容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -it --rm --image=centos --restart=Never <span class="built_in">test</span> bash</span><br></pre></td></tr></table></figure>
<h3 id="常驻后台的容器"><a href="#常驻后台的容器" class="headerlink" title="常驻后台的容器"></a>常驻后台的容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run nginx --image=nginx --replicas=2</span><br></pre></td></tr></table></figure>
<p>通常使用yaml文件创建容器，只在调试或者排错的时候使用<code>kubectl run</code>临时创建容器。</p>
<p>比如：</p>
<h3 id="创建网络排查容器"><a href="#创建网络排查容器" class="headerlink" title="创建网络排查容器"></a>创建网络排查容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -it --rm --restart=Never --image=infoblox/dnstools:latest dnstools</span><br></pre></td></tr></table></figure>
<p>如果创建了一个MySQL容器并且暴露了service，但是不能使用service访问mysql，这个时候可以使用<code>nslookup</code>或者<code>dig</code>这些网络命令排查。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dnstools<span class="comment"># nslookup mysql</span></span><br><span class="line">Server:         172.21.0.2</span><br><span class="line">Address:        172.21.0.2<span class="comment">#53</span></span><br><span class="line"></span><br><span class="line">Name:   mysql.qa.svc.cluster.local</span><br><span class="line">Address: 172.21.147.86</span><br></pre></td></tr></table></figure>
<h3 id="创建MySQL排查容器"><a href="#创建MySQL排查容器" class="headerlink" title="创建MySQL排查容器"></a>创建MySQL排查容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run -it --rm --image=mysql:5.6 --restart=Never mysql-client -- mysql -h mysql --port 3306 -u root -p123456</span><br></pre></td></tr></table></figure>
<p>如果创建的MySQL容器在集群外连接不上了，可以创建一个mysql容器在内部连接看看能不能连上。</p>
<ul>
<li><code>-h</code>参数是MySQL的host；</li>
<li><code>--port</code>参数是MySQL的端口号；</li>
<li><code>-u</code>参数是MySQL的用户名；</li>
<li><code>-p</code>参数是用户名对应的密码，<code>-p</code>和密码之间没有空格。</li>
</ul>
<h2 id="应用资源"><a href="#应用资源" class="headerlink" title="应用资源"></a>应用资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deployment.yaml</span><br></pre></td></tr></table></figure>
<p>推荐使用这种方式创建或者更新资源。</p>
<h2 id="获取容器"><a href="#获取容器" class="headerlink" title="获取容器"></a>获取容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces -o wide</span><br></pre></td></tr></table></figure>
<p>获取所有namespace的容器。</p>
<ul>
<li><code>--all-namespaces</code>表示所有namespace，默认获取<code>default namespace</code>的资源，可以通过<code>-n</code>指定namespace。</li>
<li><code>-o wide</code>表示输出格式，其他还要<code>json</code>，<code>yaml</code>。</li>
</ul>
<h3 id="获取所有不是Running状态的容器"><a href="#获取所有不是Running状态的容器" class="headerlink" title="获取所有不是Running状态的容器"></a>获取所有不是Running状态的容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces -o wide | awk <span class="string">'&#123;if ($4 != "Running") print $0&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="获取其他资源"><a href="#获取其他资源" class="headerlink" title="获取其他资源"></a>获取其他资源</h3><p>除了容器，还有很多其他资源例如<code>node</code>、<code>service</code>、<code>deployment</code>、<code>statefulset</code>、<code>daemonset</code>、<code>job</code>、<code>pvc</code>、<code>pv</code>等等可以通过kubectl来获取，大多数是区分namespace的，也有不区分namespace的比如<code>node</code>、<code>pv</code>、<code>storageclass</code>等。</p>
<h2 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod nginx-deployment-599c95f496-hd2jc</span><br></pre></td></tr></table></figure>
<h3 id="强制删除："><a href="#强制删除：" class="headerlink" title="强制删除："></a>强制删除：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod nginx-deployment-599c95f496-hd2jc --force --grace-period=0</span><br></pre></td></tr></table></figure>
<h3 id="批量强制删除："><a href="#批量强制删除：" class="headerlink" title="批量强制删除："></a>批量强制删除：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods | grep Terminating | awk <span class="string">'&#123;print $1&#125;'</span> | xargs kubectl delete pod --force --grace-period=0</span><br></pre></td></tr></table></figure>
<h3 id="批量强制删除非运行容器"><a href="#批量强制删除非运行容器" class="headerlink" title="批量强制删除非运行容器"></a>批量强制删除非运行容器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pods --all-namespaces | awk <span class="string">'&#123;if ($4 != "Running") system ("kubectl -n " $1 " delete pods " $2 " --grace-period=0 " " --force ")&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="扩缩容"><a href="#扩缩容" class="headerlink" title="扩缩容"></a>扩缩容</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment nginx --replicas 4</span><br></pre></td></tr></table></figure>
<p>最小可以缩容到0个。</p>
<h2 id="暂停滚动升级"><a href="#暂停滚动升级" class="headerlink" title="暂停滚动升级"></a>暂停滚动升级</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout pause deployment nginx</span><br></pre></td></tr></table></figure>
<p>滚动升级时，可以使用该命令暂停升级来实现金丝雀发布。</p>
<h2 id="恢复滚动升级"><a href="#恢复滚动升级" class="headerlink" title="恢复滚动升级"></a>恢复滚动升级</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout resume deployment nginx</span><br></pre></td></tr></table></figure>
<p>暂停后恢复。</p>
<h2 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout undo deployment nginx</span><br></pre></td></tr></table></figure>
<p>回滚到上一次发布。</p>
<h2 id="给node加taint（污点）"><a href="#给node加taint（污点）" class="headerlink" title="给node加taint（污点）"></a>给node加taint（污点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes node1 key=value:NoSchedule</span><br></pre></td></tr></table></figure>
<p>给节点添加污点后只有容忍了该污点的容器才能调度上来。</p>
<h2 id="查看node信息"><a href="#查看node信息" class="headerlink" title="查看node信息"></a>查看node信息</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe nodes node1</span><br></pre></td></tr></table></figure>
<p>通过该命令可以查看node的资源、内核、容器、标签和污点等等。</p>
<h2 id="给node加标签"><a href="#给node加标签" class="headerlink" title="给node加标签"></a>给node加标签</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node node1 kubernetes.io/role=node --overwrite</span><br></pre></td></tr></table></figure>
<p>给node加标签后可以用节点亲和性指定某些pod调度到固定node。</p>
<h2 id="删除node上的标签"><a href="#删除node上的标签" class="headerlink" title="删除node上的标签"></a>删除node上的标签</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node node1 kubernetes.io/role-</span><br></pre></td></tr></table></figure>
<h2 id="根据标签筛选"><a href="#根据标签筛选" class="headerlink" title="根据标签筛选"></a>根据标签筛选</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -l node-type=iot</span><br></pre></td></tr></table></figure>
<h2 id="禁止节点调度"><a href="#禁止节点调度" class="headerlink" title="禁止节点调度"></a>禁止节点调度</h2><h3 id="只禁止不驱逐"><a href="#只禁止不驱逐" class="headerlink" title="只禁止不驱逐"></a>只禁止不驱逐</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl cordon node1</span><br></pre></td></tr></table></figure>
<p>这种方式只把node标记为<code>SchedulingDisabled</code>,已经在node上运行的pod不会受影响，之后不会再有新的pod调度上去。</p>
<h3 id="禁止并驱逐"><a href="#禁止并驱逐" class="headerlink" title="禁止并驱逐"></a>禁止并驱逐</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl drain node1 --ignore-daemonsets --delete-local-data --force</span><br></pre></td></tr></table></figure>
<p>这种方式除了把node标记为<code>SchedulingDisabled</code>，已经运行的pod也会被驱逐，保证节点除<code>daemonset</code>外没有其他pod。</p>
<h2 id="恢复调度"><a href="#恢复调度" class="headerlink" title="恢复调度"></a>恢复调度</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl uncordon node1</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-CentOS升级内核kernel的几种方式" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/01/17/CentOS升级内核kernel的几种方式/">CentOS升级内核kernel的几种方式</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/01/17/CentOS升级内核kernel的几种方式/" class="article-date">
	  <time datetime="2019-01-17T12:18:01.000Z" itemprop="datePublished">一月 17, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/linux/">linux</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="小版本升级"><a href="#小版本升级" class="headerlink" title="小版本升级"></a>小版本升级</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line">yum install kernel* -y</span><br><span class="line"><span class="comment"># reboot</span></span><br><span class="line">init 6</span><br></pre></td></tr></table></figure>
<h2 id="安装最新稳定版内核"><a href="#安装最新稳定版内核" class="headerlink" title="安装最新稳定版内核"></a>安装最新稳定版内核</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import key</span></span><br><span class="line">rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span><br><span class="line"><span class="comment"># install elrepo repo</span></span><br><span class="line">rpm -Uvh http://www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span><br><span class="line"><span class="comment"># list kernel</span></span><br><span class="line">yum --disablerepo=\* --enablerepo=elrepo-kernel list kernel*</span><br><span class="line"><span class="comment"># install kernel</span></span><br><span class="line">yum --enablerepo=elrepo-kernel install kernel-ml-devel kernel-ml -y</span><br><span class="line"><span class="comment"># yum --disablerepo=\* --enablerepo=elrepo-kernel install -y kernel-ml.x86_64</span></span><br><span class="line"><span class="comment"># modify grub</span></span><br><span class="line">grub2-set-default 0</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line"><span class="comment"># reboot</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h2 id="安装指定版本内核"><a href="#安装指定版本内核" class="headerlink" title="安装指定版本内核"></a>安装指定版本内核</h2><p>推荐一个可以找到各个版本内核的国内镜像站：<a href="http://mirror.rc.usf.edu/compute_lock/elrepo/kernel/el7/x86_64/RPMS" target="_blank" rel="noopener">http://mirror.rc.usf.edu/compute_lock/elrepo/kernel/el7/x86_64/RPMS</a></p>
<p>本次安装以4.19版本的内核示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install</span></span><br><span class="line">rpm -ivh http://mirror.rc.usf.edu/compute_lock/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</span><br><span class="line"><span class="comment"># modify grub</span></span><br><span class="line">sed -i <span class="string">"s/GRUB_DEFAULT=saved/GRUB_DEFAULT=0/"</span> /etc/default/grub</span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class="line"><span class="comment"># reboot</span></span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h2 id="编译源码安装"><a href="#编译源码安装" class="headerlink" title="编译源码安装"></a>编译源码安装</h2><p>没试过</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://mritd.me/2016/11/08/update-centos-kernel/" target="_blank" rel="noopener">https://mritd.me/2016/11/08/update-centos-kernel/</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/linux/">linux</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/kernel/">kernel</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-创建NFS的StorageClass" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/12/17/创建NFS的StorageClass/">创建NFS的StorageClass</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/12/17/创建NFS的StorageClass/" class="article-date">
	  <time datetime="2018-12-17T08:26:37.000Z" itemprop="datePublished">十二月 17, 2018</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Kubernetes的几种网络存储中，NFS是成本较低、使用简单的一种方案。</p>
<p>但是NFS存储不建议用在生产环境，因为我们测试环境的MySQL数据库部署在NFS上都经常出问题，比如<code>nfs4_reclaim_open_state: Lock reclaim failed</code>和<code>kernel:NMI watchdog: BUG: soft lockup - CPU#0 stuck for 26s</code>。</p>
<h2 id="NFS服务端"><a href="#NFS服务端" class="headerlink" title="NFS服务端"></a>NFS服务端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">yum install -y net-tools lsof nfs-utils rpcbind</span><br><span class="line">mkdir /data/nfs -p</span><br><span class="line">vi /etc/exports</span><br><span class="line"><span class="comment">#挂载NFS服务器上的/data/nfs/目录到自己的文件系统中，rw表示可读写，no_root_squash 是让root保持权限</span></span><br><span class="line">/data/nfs/ *(insecure,rw,no_root_squash)</span><br><span class="line"></span><br><span class="line">关闭防火墙</span><br><span class="line">systemctl stop firewalld</span><br><span class="line">先为rpcbind和nfs做开机启动：(必须先启动rpcbind服务)</span><br><span class="line">systemctl <span class="built_in">enable</span> rpcbind.service</span><br><span class="line">systemctl <span class="built_in">enable</span> nfs-server.service</span><br><span class="line">然后分别启动rpcbind和nfs服务：</span><br><span class="line">systemctl start rpcbind.service</span><br><span class="line">systemctl start nfs-server.service</span><br><span class="line"> </span><br><span class="line">exportfs -r</span><br><span class="line"><span class="comment">#可以查看到已经ok</span></span><br><span class="line">exportfs</span><br><span class="line">/home/nfs 192.168.248.0/24</span><br></pre></td></tr></table></figure>
<h2 id="NFS客户端"><a href="#NFS客户端" class="headerlink" title="NFS客户端"></a>NFS客户端</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装nfs工具</span></span><br><span class="line">yum  install -y nfs-utils</span><br><span class="line"><span class="comment">#建立挂载目录</span></span><br><span class="line">mkdir /data</span><br><span class="line"><span class="comment">#挂载nfs</span></span><br><span class="line">mount -t nfs 192.168.80.145:/data/nfs /data</span><br><span class="line">卸载挂载</span><br><span class="line">umount /data</span><br><span class="line"> </span><br><span class="line">查看是目录挂载状态</span><br><span class="line">df -h</span><br><span class="line">showmount  -e 192.168.80.145</span><br></pre></td></tr></table></figure>
<h2 id="创建NFS-StorageClass"><a href="#创建NFS-StorageClass" class="headerlink" title="创建NFS-StorageClass"></a>创建NFS-StorageClass</h2><h3 id="nfs-rbac-yaml"><a href="#nfs-rbac-yaml" class="headerlink" title="nfs-rbac.yaml"></a>nfs-rbac.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["events"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["create",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="attr">  - apiGroups:</span> <span class="string">[""]</span></span><br><span class="line"><span class="attr">    resources:</span> <span class="string">["endpoints"]</span></span><br><span class="line"><span class="attr">    verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="attr">  - kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line"><span class="attr">  kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">  apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
<h3 id="nfs-deployment-yaml"><a href="#nfs-deployment-yaml" class="headerlink" title="nfs-deployment.yaml"></a>nfs-deployment.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  replicas:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  strategy:</span></span><br><span class="line"><span class="attr">    type:</span> <span class="string">Recreate</span></span><br><span class="line"><span class="attr">  template:</span></span><br><span class="line"><span class="attr">    metadata:</span></span><br><span class="line"><span class="attr">      labels:</span></span><br><span class="line"><span class="attr">        app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">    spec:</span></span><br><span class="line"><span class="attr">      tolerations:</span></span><br><span class="line"><span class="attr">        - key:</span> <span class="string">node-env</span></span><br><span class="line"><span class="attr">          value:</span> <span class="string">pre</span></span><br><span class="line"><span class="attr">          effect:</span> <span class="string">NoSchedule</span></span><br><span class="line"><span class="attr">          operator:</span> <span class="string">Equal</span></span><br><span class="line"><span class="attr">      priorityClassName:</span> <span class="string">cluster</span></span><br><span class="line"><span class="attr">      serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">      containers:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">          image:</span> <span class="string">quay.io/external_storage/nfs-client-provisioner:latest</span></span><br><span class="line"><span class="attr">          volumeMounts:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">              mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line"><span class="attr">          env:</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line"><span class="attr">              value:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line"><span class="attr">              value:</span> <span class="comment">##NFS_SERVER_IP##</span></span><br><span class="line"><span class="attr">            - name:</span> <span class="string">NFS_PATH</span></span><br><span class="line"><span class="attr">              value:</span> <span class="comment">##NFS_PATH##</span></span><br><span class="line"><span class="attr">      volumes:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-client-root</span></span><br><span class="line"><span class="attr">          nfs:</span></span><br><span class="line"><span class="attr">            server:</span> <span class="comment">##NFS_SERVER_IP##</span></span><br><span class="line"><span class="attr">            path:</span> <span class="comment">##NFS_PATH##</span></span><br></pre></td></tr></table></figure>
<h3 id="nfs-storage-yaml"><a href="#nfs-storage-yaml" class="headerlink" title="nfs-storage.yaml"></a>nfs-storage.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">nfs-provisioner</span> <span class="comment"># or choose another name, must match deployment's env PROVISIONER_NAME'</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line"><span class="attr">  archiveOnDelete:</span> <span class="string">"false"</span></span><br></pre></td></tr></table></figure>
<h3 id="test-nfs-storage-yaml"><a href="#test-nfs-storage-yaml" class="headerlink" title="test-nfs-storage.yaml"></a>test-nfs-storage.yaml</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-claim</span></span><br><span class="line"><span class="attr">  annotations:</span></span><br><span class="line">    <span class="string">volume.beta.kubernetes.io/storage-class:</span> <span class="string">"nfs-storage"</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  accessModes:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">ReadWriteMany</span></span><br><span class="line"><span class="attr">  resources:</span></span><br><span class="line"><span class="attr">    requests:</span></span><br><span class="line"><span class="attr">      storage:</span> <span class="number">1</span><span class="string">Mi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test-pod</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">      command:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"/bin/sh"</span></span><br><span class="line"><span class="attr">      args:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"-c"</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">"touch /mnt/SUCCESS &amp;&amp; exit 0 || exit 1"</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">        - name:</span> <span class="string">nfs-pvc</span></span><br><span class="line"><span class="attr">          mountPath:</span> <span class="string">"/mnt"</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">"Never"</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">nfs-pvc</span></span><br><span class="line"><span class="attr">      persistentVolumeClaim:</span></span><br><span class="line"><span class="attr">        claimName:</span> <span class="string">test-claim</span></span><br></pre></td></tr></table></figure>
<h3 id="创建顺序"><a href="#创建顺序" class="headerlink" title="创建顺序"></a>创建顺序</h3><ol>
<li>nfs-rbac.yaml</li>
<li>nfs-deployment.yaml</li>
<li>nfs-storage.yaml</li>
</ol>
<h3 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h3><h4 id="nfs-deployment-yaml-1"><a href="#nfs-deployment-yaml-1" class="headerlink" title="nfs-deployment.yaml"></a>nfs-deployment.yaml</h4><ul>
<li><code>##NFS_SERVER_IP##</code>是NFS服务端的IP，根据实际IP进行替换。</li>
<li><code>##NFS_PATH##</code>是NFS服务端的目录，根据实际目录进行替换。</li>
</ul>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NFS_SERVER_IP=192.168.80.145  <span class="comment">#换成自己的实际IP</span></span><br><span class="line">NFS_PATH=/data/nfs  <span class="comment"># 换成自己的实际目录</span></span><br><span class="line">kubectl apply -f nfs-rbac.yaml</span><br><span class="line">sed <span class="string">"s|##NFS_SERVER_IP##|<span class="variable">$&#123;NFS_SERVER_IP&#125;</span>|g;s|##NFS_PATH##|<span class="variable">$&#123;NFS_PATH&#125;</span>|g"</span> nfs-deployment.yaml | kubectl apply -f -</span><br><span class="line">kubectl apply -f nfs-storage.yaml</span><br></pre></td></tr></table></figure>
<h3 id="验证方法"><a href="#验证方法" class="headerlink" title="验证方法"></a>验证方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f <span class="built_in">test</span>-nfs-storage.yaml</span><br></pre></td></tr></table></figure>
<h3 id="可选：设置默认存储"><a href="#可选：设置默认存储" class="headerlink" title="可选：设置默认存储"></a>可选：设置默认存储</h3><p>设置这个StorageClass为Kubernetes的默认存储<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> kubectl patch storageclass nfs-storage -p <span class="string">'&#123;"metadata": &#123;"annotations":&#123;"storageclass.kubernetes.io/is-default-class":"true"&#125;&#125;&#125;'</span></span><br><span class="line"> [root@master1 nfs-storage]<span class="comment"># kubectl get sc</span></span><br><span class="line">NAME                    PROVISIONER                    AGE</span><br><span class="line">nfs-storage (default)   nfs-provisioner                12m</span><br></pre></td></tr></table></figure></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/lixiuran/p/7117000.html" target="_blank" rel="noopener">https://www.cnblogs.com/lixiuran/p/7117000.html</a></p>
<p><a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client" target="_blank" rel="noopener">https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-下载谷歌镜像的几种姿势" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/11/28/下载谷歌镜像的几种姿势/">下载谷歌镜像的几种姿势</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/11/28/下载谷歌镜像的几种姿势/" class="article-date">
	  <time datetime="2018-11-28T08:26:37.000Z" itemprop="datePublished">十一月 28, 2018</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在国内，因为墙的存在所以很多国外网站不能访问，这其中就有谷歌镜像网站<code>gcr.io</code>，不过我们可以通过其他方式使用谷歌的镜像。</p>
<h2 id="通过国内镜像站"><a href="#通过国内镜像站" class="headerlink" title="通过国内镜像站"></a>通过国内镜像站</h2><h3 id="阿里云镜像站"><a href="#阿里云镜像站" class="headerlink" title="阿里云镜像站"></a>阿里云镜像站</h3><p>域名：<code>registry.cn-hangzhou.aliyuncs.com/google_containers</code></p>
<h3 id="微软镜像站"><a href="#微软镜像站" class="headerlink" title="微软镜像站"></a>微软镜像站</h3><p>域名：<code>gcr.azk8s.cn/google_containers</code></p>
<h3 id="中科大镜像站（拉取速度较慢）"><a href="#中科大镜像站（拉取速度较慢）" class="headerlink" title="中科大镜像站（拉取速度较慢）"></a>中科大镜像站（拉取速度较慢）</h3><p>域名：<code>gcr.mirrors.ustc.edu.cn/google_containers</code></p>
<h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><p>替换谷歌镜像地址为国内镜像站地址，比如：</p>
<p><code>k8s.gcr.io</code>开头的<code>k8s.gcr.io/coredns:1.1.3</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.1.3</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:1.1.3 k8s.gcr.io/coredns:1.1.3</span><br></pre></td></tr></table></figure>
<p><code>gcr.io</code>开头的<code>gcr.io/google_containers/heapster-amd64:v1.5.3</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-amd64:v1.5.3</span><br><span class="line">docker tag registry.cn-hangzhou.aliyuncs.com/google_containers/heapster-amd64:v1.5.3 gcr.io/google_containers/heapster-amd64:v1.5.3</span><br></pre></td></tr></table></figure>
<h2 id="通过配置代理"><a href="#通过配置代理" class="headerlink" title="通过配置代理"></a>通过配置代理</h2><p>前提是有一台能够科学上网的机器，并且目标机器能访问到可以科学上网的机器。</p>
<ol>
<li>为docker服务创建systemd插件目录：</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/systemd/system/docker.service.d</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>配置代理文件</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;/etc/systemd/system/docker.service.d/http-proxy.conf&lt;EOF </span><br><span class="line">[Service] </span><br><span class="line">Environment=<span class="string">"HTTP_PROXY=http://proxy.example.com:80/"</span></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>刷新配置并重启Docker</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>验证配置是否加载</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl show --property=Environment docker</span><br><span class="line">Environment=HTTP_PROXY=http://proxy.example.com:80/</span><br></pre></td></tr></table></figure>
<p>如果配置已经加载但还是不能下载谷歌镜像，可以试试把<code>HTTP_PROXY</code>改成<code>http_proxy</code>，我的配置是<code>Environment=&quot;http_proxy=http://10.208.204.147:1080/&quot;</code>才能使用。</p>
<p><code>HTTPS_PROXY</code>和<code>NO_PROXY</code>配置类似，具体可以看官网<a href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy" target="_blank" rel="noopener">代理配置</a>。</p>
<h2 id="通过脚本"><a href="#通过脚本" class="headerlink" title="通过脚本"></a>通过脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://git.io/getgcr | bash -s  k8s.gcr.io/kube-apiserver:v1.14.3</span><br></pre></td></tr></table></figure>
<p>把<code>k8s.gcr.io/kube-apiserver:v1.14.3</code>替换成要下载的目标镜像即可。</p>
<p>该方法本质上还是通过国内镜像站下载的。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://mirror.azure.cn/help/gcr-proxy-cache.html" target="_blank" rel="noopener">http://mirror.azure.cn/help/gcr-proxy-cache.html</a></p>
<p><a href="https://blog.docker.com/2015/10/registry-proxy-cache-docker-open-source/" target="_blank" rel="noopener">https://blog.docker.com/2015/10/registry-proxy-cache-docker-open-source/</a></p>
<p><a href="https://stackoverflow.com/questions/23111631/cannot-download-docker-images-behind-a-proxy" target="_blank" rel="noopener">https://stackoverflow.com/questions/23111631/cannot-download-docker-images-behind-a-proxy</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-使用ephemeral-storage管理容器的临时存储" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2018/11/28/使用ephemeral-storage管理容器的临时存储/">使用ephemeral-storage管理容器的临时存储</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2018/11/28/使用ephemeral-storage管理容器的临时存储/" class="article-date">
	  <time datetime="2018-11-28T08:26:37.000Z" itemprop="datePublished">十一月 28, 2018</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="ephemeral-storage介绍"><a href="#ephemeral-storage介绍" class="headerlink" title="ephemeral-storage介绍"></a>ephemeral-storage介绍</h2><p>Kubernetes在1.8的版本中引入了一种类似于CPU，内存的新的资源模式：<code>ephemeral-storage</code>，并且在1.10的版本在kubelet中默认打开了这个特性。</p>
<ul>
<li>Alpha release target (x.y): 1.7/1.8</li>
<li>Beta release target (x.y): 1.10</li>
<li>Stable release target (x.y): 1.11</li>
</ul>
<p><code>ephemeral-storage</code>是为了管理和调度Kubernetes中运行的应用的短暂存储。</p>
<blockquote>
<p>在每个Kubernetes的节点上，kubelet的根目录(默认是/var/lib/kubelet)和日志目录(/var/log)保存在节点的主分区上，这个分区同时也会被Pod的EmptyDir类型的volume、容器日志、镜像的层、容器的可写层所占用。<code>ephemeral-storage</code>便是对这块主分区进行管理，通过应用定义的需求(requests)和约束(limits)来调度和管理节点上的应用对主分区的消耗。</p>
</blockquote>
<h2 id="ephemeral-storage的eviction逻辑"><a href="#ephemeral-storage的eviction逻辑" class="headerlink" title="ephemeral-storage的eviction逻辑"></a>ephemeral-storage的eviction逻辑</h2><p>在节点上的<code>kubelet</code>启动的时候，<code>kubelet</code>会统计当前节点的主分区的可分配的磁盘资源，或者你可以覆盖节点上<code>kubelet</code>的配置来自定义可分配的资源。在创建<code>Pod</code>时会根据存储需求调度到满足存储的节点，在<code>Pod</code>使用超过限制的存储时会对其做驱逐的处理来保证不会耗尽节点上的磁盘空间。</p>
<blockquote>
<p>如果运行时指定了别的独立的分区，比如修改了docker的镜像层和容器可写层的存储位置(默认是/var/lib/docker)所在的分区，将不再将其计入<code>ephemeral-storage</code>的消耗。</p>
</blockquote>
<ul>
<li>EmptyDir 的使用量超过了他的 SizeLimit，那么这个 pod 将会被驱逐</li>
<li>Container 的使用量（log，如果没有 overlay 分区，则包括 imagefs）超过了他的 limit，则这个 pod 会被驱逐</li>
<li>Pod 对本地临时存储总的使用量（所有 emptydir 和 container）超过了 pod 中所有container 的 limit 之和，则 pod 被驱逐</li>
</ul>
<h2 id="ephemeral-storage使用"><a href="#ephemeral-storage使用" class="headerlink" title="ephemeral-storage使用"></a>ephemeral-storage使用</h2><p>和内存和CPU的限制类似，存储的限制也是定义在Pod的container中</p>
<blockquote>
<p>spec.containers[].resources.limits.ephemeral-storage</p>
<p>spec.containers[].resources.requests.ephemeral-storage</p>
</blockquote>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">teststorage</span></span><br><span class="line"><span class="attr">  labels:</span></span><br><span class="line"><span class="attr">    app:</span> <span class="string">teststorage</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">teststorage</span></span><br><span class="line"><span class="attr">    image:</span> <span class="attr">nginx:1.14</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">["bash",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"while true; do dd if=/dev/zero of=$(date '+%s').out count=1 bs=10MB; sleep 1; done"</span><span class="string">]</span> <span class="comment"># 持续写入文件到容器的rootfs中</span></span><br><span class="line"><span class="attr">    resources:</span></span><br><span class="line"><span class="attr">      limits:</span></span><br><span class="line"><span class="attr">        ephemeral-storage:</span> <span class="number">100</span><span class="string">Mi</span> <span class="comment">#定义存储的限制为100M</span></span><br><span class="line"><span class="attr">      requests:</span></span><br><span class="line"><span class="attr">        ephemeral-storage:</span> <span class="number">100</span><span class="string">Mi</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl get pods -o wide</span></span><br><span class="line">NAME                                READY     STATUS    RESTARTS   AGE       IP               NODE            NOMINATED NODE</span><br><span class="line">teststorage                         1/1       Running   0          7s        172.20.189.69    10.208.204.35   &lt;none&gt;</span><br><span class="line">-------------------------------------------------------------------------------------------------</span><br><span class="line">teststorage                         0/1       Evicted   0          1m        &lt;none&gt;           10.208.204.35   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># kubectl describe pod teststorage </span></span><br><span class="line">Name:         teststorage</span><br><span class="line">Namespace:    default</span><br><span class="line">Node:         10.208.204.35/</span><br><span class="line">Start Time:   Wed, 28 Nov 2018 13:48:37 +0800</span><br><span class="line">Labels:       app=teststorage</span><br><span class="line">Annotations:  kubectl.kubernetes.io/last-applied-configuration=&#123;<span class="string">"apiVersion"</span>:<span class="string">"v1"</span>,<span class="string">"kind"</span>:<span class="string">"Pod"</span>,<span class="string">"metadata"</span>:&#123;<span class="string">"annotations"</span>:&#123;&#125;,<span class="string">"labels"</span>:&#123;<span class="string">"app"</span>:<span class="string">"teststorage"</span>&#125;,<span class="string">"name"</span>:<span class="string">"teststorage"</span>,<span class="string">"namespace"</span>:<span class="string">"default"</span>&#125;,<span class="string">"spec"</span>:&#123;<span class="string">"contai...</span></span><br><span class="line"><span class="string">Status:       Failed</span></span><br><span class="line"><span class="string">Reason:       Evicted</span></span><br><span class="line"><span class="string">Message:      Pod ephemeral local storage usage exceeds the total limit of containers 100Mi. </span></span><br><span class="line"><span class="string">IP:           </span></span><br><span class="line"><span class="string">Containers:</span></span><br><span class="line"><span class="string">  teststorage:</span></span><br><span class="line"><span class="string">    Image:      nginx:1.14</span></span><br><span class="line"><span class="string">    Port:       &lt;none&gt;</span></span><br><span class="line"><span class="string">    Host Port:  &lt;none&gt;</span></span><br><span class="line"><span class="string">    Command:</span></span><br><span class="line"><span class="string">      bash</span></span><br><span class="line"><span class="string">      -c</span></span><br><span class="line"><span class="string">      while true; do dd if=/dev/zero of=<span class="variable">$(date '+%s')</span>.out count=1 bs=10MB; sleep 1; done</span></span><br><span class="line"><span class="string">    Limits:</span></span><br><span class="line"><span class="string">      ephemeral-storage:  100Mi</span></span><br><span class="line"><span class="string">    Requests:</span></span><br><span class="line"><span class="string">      ephemeral-storage:  100Mi</span></span><br><span class="line"><span class="string">    Environment:          &lt;none&gt;</span></span><br><span class="line"><span class="string">    Mounts:</span></span><br><span class="line"><span class="string">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-mqzrh (ro)</span></span><br><span class="line"><span class="string">Volumes:</span></span><br><span class="line"><span class="string">  default-token-mqzrh:</span></span><br><span class="line"><span class="string">    Type:        Secret (a volume populated by a Secret)</span></span><br><span class="line"><span class="string">    SecretName:  default-token-mqzrh</span></span><br><span class="line"><span class="string">    Optional:    false</span></span><br><span class="line"><span class="string">QoS Class:       BestEffort</span></span><br><span class="line"><span class="string">Node-Selectors:  &lt;none&gt;</span></span><br><span class="line"><span class="string">Tolerations:     &lt;none&gt;</span></span><br><span class="line"><span class="string">Events:</span></span><br><span class="line"><span class="string">  Type     Reason     Age   From                    Message</span></span><br><span class="line"><span class="string">  ----     ------     ----  ----                    -------</span></span><br><span class="line"><span class="string">  Normal   Scheduled  1m    default-scheduler       Successfully assigned default/teststorage to 10.208.204.35</span></span><br><span class="line"><span class="string">  Normal   Pulled     1m    kubelet, 10.208.204.35  Container image "</span>nginx:1.14<span class="string">" already present on machine</span></span><br><span class="line"><span class="string">  Normal   Created    1m    kubelet, 10.208.204.35  Created container</span></span><br><span class="line"><span class="string">  Normal   Started    1m    kubelet, 10.208.204.35  Started container</span></span><br><span class="line"><span class="string">  Warning  Evicted    8s    kubelet, 10.208.204.35  Pod ephemeral local storage usage exceeds the total limit of containers 100Mi.</span></span><br><span class="line"><span class="string">  Normal   Killing    8s    kubelet, 10.208.204.35  Killing container with id docker://teststorage:Need to kill Pod</span></span><br></pre></td></tr></table></figure>
<h2 id="参考文档："><a href="#参考文档：" class="headerlink" title="参考文档："></a>参考文档：</h2><p><a href="https://v1-11.docs.kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/" target="_blank" rel="noopener">https://v1-11.docs.kubernetes.io/docs/tasks/configure-pod-container/assign-cpu-resource/</a></p>
<p><a href="https://github.com/kubernetes/enhancements/issues/361" target="_blank" rel="noopener">https://github.com/kubernetes/enhancements/issues/361</a></p>
<p><a href="https://yq.aliyun.com/articles/594066" target="_blank" rel="noopener">https://yq.aliyun.com/articles/594066</a></p>
<p><a href="http://www.k8smeetup.com/article/VyEncpgA7" target="_blank" rel="noopener">http://www.k8smeetup.com/article/VyEncpgA7</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Service的意义" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
    <div class="article-meta">
      
	<a href="/2018/10/21/Service的意义/" class="article-date">
	  <time datetime="2018-10-21T15:06:09.474Z" itemprop="datePublished">十月 21, 2018</time>
	</a>

       
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>在用 Kubernetes 之前，当我们有了容器网络之后，访问一个应用最直接的做法，就是客户端直接去访问一个 Backend Container。</p>
<p>这种做法最直观和容易，同时问题也是显而易见的。</p>
<p>当应用有多个后端容器的时候，怎么做负载均衡，会话保持怎么做，某个容器迁了之后 IP 跟着变怎么办，还有对应的健康检查怎么配，如果想用域名来做访问入口要怎么处理……</p>
<p>这些其实就是 Kubernetes 的 Service 引入所要解决的问题。</p>
<h2 id="Service的意义"><a href="#Service的意义" class="headerlink" title="Service的意义"></a>Service的意义</h2><p>Kubernetes <code>Pod</code> 是有生命周期的，它们可以被创建，也可以被销毁，然而一旦被销毁生命就永远结束。 通过 <code>ReplicationController</code>能够动态地创建和销毁 <code>Pod</code>。 每个 <code>Pod</code> 都会获取它自己的 IP 地址，即使这些 IP 地址不总是稳定可依赖的。 这会导致一个问题：在 Kubernetes 集群中，如果一组 <code>Pod</code>（称为 backend）为其它 <code>Pod</code> （称为 frontend）提供服务，那么那些 frontend 该如何发现，并连接到这组 <code>Pod</code>中的哪些 backend 呢？</p>
<p>Kubernetes <code>Service</code> 定义了这样一种抽象：一个 <code>Pod</code> 的逻辑分组，一种可以访问它们的策略 —— 通常称为微服务。 </p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
      
      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>

</section>
          <aside id="sidebar">
  
    <div style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 72%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 36px; width: 100%;" placeholder=" Search…" value name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="Search">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Connect With Us</h3>
    <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="https://github.com/sunshanpeng" title="Github"><i class="fa fa-github" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Weibo"><i class="fa fa-weibo" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Facebook"><i class="fa fa-facebook" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Google-plus"><i class="fa fa-google-plus" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Instagram"><i class="fa fa-instagram" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a></li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>
		</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>Recent Posts</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/09/17/在k8s中使用eureka的几种姿势/">在k8s中使用eureka的几种姿势</a></h6>
              <span>九月 17, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/09/17/Eureka服务注册发现/">Eureka服务注册发现</a></h6>
              <span>九月 17, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/08/30/配置Jenkins打包VUE项目/">(no title)</a></h6>
              <span>八月 30, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/08/24/Kubernetes高可用架构/">Kubernetes高可用部署</a></h6>
              <span>八月 24, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/03/24/Kubernetes集群配置优化/">Kubernetes集群配置优化</a></h6>
              <span>三月 24, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/03/24/Windows电脑本地开发时连接Apollo配置中心启动慢/">Windows电脑本地开发时连接Apollo配置中心启动慢</a></h6>
              <span>三月 24, 2019</span>
            </div>

          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器/">容器</a><span class="category-list-count">13</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/apollo/">apollo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eureka/">eureka</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/idea/">idea</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/">k8s</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/apollo/" style="font-size: 13.33px;">apollo</a> <a href="/tags/docker/" style="font-size: 16.67px;">docker</a> <a href="/tags/eureka/" style="font-size: 13.33px;">eureka</a> <a href="/tags/idea/" style="font-size: 10px;">idea</a> <a href="/tags/k8s/" style="font-size: 20px;">k8s</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>

    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 阿鹏的博客 All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
