<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Page 2 | 阿鹏的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="java go devops kubernetes docker">
<meta name="keywords" content="java go devops kubernetes docker">
<meta property="og:type" content="website">
<meta property="og:title" content="阿鹏的博客">
<meta property="og:url" content="http://sunshanpeng.com/page/2/index.html">
<meta property="og:site_name" content="阿鹏的博客">
<meta property="og:description" content="java go devops kubernetes docker">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="阿鹏的博客">
<meta name="twitter:description" content="java go devops kubernetes docker">
  
    <link rel="alternate" href="/atom.xml" title="阿鹏的博客" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body>


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg,https://source.unsplash.com/collection/954550/1920x1080,https://source.unsplash.com/collection/954550/1920x1081".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="阿鹏的博客" rel="home"> 阿鹏的博客 </a>
            
          </h1>
          
          
            <div class="site-description">java go devops kubernetes docker</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-使用Arthas thread命令查看线程堆栈等信息" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/28/使用Arthas thread命令查看线程堆栈等信息/">使用Arthas thread命令查看线程堆栈</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/28/使用Arthas thread命令查看线程堆栈等信息/" class="article-date">
	  <time datetime="2019-11-28T13:26:37.000Z" itemprop="datePublished">十一月 28, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Arthas-thread命令介绍"><a href="#Arthas-thread命令介绍" class="headerlink" title="Arthas thread命令介绍"></a>Arthas thread命令介绍</h2><blockquote>
<p> <a href="https://alibaba.github.io/arthas/thread.html" target="_blank" rel="noopener">https://alibaba.github.io/arthas/thread.html</a> </p>
</blockquote>
<p> 查看当前Java进程的线程信息和线程的堆栈信息。</p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">thread [id] [-n 5]</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<h3 id="显示所有线程的信息"><a href="#显示所有线程的信息" class="headerlink" title="显示所有线程的信息"></a>显示所有线程的信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ thread</span><br><span class="line">Threads Total: 16, NEW: 0, RUNNABLE: 7, BLOCKED: 0, WAITING: 5, TIMED_WAITING: 4, TERMINATED: 0</span><br><span class="line">ID         NAME                             GROUP                 PRIORITY   STATE      %CPU       TIME       INTERRUPTE DAEMON</span><br><span class="line">30         as-command-execute-daemon        system                9          RUNNABLE   72         0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">23         as-session-expire-daemon         system                9          TIMED_WAIT 27         0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">22         Attach Listener                  system                9          RUNNABLE   0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">11         pool-2-thread-1                  main                  5          TIMED_WAIT 0          0:0        <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">12         Thread-2                         main                  5          RUNNABLE   0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">13         pool-3-thread-1                  main                  5          TIMED_WAIT 0          0:0        <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">25         as-selector-daemon               system                9          RUNNABLE   0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">14         Thread-3                         main                  5          TIMED_WAIT 0          0:0        <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">26         pool-5-thread-1                  system                5          WAITING    0          0:0        <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">15         Thread-4                         main                  5          RUNNABLE   0          0:0        <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">1          main                             main                  5          WAITING    0          0:2        <span class="literal">false</span>      <span class="literal">false</span></span><br><span class="line">2          Reference Handler                system                10         WAITING    0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">3          Finalizer                        system                8          WAITING    0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">4          Signal Dispatcher                system                9          RUNNABLE   0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">20         NonBlockingInputStreamThread     main                  5          WAITING    0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br><span class="line">21         Thread-8                         main                  5          RUNNABLE   0          0:0        <span class="literal">false</span>      <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="显示指定线程的运行堆栈"><a href="#显示指定线程的运行堆栈" class="headerlink" title="显示指定线程的运行堆栈"></a>显示指定线程的运行堆栈</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ thread 1</span><br><span class="line"><span class="string">"main"</span> Id=1 WAITING on java.util.concurrent.CountDownLatch<span class="variable">$Sync</span>@29fafb28</span><br><span class="line">    at sun.misc.Unsafe.park(Native Method)</span><br><span class="line">    -  waiting on java.util.concurrent.CountDownLatch<span class="variable">$Sync</span>@29fafb28</span><br><span class="line">    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)</span><br><span class="line">    at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)</span><br><span class="line">    at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)</span><br><span class="line">    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)</span><br><span class="line">    at java.util.concurrent.CountDownLatch.await(CountDownLatch.java:231)</span><br></pre></td></tr></table></figure>
<h3 id="显示当前最忙的前N个线程并打印堆栈"><a href="#显示当前最忙的前N个线程并打印堆栈" class="headerlink" title="显示当前最忙的前N个线程并打印堆栈"></a>显示当前最忙的前N个线程并打印堆栈</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">thread -n 3</span><br><span class="line"><span class="string">"as-command-execute-daemon"</span> Id=29 cpuUsage=75% RUNNABLE</span><br><span class="line">    at sun.management.ThreadImpl.dumpThreads0(Native Method)</span><br><span class="line">    at sun.management.ThreadImpl.getThreadInfo(ThreadImpl.java:440)</span><br><span class="line">    at com.taobao.arthas.core.command.monitor200.ThreadCommand<span class="variable">$1</span>.action(ThreadCommand.java:58)</span><br><span class="line">    at com.taobao.arthas.core.command.handler.AbstractCommandHandler.execute(AbstractCommandHandler.java:238)</span><br><span class="line">    at com.taobao.arthas.core.command.handler.DefaultCommandHandler.handleCommand(DefaultCommandHandler.java:67)</span><br><span class="line">    at com.taobao.arthas.core.server.ArthasServer<span class="variable">$4</span>.run(ArthasServer.java:276)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)</span><br><span class="line">    at java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>.run(ThreadPoolExecutor.java:615)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"> </span><br><span class="line">    Number of locked synchronizers = 1</span><br><span class="line">    - java.util.concurrent.ThreadPoolExecutor<span class="variable">$Worker</span>@6cd0b6f8</span><br><span class="line"> </span><br><span class="line"><span class="string">"as-session-expire-daemon"</span> Id=25 cpuUsage=24% TIMED_WAITING</span><br><span class="line">    at java.lang.Thread.sleep(Native Method)</span><br><span class="line">    at com.taobao.arthas.core.server.DefaultSessionManager<span class="variable">$2</span>.run(DefaultSessionManager.java:85)</span><br><span class="line"> </span><br><span class="line"><span class="string">"Reference Handler"</span> Id=2 cpuUsage=0% WAITING on java.lang.ref.Reference<span class="variable">$Lock</span>@69ba0f27</span><br><span class="line">    at java.lang.Object.wait(Native Method)</span><br><span class="line">    -  waiting on java.lang.ref.Reference<span class="variable">$Lock</span>@69ba0f27</span><br><span class="line">    at java.lang.Object.wait(Object.java:503)</span><br><span class="line">    at java.lang.ref.Reference<span class="variable">$ReferenceHandler</span>.run(Reference.java:133)</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arthas/">arthas</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-使用Arthas tt命令记录调用信息" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/28/使用Arthas tt命令记录调用信息/">使用Arthas tt命令记录调用信息</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/28/使用Arthas tt命令记录调用信息/" class="article-date">
	  <time datetime="2019-11-28T13:26:37.000Z" itemprop="datePublished">十一月 28, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Arthas-tt命令介绍"><a href="#Arthas-tt命令介绍" class="headerlink" title="Arthas tt命令介绍"></a>Arthas tt命令介绍</h2><blockquote>
<p> <a href="https://alibaba.github.io/arthas/tt.html" target="_blank" rel="noopener">https://alibaba.github.io/arthas/tt.html</a> </p>
</blockquote>
<p><strong>方法执行数据的时空隧道，记录下指定方法每次调用的入参和返回信息，并能对这些不同的时间下调用进行观测</strong></p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tt -t class method</span><br></pre></td></tr></table></figure>
<h3 id="记录指定方法的每次调用环境现场"><a href="#记录指定方法的每次调用环境现场" class="headerlink" title="记录指定方法的每次调用环境现场"></a>记录指定方法的每次调用环境现场</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ tt -t demo.MathGame primeFactors</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 66 ms.</span><br><span class="line"> INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000    2018-12-04 11:15:38  1.096236  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1001    2018-12-04 11:15:39  0.191848  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1002    2018-12-04 11:15:40  0.069523  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1003    2018-12-04 11:15:41  0.186073  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1004    2018-12-04 11:15:42  17.76437  <span class="literal">true</span>    <span class="literal">false</span>    0x4b67cf4d     MathGame                       primeFactors</span><br></pre></td></tr></table></figure>
<h3 id="检索调用记录"><a href="#检索调用记录" class="headerlink" title="检索调用记录"></a>检索调用记录</h3><h4 id="列出所有调用记录"><a href="#列出所有调用记录" class="headerlink" title="列出所有调用记录"></a>列出所有调用记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tt -l</span><br><span class="line"> INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000    2018-12-04 11:15:38  1.096236  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1001    2018-12-04 11:15:39  0.191848  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1002    2018-12-04 11:15:40  0.069523  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1003    2018-12-04 11:15:41  0.186073  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1004    2018-12-04 11:15:42  17.76437  <span class="literal">true</span>    <span class="literal">false</span>    0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">                              9</span><br><span class="line"> 1005    2018-12-04 11:15:43  0.4776    <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">Affect(row-cnt:6) cost <span class="keyword">in</span> 4 ms.</span><br></pre></td></tr></table></figure>
<h4 id="筛选调用记录"><a href="#筛选调用记录" class="headerlink" title="筛选调用记录"></a>筛选调用记录</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ tt -s <span class="string">'method.name=="primeFactors"'</span></span><br><span class="line"> INDEX   TIMESTAMP            COST(ms)  IS-RET  IS-EXP   OBJECT         CLASS                          METHOD</span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> 1000    2018-12-04 11:15:38  1.096236  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1001    2018-12-04 11:15:39  0.191848  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1002    2018-12-04 11:15:40  0.069523  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1003    2018-12-04 11:15:41  0.186073  <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line"> 1004    2018-12-04 11:15:42  17.76437  <span class="literal">true</span>    <span class="literal">false</span>    0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">                              9</span><br><span class="line"> 1005    2018-12-04 11:15:43  0.4776    <span class="literal">false</span>   <span class="literal">true</span>     0x4b67cf4d     MathGame                       primeFactors</span><br><span class="line">Affect(row-cnt:6) cost <span class="keyword">in</span> 607 ms.</span><br></pre></td></tr></table></figure>
<h3 id="查看调用信息"><a href="#查看调用信息" class="headerlink" title="查看调用信息"></a>查看调用信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ tt -i 1003</span><br><span class="line"> INDEX            1003</span><br><span class="line"> GMT-CREATE       2018-12-04 11:15:41</span><br><span class="line"> COST(ms)         0.186073</span><br><span class="line"> OBJECT           0x4b67cf4d</span><br><span class="line"> CLASS            demo.MathGame</span><br><span class="line"> METHOD           primeFactors</span><br><span class="line"> IS-RETURN        <span class="literal">false</span></span><br><span class="line"> IS-EXCEPTION     <span class="literal">true</span></span><br><span class="line"> PARAMETERS[0]    @Integer[-564322413]</span><br><span class="line"> THROW-EXCEPTION  java.lang.IllegalArgumentException: number is: -564322413, need &gt;= 2</span><br><span class="line">                      at demo.MathGame.primeFactors(MathGame.java:46)</span><br><span class="line">                      at demo.MathGame.run(MathGame.java:24)</span><br><span class="line">                      at demo.MathGame.main(MathGame.java:16)</span><br><span class="line"> </span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 11 ms.</span><br></pre></td></tr></table></figure>
<h3 id="重新发起一次调用"><a href="#重新发起一次调用" class="headerlink" title="重新发起一次调用"></a>重新发起一次调用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">$ tt -i 1004 -p</span><br><span class="line"> RE-INDEX       1004</span><br><span class="line"> GMT-REPLAY     2018-12-04 11:26:00</span><br><span class="line"> OBJECT         0x4b67cf4d</span><br><span class="line"> CLASS          demo.MathGame</span><br><span class="line"> METHOD         primeFactors</span><br><span class="line"> PARAMETERS[0]  @Integer[946738738]</span><br><span class="line"> IS-RETURN      <span class="literal">true</span></span><br><span class="line"> IS-EXCEPTION   <span class="literal">false</span></span><br><span class="line"> COST(ms)         0.186073</span><br><span class="line"> RETURN-OBJ     @ArrayList[</span><br><span class="line">                    @Integer[2],</span><br><span class="line">                    @Integer[11],</span><br><span class="line">                    @Integer[17],</span><br><span class="line">                    @Integer[2531387],</span><br><span class="line">                ]</span><br><span class="line">Time fragment[1004] successfully replayed.</span><br><span class="line">Affect(row-cnt:1) cost <span class="keyword">in</span> 14 ms.</span><br></pre></td></tr></table></figure>
<p><strong>replay的注意事项</strong></p>
<ol>
<li><p><strong>ThreadLocal 信息丢失</strong></p>
<p>很多框架偷偷的将一些环境变量信息塞到了发起调用线程的 ThreadLocal 中，由于调用线程发生了变化，这些 ThreadLocal 线程信息无法通过 Arthas 保存，所以这些信息将会丢失。</p>
<p>一些常见的 CASE 比如：鹰眼的 TraceId 等。</p>
</li>
<li><p><strong>引用的对象</strong></p>
<p>需要强调的是，<code>tt</code> 命令是将当前环境的对象引用保存起来，但仅仅也只能保存一个引用而已。如果方法内部对入参进行了变更，或者返回的对象经过了后续的处理，那么在 <code>tt</code> 查看的时候将无法看到当时最准确的值。这也是为什么 <code>watch</code> 命令存在的意义。</p>
</li>
</ol>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arthas/">arthas</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-使用Arthas watch观察方法执行数据" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/28/使用Arthas watch观察方法执行数据/">使用Arthas watch观察方法执行</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/28/使用Arthas watch观察方法执行数据/" class="article-date">
	  <time datetime="2019-11-28T13:26:37.000Z" itemprop="datePublished">十一月 28, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Arthas-watch命令介绍"><a href="#Arthas-watch命令介绍" class="headerlink" title="Arthas watch命令介绍"></a>Arthas watch命令介绍</h2><blockquote>
<p><a href="https://alibaba.github.io/arthas/watch.html" target="_blank" rel="noopener">https://alibaba.github.io/arthas/watch.html</a></p>
</blockquote>
<p> <strong>方便的观察到指定方法的调用情况。</strong></p>
<p>能观察到的范围为：<code>入参</code>、<code>返回值</code>、<code>抛出异常</code>和<code>当前对象的属性</code>，通过编写 OGNL 表达式进行对应变量的查看。 </p>
<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>命令格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch class method <span class="string">"&#123;params,returnObj,throwExp&#125;"</span> -x 2</span><br></pre></td></tr></table></figure>
<h3 id="观察方法出参和返回值"><a href="#观察方法出参和返回值" class="headerlink" title="观察方法出参和返回值"></a>观察方法出参和返回值</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors <span class="string">"&#123;params,returnObj&#125;"</span> -x 2</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 44 ms.</span><br><span class="line">ts=2018-12-03 19:16:51; [cost=1.280502ms] result=@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[535629513],</span><br><span class="line">    ],</span><br><span class="line">    @ArrayList[</span><br><span class="line">        @Integer[3],</span><br><span class="line">        @Integer[19],</span><br><span class="line">        @Integer[191],</span><br><span class="line">        @Integer[49199],</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="调整-x的值，观察具体的方法参数值"><a href="#调整-x的值，观察具体的方法参数值" class="headerlink" title="调整-x的值，观察具体的方法参数值"></a>调整<code>-x</code>的值，观察具体的方法参数值</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors <span class="string">"&#123;params,target&#125;"</span> -x 3</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 58 ms.</span><br><span class="line">ts=2018-12-03 19:34:19; [cost=0.587833ms] result=@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[47816758],</span><br><span class="line">    ],</span><br><span class="line">    @MathGame[</span><br><span class="line">        random=@Random[</span><br><span class="line">            serialVersionUID=@Long[3905348978240129619],</span><br><span class="line">            seed=@AtomicLong[3133719055989],</span><br><span class="line">            multiplier=@Long[25214903917],</span><br><span class="line">            addend=@Long[11],</span><br><span class="line">            mask=@Long[281474976710655],</span><br><span class="line">            DOUBLE_UNIT=@Double[1.1102230246251565E-16],</span><br><span class="line">            BadBound=@String[bound must be positive],</span><br><span class="line">            BadRange=@String[bound must be greater than origin],</span><br><span class="line">            BadSize=@String[size must be non-negative],</span><br><span class="line">            seedUniquifier=@AtomicLong[-3282039941672302964],</span><br><span class="line">            nextNextGaussian=@Double[0.0],</span><br><span class="line">            haveNextNextGaussian=@Boolean[<span class="literal">false</span>],</span><br><span class="line">            serialPersistentFields=@ObjectStreamField[][isEmpty=<span class="literal">false</span>;size=3],</span><br><span class="line">            unsafe=@Unsafe[sun.misc.Unsafe@2eaa1027],</span><br><span class="line">            seedOffset=@Long[24],</span><br><span class="line">        ],</span><br><span class="line">        illegalArgumentCount=@Integer[13159],</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p> <code>-x</code>表示遍历深度，可以调整来打印具体的参数和结果内容，默认值是1。 </p>
<h3 id="条件表达式的例子"><a href="#条件表达式的例子" class="headerlink" title="条件表达式的例子"></a>条件表达式的例子</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors <span class="string">"&#123;params[0],target&#125;"</span> <span class="string">"params[0]&lt;0"</span></span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 68 ms.</span><br><span class="line">ts=2018-12-03 19:36:04; [cost=0.530255ms] result=@ArrayList[</span><br><span class="line">    @Integer[-18178089],</span><br><span class="line">    @MathGame[demo.MathGame@41cf53f9],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="按照耗时进行过滤"><a href="#按照耗时进行过滤" class="headerlink" title="按照耗时进行过滤"></a>按照耗时进行过滤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors <span class="string">'&#123;params, returnObj&#125;'</span> <span class="string">'#cost&gt;200'</span> -x 2</span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 66 ms.</span><br><span class="line">ts=2018-12-03 19:40:28; [cost=2112.168897ms] result=@ArrayList[</span><br><span class="line">    @Object[][</span><br><span class="line">        @Integer[2141897465],</span><br><span class="line">    ],</span><br><span class="line">    @ArrayList[</span><br><span class="line">        @Integer[5],</span><br><span class="line">        @Integer[428379493],</span><br><span class="line">    ],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p> <code>#cost&gt;200</code>(单位是<code>ms</code>)表示只有当耗时大于200ms时才会输出，过滤掉执行时间小于200ms的调用 </p>
<h3 id="观察当前对象中的属性"><a href="#观察当前对象中的属性" class="headerlink" title="观察当前对象中的属性"></a>观察当前对象中的属性</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ watch demo.MathGame primeFactors <span class="string">'target'</span></span><br><span class="line">Press Ctrl+C to abort.</span><br><span class="line">Affect(class-cnt:1 , method-cnt:1) cost <span class="keyword">in</span> 52 ms.</span><br><span class="line">ts=2018-12-03 19:41:52; [cost=0.477882ms] result=@MathGame[</span><br><span class="line">    random=@Random[java.util.Random@522b408a],</span><br><span class="line">    illegalArgumentCount=@Integer[13355],</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/arthas/">arthas</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Git开发规范" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/11/17/Git开发规范/">Git开发规范</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/11/17/Git开发规范/" class="article-date">
	  <time datetime="2019-11-17T12:46:37.000Z" itemprop="datePublished">十一月 17, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/开发规范/">开发规范</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="注释规范"><a href="#注释规范" class="headerlink" title="注释规范"></a>注释规范</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">feature：新增feature</span><br><span class="line">fix: 修复bug</span><br><span class="line">docs: 仅仅修改了文档，比如README, CHANGELOG, CONTRIBUTE等等</span><br><span class="line">sql: 新增、修改SQL文件</span><br><span class="line">style: 仅仅修改了空格、格式缩进、符号等等，不改变代码逻辑</span><br><span class="line">refactor: 代码重构，没有加新功能或者修复bug</span><br><span class="line">perf: 优化相关，比如提升性能、体验</span><br><span class="line">test: 测试用例，包括单元测试、集成测试等</span><br><span class="line">chore: 改变构建流程、或者增加依赖库、工具等</span><br><span class="line">revert: 回滚到上一个版本</span><br></pre></td></tr></table></figure>
<p>每个commit必须包含以上注释，方便review。</p>
<h2 id="分支规范"><a href="#分支规范" class="headerlink" title="分支规范"></a>分支规范</h2><ul>
<li>master分支：生产分支，用于存放发布到生产环境的代码。该分支只能从其他分支合并，不能直接修改推送。</li>
<li>feature/*分支：功能分支，用来开发新功能。开发完成后合入测试或者生产分支，被合并后删除。</li>
<li>hotfix/*分支：补丁分支，用来紧急修复生产环境的缺陷。开发完成后合入测试或者生产分支，被合并后删除。</li>
<li>环境分支：可选项，如果有要求可以加测试环境的分支，规范同生产分支。</li>
</ul>
<p>每次开发从master分支中检出，命名为feature/version_no，开发完成后通过pull request/merger request合入环境分支进行测试，最后合入master分支。上线部署后，在master分支增加版本号tag。</p>
<h2 id="Label规范"><a href="#Label规范" class="headerlink" title="Label规范"></a>Label规范</h2><ul>
<li>feature：新功能</li>
<li>enhancement：性能优化或者功能增强</li>
<li>bug：问题修复</li>
<li>backend：后端功能（如果前后端代码都有）</li>
<li>frontend：前端功能（如果前后端代码都有）</li>
<li>其他特性label</li>
</ul>
<p>Issues和Pull Request/Merge Request最好都加上Label，方便分类。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/开发规范/">开发规范</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/">git</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-ChaosBlade使用" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/09/27/ChaosBlade使用/">ChaosBlade使用</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/09/27/ChaosBlade使用/" class="article-date">
	  <time datetime="2019-09-27T13:17:37.000Z" itemprop="datePublished">九月 27, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/混沌工程/">混沌工程</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><h3 id="二进制"><a href="#二进制" class="headerlink" title="二进制"></a>二进制</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载</span></span><br><span class="line">wget https://github.com/chaosblade-io/chaosblade/releases/download/v0.3.0/chaosblade-0.3.0.linux-amd64.tar.gz</span><br><span class="line"><span class="comment">#解压</span></span><br><span class="line">tar -zxvf chaosblade-0.3.0.linux-amd64.tar.gz</span><br><span class="line"><span class="comment">#运行</span></span><br><span class="line"><span class="built_in">cd</span> chaosblade-0.3.0/</span><br><span class="line">./blade version</span><br></pre></td></tr></table></figure>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>命令介绍</p>
<p>最主要的命令是创建命令<code>create</code>和创建后的销毁命令<code>destroy</code>。</p>
<p>创建了以后一定要销毁！！！</p>
<p>创建了以后一定要销毁！！！</p>
<p>创建了以后一定要销毁！！！</p>
<p><code>prepare</code> 和 <code>revoke</code> 命令调用混沌实验准备执行器准备或者恢复实验环境。</p>
<p> 混沌实验和混沌实验环境准备记录都可以通过<code>status</code> 命令查询。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 ~]<span class="comment"># ./blade help</span></span><br><span class="line">An easy to use and powerful chaos engineering experiment toolkit</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  blade [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  create      Create a chaos engineering experiment</span><br><span class="line">  destroy     Destroy a chaos experiment</span><br><span class="line">  <span class="built_in">help</span>        Help about any <span class="built_in">command</span></span><br><span class="line">  prepare     Prepare to experiment</span><br><span class="line">  query       Query the parameter values required <span class="keyword">for</span> chaos experiments</span><br><span class="line">  revoke      Undo chaos engineering experiment preparation</span><br><span class="line">  server      Server mode starts, exposes web services</span><br><span class="line">  status      Query preparation stage or experiment status</span><br><span class="line">  version     Print version info</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -d, --debug   Set client to DEBUG mode</span><br><span class="line">  -h, --<span class="built_in">help</span>    <span class="built_in">help</span> <span class="keyword">for</span> blade</span><br><span class="line"></span><br><span class="line">Use <span class="string">"blade [command] --help"</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>
<p>创建命令</p>
<p>可以创建CPU、内存、磁盘、网络、进程、脚本、Docker、K8S的故障场景。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 ~]<span class="comment"># blade create help</span></span><br><span class="line">Create a chaos engineering experiment</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  blade create [<span class="built_in">command</span>]</span><br><span class="line"></span><br><span class="line">Aliases:</span><br><span class="line">  create, c</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">create dubbo delay --time 3000 --offset 100 --service com.example.Service --consumer</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  cplus       c++ experiment</span><br><span class="line">  cpu         Cpu experiment</span><br><span class="line">  disk        Disk experiment</span><br><span class="line">  docker      Execute a docker experiment</span><br><span class="line">  druid       Druid experiment</span><br><span class="line">  dubbo       dubbo experiment</span><br><span class="line">  http        http experiment</span><br><span class="line">  jedis       jedis experiment</span><br><span class="line">  jvm         method</span><br><span class="line">  k8s         Kubernetes experiment</span><br><span class="line">  mem         Mem experiment</span><br><span class="line">  mysql       mysql experiment</span><br><span class="line">  network     Network experiment</span><br><span class="line">  process     Process experiment</span><br><span class="line">  psql        Postgrelsql experiment</span><br><span class="line">  rocketmq    Rocketmq experiment,can make message send or pull delay and exception</span><br><span class="line">  script      Script chaos experiment</span><br><span class="line">  servlet     java servlet experiment</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --<span class="built_in">help</span>   <span class="built_in">help</span> <span class="keyword">for</span> create</span><br><span class="line"></span><br><span class="line">Global Flags:</span><br><span class="line">  -d, --debug   Set client to DEBUG mode</span><br><span class="line"></span><br><span class="line">Use <span class="string">"blade create [command] --help"</span> <span class="keyword">for</span> more information about a <span class="built_in">command</span>.</span><br></pre></td></tr></table></figure>
<h2 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h2><h3 id="CPU满负载"><a href="#CPU满负载" class="headerlink" title="CPU满负载"></a>CPU满负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create cpu fullload</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"4077e008d9a1b63b"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>返回参数中的<code>result</code>是<code>Uid</code>，后续<code>destroy</code>命令需要用到。</p>
<h3 id="指定CPU负载"><a href="#指定CPU负载" class="headerlink" title="指定CPU负载"></a>指定CPU负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create cpu fullload --cpu-percent 80</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"8b465a05ec5f3468"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>80%负载。</p>
<p>另外也可以使用<code>--cpu-count</code>指定满负载的CPU个数或者<code>--cpu-list</code>指定具体满负载的CPU。</p>
<h3 id="指定故障时间"><a href="#指定故障时间" class="headerlink" title="指定故障时间"></a>指定故障时间</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create cpu fullload --cpu-percent 80 --timeout 10</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"0136822f8f505c61"</span>&#125;</span><br></pre></td></tr></table></figure>
<p><code>--timeout</code>可以指定该故障的持续时间，单位是秒，指定持续时间后自动终止该故障。</p>
<p><strong>后续的其他故障也都可以指定故障时间。</strong></p>
<h3 id="查看CPU负载"><a href="#查看CPU负载" class="headerlink" title="查看CPU负载"></a>查看CPU负载</h3><ul>
<li><code>top</code></li>
<li><code>iostat -c 1 1000</code></li>
</ul>
<h2 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h2><h3 id="指定内存负载"><a href="#指定内存负载" class="headerlink" title="指定内存负载"></a>指定内存负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade c mem load --mem-percent 90</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"55d737f88301d0a5"</span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="查看内存负载"><a href="#查看内存负载" class="headerlink" title="查看内存负载"></a>查看内存负载</h3><ul>
<li><code>top</code></li>
<li><code>free -lh</code></li>
</ul>
<h2 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h2><h3 id="磁盘容量不足"><a href="#磁盘容量不足" class="headerlink" title="磁盘容量不足"></a>磁盘容量不足</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create disk fill --path /home --size 60000</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"5e16812a5393e610"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>在指定目录<code>--path</code>填充指定大小<code>--size</code>的数据，单位是M。</p>
<h3 id="查看磁盘容量"><a href="#查看磁盘容量" class="headerlink" title="查看磁盘容量"></a>查看磁盘容量</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># df -h /home</span></span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root   58G  5.4G   53G  10% /</span><br><span class="line"></span><br><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># df -h /home</span></span><br><span class="line">Filesystem               Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/mapper/centos-root   58G   53G  5.1G  92% /</span><br></pre></td></tr></table></figure>
<h3 id="磁盘读-IO高负载"><a href="#磁盘读-IO高负载" class="headerlink" title="磁盘读 IO高负载"></a>磁盘读 IO高负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./blade create disk burn --<span class="built_in">read</span> --path /home</span><br></pre></td></tr></table></figure>
<h3 id="磁盘写IO高负载"><a href="#磁盘写IO高负载" class="headerlink" title="磁盘写IO高负载"></a>磁盘写IO高负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./blade create disk burn --write --path /home</span><br></pre></td></tr></table></figure>
<h3 id="查看IO负载"><a href="#查看IO负载" class="headerlink" title="查看IO负载"></a>查看IO负载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iostat -x -t 2</span><br></pre></td></tr></table></figure>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><h3 id="网络延时"><a href="#网络延时" class="headerlink" title="网络延时"></a>网络延时</h3><h4 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--destination-ip string   目标 IP. 支持通过子网掩码来指定一个网段的IP地址, 例如 192.168.1.0/24. 则 192.168.1.0~192.168.1.255 都生效。你也可以指定固定的 IP，如 192.168.1.1 或者 192.168.1.1/32。</span><br><span class="line">--exclude-port string     排除掉的端口，可以指定多个，使用逗号分隔或者连接符表示范围，例如 22,8000 或者 8000-8010。 这个参数不能与 --local-port 或者 --remote-port 参数一起使用</span><br><span class="line">--interface string        网卡设备，例如 eth0 (必要参数)</span><br><span class="line">--local-port string       本地端口，一般是本机暴露服务的端口。可以指定多个，使用逗号分隔或者连接符表示范围，例如 80,8000-8080</span><br><span class="line">--offset string           延迟时间上下浮动的值, 单位是毫秒</span><br><span class="line">--remote-port string      远程端口，一般是要访问的外部暴露服务的端口。可以指定多个，使用逗号分隔或者连接符表示范围，例如 80,8000-8080</span><br><span class="line">--time string             延迟时间，单位是毫秒 (必要参数)</span><br><span class="line">--timeout string          设定运行时长，单位是秒，通用参数</span><br></pre></td></tr></table></figure>
<h4 id="指定本地端口延时"><a href="#指定本地端口延时" class="headerlink" title="指定本地端口延时"></a>指定本地端口延时</h4><p>所有其他服务器访问本地端口延时。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create network delay --time 3000 --offset 1000 --interface eno16780032 --local-port 9100</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"88626fd1175317ff"</span>&#125;</span><br></pre></td></tr></table></figure>
<p> 在另一台机器验证：<code>telnet xxx.xxx.xxx.xxx 9100</code></p>
<h4 id="到远程IP端口延时"><a href="#到远程IP端口延时" class="headerlink" title="到远程IP端口延时"></a>到远程IP端口延时</h4><p>当前机器访问远程IP端口延时，其他机器不受影响。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create network delay --time 3000 --interface eno16780032 --remote-port 8080 --destination-ip 10.22.19.8</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"fb75e208d0793104"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>演练机器验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># curl -o /dev/null -w %&#123;time_namelookup&#125;::%&#123;time_connect&#125;::%&#123;time_starttransfer&#125;::%&#123;time_total&#125;::%&#123;speed_download&#125;"\n" "http://10.22.19.8:8080/"</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11266    0 11266    0     0   1251      0 --:--:--  0:00:09 --:--:--  2819</span><br><span class="line">0.000::3.005::6.009::9.002::1251.000</span><br></pre></td></tr></table></figure>
<p>同时间正常机器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># curl -o /dev/null -w %&#123;time_namelookup&#125;::%&#123;time_connect&#125;::%&#123;time_starttransfer&#125;::%&#123;time_total&#125;::%&#123;speed_download&#125;"\n" "http://10.22.19.8:8080/"</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11266    0 11266    0     0  4998k      0 --:--:-- --:--:-- --:--:-- 5500k</span><br><span class="line">0.000::0.001::0.002::0.002::5118582.000</span><br></pre></td></tr></table></figure>
<h4 id="让一个容器服务超时"><a href="#让一个容器服务超时" class="headerlink" title="让一个容器服务超时"></a>让一个容器服务超时</h4><p>首先找到该服务的宿主机，再找到容器对应的网卡，然后在服务宿主机上设置该网卡超时。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./blade create network delay --time 3000 --interface cali4c37fec8d88 --timeout 30</span><br></pre></td></tr></table></figure>
<h3 id="网络丢包"><a href="#网络丢包" class="headerlink" title="网络丢包"></a>网络丢包</h3><h4 id="参数-1"><a href="#参数-1" class="headerlink" title="参数"></a>参数</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--destination-ip string   目标 IP. 支持通过子网掩码来指定一个网段的IP地址, 例如 192.168.1.0/24. 则 192.168.1.0~192.168.1.255 都生效。你也可以指定固定的 IP，如 192.168.1.1 或者 192.168.1.1/32。</span><br><span class="line">--exclude-port string     排除掉的端口，可以指定多个，使用逗号分隔或者连接符表示范围，例如 22,8000 或者 8000-8010。 这个参数不能与 --<span class="built_in">local</span>-port 或者 --remote-port 参数一起使用</span><br><span class="line">--interface string        网卡设备，例如 eth0 (必要参数)</span><br><span class="line">--<span class="built_in">local</span>-port string       本地端口，一般是本机暴露服务的端口。可以指定多个，使用逗号分隔或者连接符表示范围，例如 80,8000-8080</span><br><span class="line">--percent string          丢包百分比，取值在[0, 100]的正整数 (必要参数)</span><br><span class="line">--remote-port string      远程端口，一般是要访问的外部暴露服务的端口。可以指定多个，使用逗号分隔或者连接符表示范围，例如 80,8000-8080</span><br><span class="line">--timeout string          设定运行时长，单位是秒，通用参数</span><br></pre></td></tr></table></figure>
<h4 id="指定本地端口丢包"><a href="#指定本地端口丢包" class="headerlink" title="指定本地端口丢包"></a>指定本地端口丢包</h4><p>所有其他服务器访问本地端口延时。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create network loss --percent 70 --interface eno16780032 --local-port 9100</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"88626fd1175317ff"</span>&#125;</span><br></pre></td></tr></table></figure>
<p> 在另一台机器验证： <code>curl  xxx.xxx.xxx.xxx:8080</code>，不使用 telnet 的原因是 telnet 内部有重试机制，影响实验验证。如果将 percent 的值设置为 100，可以使用 telnet 验证 </p>
<h4 id="到远程IP端口丢包"><a href="#到远程IP端口丢包" class="headerlink" title="到远程IP端口丢包"></a>到远程IP端口丢包</h4><p>当前机器访问远程IP端口延时，其他机器不受影响。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create network loss --percent 70 --interface eno16780032 --remote-port 8080 --destination-ip 10.22.19.8</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"fb75e208d0793104"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>演练机器验证：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># curl -o /dev/null -w %&#123;time_namelookup&#125;::%&#123;time_connect&#125;::%&#123;time_starttransfer&#125;::%&#123;time_total&#125;::%&#123;speed_download&#125;"\n" "http://10.22.19.8:8080/"</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11266    0 11266    0     0   1502      0 --:--:--  0:00:07 --:--:--  3223</span><br><span class="line">0.000::7.082::7.499::7.499::1502.000</span><br></pre></td></tr></table></figure>
<p>同时间正常机器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ~]<span class="comment"># curl -o /dev/null -w %&#123;time_namelookup&#125;::%&#123;time_connect&#125;::%&#123;time_starttransfer&#125;::%&#123;time_total&#125;::%&#123;speed_download&#125;"\n" "http://10.22.19.8:8080/"</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">100 11266    0 11266    0     0  5254k      0 --:--:-- --:--:-- --:--:-- 10.7M</span><br><span class="line">0.000::0.000::0.002::0.002::5380133.000</span><br></pre></td></tr></table></figure>
<h4 id="让一个容器服务丢包"><a href="#让一个容器服务丢包" class="headerlink" title="让一个容器服务丢包"></a>让一个容器服务丢包</h4><p>首先找到该服务的宿主机，再找到容器对应的网卡，然后在服务宿主机上设置该网卡丢包。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./blade create network loss --percent 70 --interface cali4c37fec8d88 --timeout 30</span><br></pre></td></tr></table></figure>
<h3 id="网络隔离"><a href="#网络隔离" class="headerlink" title="网络隔离"></a>网络隔离</h3><p>丢包率100%即网络隔离。</p>
<h3 id="DNS解析"><a href="#DNS解析" class="headerlink" title="DNS解析"></a>DNS解析</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade create network dns --domain www.baidu.com --ip 10.0.0.0</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"5923c8feae34ec52"</span>&#125;</span><br><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ping www.baidu.com</span></span><br><span class="line">PING www.baidu.com (10.0.0.0) 56(84) bytes of data.</span><br><span class="line">^C</span><br><span class="line">--- www.baidu.com ping statistics ---</span><br><span class="line">24 packets transmitted, 0 received, 100% packet loss, time 23533ms</span><br></pre></td></tr></table></figure>
<h2 id="销毁实验"><a href="#销毁实验" class="headerlink" title="销毁实验"></a>销毁实验</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade destroy a6fa3362742e8c6f</span></span><br><span class="line">&#123;<span class="string">"code"</span>:200,<span class="string">"success"</span>:<span class="literal">true</span>,<span class="string">"result"</span>:<span class="string">"command: network loss --help false --interface eno16780032 --debug false --local-port 9100 --percent 70, destroy time: 2019-10-22T17:35:36.557547578+08:00"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>每个实验要么在创建的时候指定销毁时间<code>--timeout</code>，要么手动销毁，不然会一直执行。</p>
<h2 id="查看实验状态"><a href="#查看实验状态" class="headerlink" title="查看实验状态"></a>查看实验状态</h2><p>创建只会如果忘记了uid，可以通过status命令查询。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master4 chaosblade-0.3.0]<span class="comment"># ./blade status --type create</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"code"</span>: 200,</span><br><span class="line">        <span class="string">"success"</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">"result"</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"Uid"</span>: <span class="string">"4cdc5e72e623d449"</span>,</span><br><span class="line">                        <span class="string">"Command"</span>: <span class="string">"network"</span>,</span><br><span class="line">                        <span class="string">"SubCommand"</span>: <span class="string">"delay"</span>,</span><br><span class="line">                        <span class="string">"Flag"</span>: <span class="string">"--debug false --interface cali4c37fec8d88 --time 3000 --timeout 30 --help false"</span>,</span><br><span class="line">                        <span class="string">"Status"</span>: <span class="string">"Destroyed"</span>,</span><br><span class="line">                        <span class="string">"Error"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"CreateTime"</span>: <span class="string">"2019-10-22T16:35:53.572066698+08:00"</span>,</span><br><span class="line">                        <span class="string">"UpdateTime"</span>: <span class="string">"2019-10-22T16:36:23.898669337+08:00"</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"Uid"</span>: <span class="string">"01e7e9b19770834c"</span>,</span><br><span class="line">                        <span class="string">"Command"</span>: <span class="string">"network"</span>,</span><br><span class="line">                        <span class="string">"SubCommand"</span>: <span class="string">"delay"</span>,</span><br><span class="line">                        <span class="string">"Flag"</span>: <span class="string">"--timeout 60 --debug false --interface cali4c37fec8d88 --time 3000 --help false"</span>,</span><br><span class="line">                        <span class="string">"Status"</span>: <span class="string">"Destroyed"</span>,</span><br><span class="line">                        <span class="string">"Error"</span>: <span class="string">""</span>,</span><br><span class="line">                        <span class="string">"CreateTime"</span>: <span class="string">"2019-10-22T16:42:30.821076685+08:00"</span>,</span><br><span class="line">                        <span class="string">"UpdateTime"</span>: <span class="string">"2019-10-22T16:43:30.937855907+08:00"</span></span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/混沌工程/">混沌工程</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/chaosBlade/">chaosBlade</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-混沌工程" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/09/27/混沌工程/">混沌工程</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/09/27/混沌工程/" class="article-date">
	  <time datetime="2019-09-27T13:17:37.000Z" itemprop="datePublished">九月 27, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/混沌工程/">混沌工程</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="为什么需要混沌工程"><a href="#为什么需要混沌工程" class="headerlink" title="为什么需要混沌工程"></a>为什么需要混沌工程</h1><blockquote>
<p> <strong>减少故障的最好方法就是让故障经常性的发生。通过不断重复失败过程，持续提升系统的容错和弹性能力。</strong> </p>
</blockquote>
<p>在分布式架构环境下，服务间的依赖日益复杂，没有人能说清单个故障对整个系统的影响，构建一个高可用的分布式系统面临着很大挑战。</p>
<p>分布式系统天生包含大量的交互、依赖点，可以出错的地方数不胜数。硬盘故障、网络不通、流量激增压垮某些组件，这都是每天要面临的常事儿，处理不好就会导致业务停滞，性能低下，或者是其他各种无法预期的异常行为。 </p>
<p>在复杂的分布式系统中，人力并不能够阻止这些故障的发生，我们应该致力于在这些异常行为被触发之前，尽可能多地识别出会导致这些异常的，在系统中脆弱的、易出故障的环节。 在线上事故出现之前， 通过观察分布式系统在受控的故障注入测试中的行为变化，提前识别出系统中有哪些弱点以及这些弱点的影响范围。 当我们识别出这些风险，我们就可以有针对性地进行加固、防范， 提高系统可靠性，建立系统抵御失控条件的能力，从而避免故障发生时所带来的严重后果。 </p>
<p>相比等待故障发生然后被动式的故障响应流程，混沌工程可以在可控范围或环境下对系统注入各种故障，持续提升分布式系统的容错和弹性能力，从而构建高可用的分布式系统。 </p>
<h1 id="怎么样实践混沌工程"><a href="#怎么样实践混沌工程" class="headerlink" title="怎么样实践混沌工程"></a>怎么样实践混沌工程</h1><h2 id="实践原则"><a href="#实践原则" class="headerlink" title="实践原则"></a>实践原则</h2><h3 id="完善的监控系统"><a href="#完善的监控系统" class="headerlink" title="完善的监控系统"></a>完善的监控系统</h3><p>如果没有对系统的可见能力，就无法从实验中得出有效的结论。</p>
<p><code>if you can&#39;t measure it you can&#39;t improve it.</code></p>
<h3 id="尽可能的贴近生产"><a href="#尽可能的贴近生产" class="headerlink" title="尽可能的贴近生产"></a>尽可能的贴近生产</h3><p>（流量、数据量、配置、架构等）越贴近生产环境演练效果越好。</p>
<h3 id="演练事件真的可能发生"><a href="#演练事件真的可能发生" class="headerlink" title="演练事件真的可能发生"></a>演练事件真的可能发生</h3><ul>
<li>故障类：服务器异常、断网等硬件故障，外部服务不可用，人工误操作等；</li>
<li>非故障类：流量激增、 伸缩事件；</li>
</ul>
<p><strong>可以分析曾经引起生产系统故障的事件，针对性的排列优先级并实施，避免故障重现。</strong></p>
<h3 id="让故障演练成为常态"><a href="#让故障演练成为常态" class="headerlink" title="让故障演练成为常态"></a>让故障演练成为常态</h3><p>服务迭代频繁，系统不断变化，需要经常性的演练才能覆盖到系统的变更。</p>
<blockquote>
<p> 混沌工程不是制造问题，而是揭示问题。 </p>
</blockquote>
<h3 id="最小化影响范围"><a href="#最小化影响范围" class="headerlink" title="最小化影响范围"></a>最小化影响范围</h3><p>混沌工程可能导致线上功能不可用，所以在以找出系统弱点为目标的前提下，需要最小化故障影响范围，并且当出现问题时可以迅速恢复，即故障是可控的。</p>
<h2 id="演练方案"><a href="#演练方案" class="headerlink" title="演练方案"></a>演练方案</h2><h3 id="先测试后生产"><a href="#先测试后生产" class="headerlink" title="先测试后生产"></a>先测试后生产</h3><p>演练计划先在测试环境验证，故障可控的前提下再到生产环境实施。</p>
<h3 id="先次要后主要"><a href="#先次要后主要" class="headerlink" title="先次要后主要"></a>先次要后主要</h3><p>先在边缘系统进行故障演练，再对在线业务实施故障演练。</p>
<h3 id="跟踪演练计划"><a href="#跟踪演练计划" class="headerlink" title="跟踪演练计划"></a>跟踪演练计划</h3><p>记录每次演练的故障对象、故障场景、期望状态、实际状态、影响范围、修复方案。</p>
<blockquote>
<ol>
<li>如果故障对象对该故障场景的实际状态和期望状态一致，则可以认为该故障对象对这种故障是高可用的。</li>
<li>如果故障对象对该故障场景的实际状态和期望状态不一致，那就是一个系统弱点，需要制定方案来修复，修复后继续演练来验证。</li>
</ol>
</blockquote>
<p><strong>如果不能准确的观察结果和深入分析原因并得出修复方案，那就只是在搞破坏，而不是在做混沌工程。</strong></p>
<h2 id="演练目标"><a href="#演练目标" class="headerlink" title="演练目标"></a>演练目标</h2><p>提升系统的容错和弹性能力，达到小的故障不需要人工介入，大故障人工介入可以快速恢复的目的。 </p>
<ul>
<li>不需要人工介入的故障：做成不定时不定目标不定异常类型的自动化实现，常态化执行。</li>
<li>需要人工介入的故障：告警及时、准确，监控数据清晰、有效，定位问题迅速，预案完善。</li>
</ul>
<h3 id="阶段一"><a href="#阶段一" class="headerlink" title="阶段一"></a>阶段一</h3><p>在测试环境制造故障，观察服务状态和监控数据，评估系统可靠性，寻找系统弱点。</p>
<p>建立查找问题-解决问题-验证问题的循环，明确该问题是否需要人工介入。</p>
<p>对于需要人工介入的故障优化监控、告警，制定预案。</p>
<h3 id="阶段二"><a href="#阶段二" class="headerlink" title="阶段二"></a>阶段二</h3><p>将测试环境演练成功的计划放到生产环境执行验证。明确故障影响范围及解决时效，汇总实验数据。</p>
<ul>
<li>不需要人工介入的故障是否有对用户造成影响，自动解决的时间多久。</li>
<li>需要人工介入的故障影响范围及问题解决时长。</li>
</ul>
<p>持续提高团队对故障的检测、响应、处理还有恢复能力。 </p>
<h3 id="阶段三"><a href="#阶段三" class="headerlink" title="阶段三"></a>阶段三</h3><p>建设全链路压测来模拟流量激增现象，建设A/B测试来最小化影响范围，增强混沌工程演练能力。</p>
<h3 id="阶段四"><a href="#阶段四" class="headerlink" title="阶段四"></a>阶段四</h3><p>建设故障演练平台，自动化演练（启动执行、监控、终止、结果分析），常态化执行。</p>
<h2 id="实施步骤"><a href="#实施步骤" class="headerlink" title="实施步骤"></a>实施步骤</h2><ol>
<li>首先，用系统在正常行为下的一些可测量的输出来定义“稳定状态”。</li>
<li>其次，假设系统在控制组和实验组都会继续保持稳定状态。</li>
<li>然后，在实验组中引入反映真实世界事件的变量，如服务器崩溃、硬盘故障、网络连接断开等。</li>
<li>最后，通过控制组和实验组之间的状态差异来反驳稳定状态的假说。</li>
</ol>
<p><img src="https://img2018.cnblogs.com/blog/23525/201903/23525-20190309100103093-2053633006.png" alt="img"> </p>
<p>破坏稳态的难度越大，我们对系统行为的信心就越强。如果发现了一个弱点，那么我们就有了一个改进目标。可以避免在系统规模化之后被放大。 </p>
<h1 id="系统弱点"><a href="#系统弱点" class="headerlink" title="系统弱点"></a>系统弱点</h1><p> 以 A 调用 B，B 调用 C，A 同时也调用 D 举例，B1、B2 是 B 服务的多个实例，依次类推。 </p>
<h2 id="受上游服务影响"><a href="#受上游服务影响" class="headerlink" title="受上游服务影响"></a>受上游服务影响</h2><h3 id="被上游服务的高并发压垮"><a href="#被上游服务的高并发压垮" class="headerlink" title="被上游服务的高并发压垮"></a>被上游服务的高并发压垮</h3><h4 id="请求限流"><a href="#请求限流" class="headerlink" title="请求限流"></a>请求限流</h4><p>场景模拟：高并发请求B1。</p>
<p>预期方案：B1设有最大并发量，达到最大并发量后B1服务触发限流，新请求快速失败。</p>
<p>修复方案：添加限流能力。</p>
<h2 id="受下游服务影响"><a href="#受下游服务影响" class="headerlink" title="受下游服务影响"></a>受下游服务影响</h2><h3 id="下游服务异常导致本服务异常"><a href="#下游服务异常导致本服务异常" class="headerlink" title="下游服务异常导致本服务异常"></a>下游服务异常导致本服务异常</h3><h4 id="失败重试"><a href="#失败重试" class="headerlink" title="失败重试"></a>失败重试</h4><p>场景模拟：对B1注入故障，A服务调用到B1时会出现调用失败。</p>
<p>预期方案：A服务的请求路由到B2进行重试。</p>
<p>修复方案：添加失败检测和请求重试能力，B服务的接口需要有幂等性。</p>
<h4 id="实例隔离"><a href="#实例隔离" class="headerlink" title="实例隔离"></a>实例隔离</h4><p>场景模拟：对B1注入宕机故障，A服务调用到B1时会出现调用失败。</p>
<p>预期方案：给定的失败时间或者给定的失败次数后，自动隔离或下线 B1 实例。</p>
<p>修复方案：添加服务质量检查，下线不可用的服务实例。</p>
<h3 id="下游服务异常拖垮本服务"><a href="#下游服务异常拖垮本服务" class="headerlink" title="下游服务异常拖垮本服务"></a>下游服务异常拖垮本服务</h3><h4 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h4><p>场景模拟：对B所有实例注入故障，A服务调用B时都失败。</p>
<p>预期方案：调用本地降级方法。</p>
<p>修复方案：准备一个本地的fallback回调，返回一个默认值。</p>
<h4 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h4><p>场景模拟：对B所有实例注入故障，A服务调用到B时都失败。</p>
<p>预期方案：给定的失败时间或者给定的失败次数后，A服务触发熔断，快速失败。</p>
<p>修复方案：添加熔断能力，下游服务不可用时能立即熔断，快速失败。</p>
<h2 id="受中间件影响"><a href="#受中间件影响" class="headerlink" title="受中间件影响"></a>受中间件影响</h2><h3 id="中间件异常导致的程序逻辑出错"><a href="#中间件异常导致的程序逻辑出错" class="headerlink" title="中间件异常导致的程序逻辑出错"></a>中间件异常导致的程序逻辑出错</h3><h3 id="中间件异常导致的服务不可用"><a href="#中间件异常导致的服务不可用" class="headerlink" title="中间件异常导致的服务不可用"></a>中间件异常导致的服务不可用</h3><h2 id="受第三方服务商影响"><a href="#受第三方服务商影响" class="headerlink" title="受第三方服务商影响"></a>受第三方服务商影响</h2><h3 id="第三方服务不可用导致本服务功能不可用"><a href="#第三方服务不可用导致本服务功能不可用" class="headerlink" title="第三方服务不可用导致本服务功能不可用"></a>第三方服务不可用导致本服务功能不可用</h3><p>场景模拟：A短信供应商不可用。</p>
<p>预期方案：切换B短信供应商。</p>
<p>修复方案：供应商备份。</p>
<h3 id="第三方服务异常拖垮本服务"><a href="#第三方服务异常拖垮本服务" class="headerlink" title="第三方服务异常拖垮本服务"></a>第三方服务异常拖垮本服务</h3><p>场景模拟：调用OSS服务响应慢。</p>
<p>预期方案：熔断第三方服务，暂不提供该服务。</p>
<p>修复方案：供应商备份。</p>
<h1 id="故障场景"><a href="#故障场景" class="headerlink" title="故障场景"></a>故障场景</h1><h2 id="CPU异常"><a href="#CPU异常" class="headerlink" title="CPU异常"></a>CPU异常</h2><ul>
<li>CPU高负载</li>
</ul>
<h2 id="内存异常"><a href="#内存异常" class="headerlink" title="内存异常"></a>内存异常</h2><ul>
<li>内存高负载</li>
</ul>
<h2 id="磁盘异常"><a href="#磁盘异常" class="headerlink" title="磁盘异常"></a>磁盘异常</h2><ul>
<li>磁盘高负载</li>
<li>磁盘空间不足</li>
<li>部分数据丢失</li>
<li>全部数据丢失</li>
<li>不可读</li>
<li>不可写</li>
</ul>
<h2 id="网络异常"><a href="#网络异常" class="headerlink" title="网络异常"></a>网络异常</h2><ul>
<li>瞬断</li>
<li>延时</li>
<li>丢包</li>
<li>隔离</li>
<li>外部服务不可达</li>
</ul>
<h2 id="进程异常"><a href="#进程异常" class="headerlink" title="进程异常"></a>进程异常</h2><h3 id="服务进程"><a href="#服务进程" class="headerlink" title="服务进程"></a>服务进程</h3><ul>
<li>Tomcat线程池打满</li>
<li>异常关闭</li>
<li>重启</li>
<li>内存溢出</li>
</ul>
<h3 id="系统进程"><a href="#系统进程" class="headerlink" title="系统进程"></a>系统进程</h3><ul>
<li>系统时间不同步</li>
<li>OOM kill</li>
</ul>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><h4 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h4><ul>
<li>节点故障</li>
<li>重启</li>
<li>批量删除</li>
<li>数据丢失</li>
<li>响应慢</li>
</ul>
<h4 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h4><ul>
<li>CPU升高（*2019-06-01）</li>
<li>IO升高</li>
<li>节点故障</li>
<li>数据丢失</li>
<li>响应慢</li>
<li>大量慢SQL</li>
<li>连接池占满</li>
<li>死锁</li>
<li>不可写</li>
<li>不可读</li>
<li>数据同步延迟</li>
<li>主备延迟</li>
</ul>
<h4 id="RocketMQ-Kafka"><a href="#RocketMQ-Kafka" class="headerlink" title="RocketMQ/Kafka"></a>RocketMQ/Kafka</h4><ul>
<li>NameServer故障</li>
<li>Broker故障</li>
<li>数据丢失</li>
<li>消息推送延迟</li>
<li>大量消息挤压</li>
</ul>
<h4 id="Apollo"><a href="#Apollo" class="headerlink" title="Apollo"></a>Apollo</h4><ul>
<li>ConfigService故障</li>
<li>AdminService故障</li>
<li>Portal故障</li>
<li>数据丢失</li>
</ul>
<h4 id="XXL-Job"><a href="#XXL-Job" class="headerlink" title="XXL-Job"></a>XXL-Job</h4><ul>
<li>调度器故障</li>
<li>执行器故障</li>
</ul>
<h4 id="ElasticSearch"><a href="#ElasticSearch" class="headerlink" title="ElasticSearch"></a>ElasticSearch</h4><ul>
<li>节点故障</li>
<li>内存溢出</li>
<li>写请求飙高</li>
<li>读请求飙高</li>
</ul>
<h4 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h4><ul>
<li>解析超时（*2019-10-01）</li>
<li>解析错误</li>
</ul>
<h2 id="代码异常"><a href="#代码异常" class="headerlink" title="代码异常"></a>代码异常</h2><ul>
<li>空指针</li>
</ul>
<h2 id="异常操作"><a href="#异常操作" class="headerlink" title="异常操作"></a>异常操作</h2><ul>
<li>删除数据</li>
<li>强杀进程</li>
</ul>
<h2 id="服务器异常"><a href="#服务器异常" class="headerlink" title="服务器异常"></a>服务器异常</h2><ul>
<li>宕机</li>
<li>重启</li>
<li>中木马</li>
<li>修改系统配置</li>
</ul>
<h2 id="第三方服务不可用"><a href="#第三方服务不可用" class="headerlink" title="第三方服务不可用"></a>第三方服务不可用</h2><ul>
<li>响应慢</li>
<li>访问不了</li>
</ul>
<h2 id="数据中心故障"><a href="#数据中心故障" class="headerlink" title="数据中心故障"></a>数据中心故障</h2><ul>
<li>断电</li>
<li>断网</li>
</ul>
<h1 id="演练工具"><a href="#演练工具" class="headerlink" title="演练工具"></a>演练工具</h1><h2 id="chaosblade"><a href="#chaosblade" class="headerlink" title="chaosblade"></a>chaosblade</h2><p>GitHub：<a href="https://github.com/chaosblade-io/chaosblade" target="_blank" rel="noopener">https://github.com/chaosblade-io/chaosblade</a></p>
<p>文档：<a href="https://chaosblade-io.gitbook.io/chaosblade-help-zh-cn/blade" target="_blank" rel="noopener">https://chaosblade-io.gitbook.io/chaosblade-help-zh-cn/blade</a></p>
<h2 id="chaosmonkey"><a href="#chaosmonkey" class="headerlink" title="chaosmonkey"></a>chaosmonkey</h2><p>GitHub：<a href="https://github.com/Netflix/chaosmonkey" target="_blank" rel="noopener">https://github.com/Netflix/chaosmonkey</a></p>
<h2 id="pumba"><a href="#pumba" class="headerlink" title="pumba"></a>pumba</h2><p>GitHub：<a href="https://github.com/alexei-led/pumba" target="_blank" rel="noopener">https://github.com/alexei-led/pumba</a></p>
<h2 id="kube-monkey"><a href="#kube-monkey" class="headerlink" title="kube-monkey"></a>kube-monkey</h2><p>GitHub：<a href="https://github.com/asobti/kube-monkey" target="_blank" rel="noopener">https://github.com/asobti/kube-monkey</a></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p> <a href="https://www.infoq.cn/article/jjp0c2bR4*Ulld0wb88r" target="_blank" rel="noopener">https://www.infoq.cn/article/jjp0c2bR4*Ulld0wb88r</a></p>
<p> <a href="https://tech.youzan.com/chaosmonkey/" target="_blank" rel="noopener">https://tech.youzan.com/chaosmonkey/</a></p>
<p><a href="https://www.cnblogs.com/tianqing/p/10499611.html" target="_blank" rel="noopener">https://www.cnblogs.com/tianqing/p/10499611.html</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/混沌工程/">混沌工程</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/chaosBlade/">chaosBlade</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-在k8s中使用eureka的几种姿势" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/09/17/在k8s中使用eureka的几种姿势/">在k8s中使用eureka的几种姿势</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/09/17/在k8s中使用eureka的几种姿势/" class="article-date">
	  <time datetime="2019-09-17T11:29:37.000Z" itemprop="datePublished">九月 17, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在Kubernetes中，service通过label关联pod，使用service的clusterIp即可访问到对应pod。</p>
<p>如果觉得clusterIp不好记，可以用coredns将service name解析成service的clusterIp，通过访问service name来访问对应的pod。</p>
<p>通过coredns+service，可以在单个kubernetes集群中无需其他依赖即可实现服务发现。</p>
<p>但由于某些其他原因我们需要使用额外的注册中心eureka，本文列举了几种注册方式和注意事项。</p>
<h2 id="使用Pod-IP注册"><a href="#使用Pod-IP注册" class="headerlink" title="使用Pod IP注册"></a>使用Pod IP注册</h2><p>因为Pod的IP是跟随生命周期的，重新发布以后IP就变更了。</p>
<p>但是eureka的缓存机制相当长，重新发布后服务消费者很长一段时间会访问之前的Pod IP。</p>
<p>要解决这个问题有以下几个优化点：</p>
<h3 id="优雅停止Pod"><a href="#优雅停止Pod" class="headerlink" title="优雅停止Pod"></a>优雅停止Pod</h3><p>如果Pod被强杀掉，就不能立即从Eureka Server下线，直到Eureka Server的EvictionTask 来定时清理过期的客户端，默认60秒清理一次，清理掉之前还能被其他客户端发现并调用。</p>
<p>kubernetes提供了生命周期回调函数，会在容器被终止前调用preStop，执行停止Java进程的命令</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line"><span class="attr">  preStop:</span></span><br><span class="line"><span class="attr">    exec:</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["/bin/bash",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"ps -ef | grep jav[a] | awk 'NR==1&#123;print $2&#125;' | xargs kill"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>因为遵循一个容器只运行一个进程的原则，所以可以直接查找Java的pid然后kill，也可以用pidof命令查找Java的pid。</p>
<h3 id="缩短服务发现时间"><a href="#缩短服务发现时间" class="headerlink" title="缩短服务发现时间"></a>缩短服务发现时间</h3><p>Eureka客户端默认30秒的缓存时间，ribbon默认30秒的缓存时间，加上Eureka Server的三级缓存机制readOnlyCache也有30秒的缓存时间，在开启Eureka Server的自我保护模式时，即使客户端从Eureka Server下线了，极端情况下也有可能在90秒以后才能在其他客户端的缓存中清除。</p>
<p>可以通过设置deployment中的环境变量修改默认的缓存时间：</p>
<p>eureka client缓存（单位：秒）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.registryFetchIntervalSeconds = 10</span><br></pre></td></tr></table></figure>
<p>ribbon缓存（单位：秒）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ribbon.ServerListRefreshInterval = 10</span><br></pre></td></tr></table></figure>
<h3 id="关闭Eureka-Server的readOnlyCache（可选）"><a href="#关闭Eureka-Server的readOnlyCache（可选）" class="headerlink" title="关闭Eureka Server的readOnlyCache（可选）"></a>关闭Eureka Server的readOnlyCache（可选）</h3><p>因为<code>readWriteCacheMap</code>用的<code>LoadingCache</code>有读写锁，使用<code>readOnlyCacheMap</code>可以增加吞吐量，中小集群可以关闭<code>readOnlyCacheMap</code>。</p>
<p>关闭<code>readWriteCacheMap</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.server.use-read-only-response-cache = false</span><br></pre></td></tr></table></figure>
<p>也可以缩短readOnlyCache的刷新时间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eureka.server.response-cache-update-interval-ms = 10</span><br></pre></td></tr></table></figure>
<h3 id="强制下线"><a href="#强制下线" class="headerlink" title="强制下线"></a>强制下线</h3><p>即使优雅停止Pod、缩短客户端和Eureka Server的缓存时间，但是Eureka客户端还是有几率请求到已下线的Pod。</p>
<p>Eureka提供了强制下线的接口，可以先从Eureka Server强制下线，等待缓存时间过期再停止Pod。</p>
<p>client强制下线接口:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /pause</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">POST /service-registry</span><br></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST <span class="string">"http://localhost:<span class="variable">$MANAGEMENT_PORT</span>/pause"</span></span><br><span class="line">curl -X POST <span class="string">"http://localhost:<span class="variable">$MANAGEMENT_PORT</span>/service-registry/instance-status"</span> -H <span class="string">"Content-Type: text/plain; charset=utf-8"</span> -d <span class="string">"OUT_OF_SERVICE"</span></span><br></pre></td></tr></table></figure>
<p>Eureka Server强制下线接口：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUT /eureka/apps/$&#123;appId&#125;/$&#123;ip:port&#125;/status?value=OUT_OF_SERVICE</span><br></pre></td></tr></table></figure>
<p>比如：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT http://eureka:8080/eureka/apps/EUREKA-1/192.168.0.10:8080/status?value=OUT_OF_SERVICE</span><br></pre></td></tr></table></figure>
<blockquote>
<p>关于强制下线可以看一下参考里的文章。</p>
</blockquote>
<h3 id="具体配置"><a href="#具体配置" class="headerlink" title="具体配置"></a>具体配置</h3><p>实践配置为Eureka客户端缓存10秒，ribbon缓存10秒，不关闭readOnlyCache（缓存30秒），加起来缓存时间50秒。</p>
<p>将停止脚本放在指定目录，并在preStop调用。</p>
<p>脚本逻辑：1.强制下线当前实例；2.暂停总缓存时间；3.停止服务。</p>
<h4 id="配置环境变量："><a href="#配置环境变量：" class="headerlink" title="配置环境变量："></a>配置环境变量：</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">eureka.client.registryFetchIntervalSeconds</span> <span class="comment"># Eureka客户端缓存时间</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"10"</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">ribbon.ServerListRefreshInterval</span> <span class="comment">#ribbon缓存时间</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"10"</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">MANAGEMENT_PORT</span> <span class="comment">#management.port的端口</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"$&#123;management.port&#125;"</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">SLEEP_SECOND</span> <span class="comment">#总缓存时间</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"50"</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">management.endpoints.web.exposure.include</span> <span class="comment">#启用并暴露service-registry</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">service-registry</span></span><br></pre></td></tr></table></figure>
<h4 id="preStop"><a href="#preStop" class="headerlink" title="preStop"></a>preStop</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">lifecycle:</span></span><br><span class="line"><span class="attr">  preStop:</span></span><br><span class="line"><span class="attr">    exec:</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">["/bin/sh",</span> <span class="string">"/app/script/stop.sh"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<h4 id="stop-sh"><a href="#stop-sh" class="headerlink" title="stop.sh"></a>stop.sh</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 如果没有管理端口直接下线</span></span><br><span class="line">if [ -z $MANAGEMENT_PORT ];then</span><br><span class="line">  echo "MANAGEMENT_PORT is empty, kill java"</span><br><span class="line">  ps -ef | grep jav[a] | awk 'NR==1&#123;print $2&#125;' | xargs kill</span><br><span class="line">  exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 默认暂停时间</span></span><br><span class="line">if [ -z $SLEEP_SECOND ];then</span><br><span class="line">  echo "SLEEP_SECOND is empty, set 50"</span><br><span class="line">  SLEEP_SECOND=50</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从EUREKA下线</span></span><br><span class="line">echo "curl pause $MANAGEMENT_PORT"</span><br><span class="line"><span class="meta">#</span><span class="bash"> curl -X POST <span class="string">"http://localhost:<span class="variable">$MANAGEMENT_PORT</span>/pause"</span></span></span><br><span class="line">curl -X "POST" "http://localhost:$MANAGEMENT_PORT/service-registry/instance-status" -H "Content-Type: text/plain; charset=utf-8" -d "OUT_OF_SERVICE"</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 等待SLEEP_SECOND秒，SLEEP_SECOND = 客户端缓存时间（eureka+ribbon）+ readOnlyCache时间</span></span><br><span class="line">echo ""</span><br><span class="line">echo "sleep $SLEEP_SECOND s"</span><br><span class="line">sleep $SLEEP_SECOND</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 停止服务</span></span><br><span class="line">echo "kill java"</span><br><span class="line">ps -ef | grep jav[a] | awk 'NR==1&#123;print $2&#125;' | xargs kill</span><br></pre></td></tr></table></figure>
<h2 id="使用Service的Cluster-IP注册"><a href="#使用Service的Cluster-IP注册" class="headerlink" title="使用Service的Cluster IP注册"></a>使用Service的Cluster IP注册</h2><p>Service的Cluster IP是一个虚拟IP，会经kube-proxy把流量负载均衡到后端endpoint。</p>
<p>而且Service的Cluster IP是固定的，除非主动删除后重建，不然可以一直固定。</p>
<p>使用Cluster IP等于使用了Kubernetes的服务发现，当Pod不可用时就会从service的endpoint列表中移除，流量就不会再负载均衡到该Pod。</p>
<p>配置方式（properties）：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eureka.instance.ipAddress = $&#123;Cluster IP&#125;</span><br><span class="line">eureka.instance.nonSecurePort = $&#123;port&#125; #service的port</span><br></pre></td></tr></table></figure>
<p><strong>使用Service注册虽然可以自动过滤下线的服务，但是ribbon内部使用keepalive进行会话保持，因为是客户端负载均衡所以A服务的A1实例所有请求都会经过service转发到同一个B服务的B1实例，从而出现负载不均衡的情况</strong></p>
<h2 id="使用Service的NodePort注册"><a href="#使用Service的NodePort注册" class="headerlink" title="使用Service的NodePort注册"></a>使用Service的NodePort注册</h2><p>默认情况下Pod的IP只能在本集群内的Node上访问，非本集群的服务器访问不了。</p>
<p><strong>可以通过写路由表或者BGP来发布Pod路由。</strong></p>
<p>NodePort是Pod对外提供访问的一种方式，使用Host IP+NodePort可以简单实现跨集群及虚拟机之间的服务互相访问。</p>
<p>配置方式（环境变量）：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">eureka.instance.ipAddress</span></span><br><span class="line"><span class="attr">  valueFrom:</span></span><br><span class="line"><span class="attr">    fieldRef:</span></span><br><span class="line"><span class="attr">      fieldPath:</span> <span class="string">status.hostIP</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">eureka.instance.nonSecurePort</span></span><br><span class="line"><span class="attr">  value:</span> <span class="string">"$&#123;NodePort&#125;"</span></span><br></pre></td></tr></table></figure>
<p><strong>NodePort方式本质也是Service，所以也存在负载均衡的情况。</strong></p>
<p><strong>另外管理NodePort也是件麻烦事。</strong></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.itmuch.com/spring-cloud-sum/how-to-unregister-service-in-eureka/" target="_blank" rel="noopener">http://www.itmuch.com/spring-cloud-sum/how-to-unregister-service-in-eureka/</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/eureka/">eureka</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Eureka服务注册发现" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/09/17/Eureka服务注册发现/">Eureka服务注册发现</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/09/17/Eureka服务注册发现/" class="article-date">
	  <time datetime="2019-09-17T11:19:37.000Z" itemprop="datePublished">九月 17, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="注册发现流程"><a href="#注册发现流程" class="headerlink" title="注册发现流程"></a>注册发现流程</h2><p>通常服务注册发现都分为服务提供者（provider）、服务消费者（consumer）、注册中心（register）三个部分。</p>
<p><img src="http://image.sunshanpeng.com/201909061100_956.png" style="zoom:60%;"></p>
<blockquote>
<p>一个服务可以是服务提供者可以是服务消费者，也可以即是提供者也是消费者</p>
</blockquote>
<p>其中provider和consumer作为客户端client，注册中心作为服务端server，都可以同时存在多个实例。</p>
<p>服务提供者把自身的实例信息（比如IP、PORT、状态等）在注册中心做登记，服务消费者通过注册中心获取服务提供者的信息然后发起调用。</p>
<p>常用的注册中心有Zookeeper、ETCD、Eureka、Consul、Nacos。</p>
<h2 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h2><p><img src="http://image.sunshanpeng.com/201909061105_502.png" style="zoom:60%;"></p>
<p>首先我们会在client配置eureka server的地址，如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eureka.client.service-url.defaultZone=</span><br><span class="line">http://localhost:8081/eureka/,http://localhost:8082/eureka/,http://localhost:8083/eureka/</span><br></pre></td></tr></table></figure>
<p>客户端会尝试向配置的eureka server发起注册请求。</p>
<p>入口：<code>com.netflix.discovery.DiscoveryClient#register</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">register</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">        logger.info(PREFIX + appPathIdentifier + <span class="string">": registering service..."</span>);</span><br><span class="line">        EurekaHttpResponse&lt;Void&gt; httpResponse;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            httpResponse = eurekaTransport.registrationClient.register(instanceInfo);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.warn(<span class="string">"&#123;&#125; - registration failed &#123;&#125;"</span>, PREFIX + appPathIdentifier, e.getMessage(), e);</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (logger.isInfoEnabled()) &#123;</span><br><span class="line">            logger.info(<span class="string">"&#123;&#125; - registration status: &#123;&#125;"</span>, PREFIX + appPathIdentifier, httpResponse.getStatusCode());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> httpResponse.getStatusCode() == <span class="number">204</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>核心代码：<code>com.netflix.discovery.shared.transport.decorator.RetryableEurekaHttpClient#execute</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;R&gt; <span class="function">EurekaHttpResponse&lt;R&gt; <span class="title">execute</span><span class="params">(RequestExecutor&lt;R&gt; requestExecutor)</span> </span>&#123;</span><br><span class="line">       List&lt;EurekaEndpoint&gt; candidateHosts = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">int</span> endpointIdx = <span class="number">0</span>;</span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> retry = <span class="number">0</span>; retry &lt; numberOfRetries; retry++) &#123;</span><br><span class="line">           <span class="comment">//currentHttpClient是上面配置的三个eureka server中的其中一个</span></span><br><span class="line">           <span class="comment">//如果eureka server能用，就会一直请求同一个eureka server</span></span><br><span class="line">           EurekaHttpClient currentHttpClient = delegate.get();</span><br><span class="line">           EurekaEndpoint currentEndpoint = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">if</span> (currentHttpClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">if</span> (candidateHosts == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="comment">//获取eureka server列表</span></span><br><span class="line">                   candidateHosts = getHostCandidates();</span><br><span class="line">                   <span class="keyword">if</span> (candidateHosts.isEmpty()) &#123;</span><br><span class="line">                       <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"There is no known eureka server; cluster server list is empty"</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (endpointIdx &gt;= candidateHosts.size()) &#123;</span><br><span class="line">                   <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"Cannot execute request on any known server"</span>);</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               currentEndpoint = candidateHosts.get(endpointIdx++);</span><br><span class="line">               currentHttpClient = clientFactory.newClient(currentEndpoint);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               EurekaHttpResponse&lt;R&gt; response = requestExecutor.execute(currentHttpClient);</span><br><span class="line">               <span class="keyword">if</span> (serverStatusEvaluator.accept(response.getStatusCode(), requestExecutor.getRequestType())) &#123;</span><br><span class="line">                   delegate.set(currentHttpClient);</span><br><span class="line">                   <span class="keyword">if</span> (retry &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                       logger.info(<span class="string">"Request execution succeeded on retry #&#123;&#125;"</span>, retry);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span> response;</span><br><span class="line">               &#125;</span><br><span class="line">               logger.warn(<span class="string">"Request execution failure with status code &#123;&#125;; retrying on another server if available"</span>, response.getStatusCode());</span><br><span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">               logger.warn(<span class="string">"Request execution failed with message: &#123;&#125;"</span>, e.getMessage());  <span class="comment">// just log message as the underlying client should log the stacktrace</span></span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">//如果请求则把eureka server置为空，下次重试时会换一个eureka server</span></span><br><span class="line">           delegate.compareAndSet(currentHttpClient, <span class="keyword">null</span>);</span><br><span class="line">           <span class="keyword">if</span> (currentEndpoint != <span class="keyword">null</span>) &#123;</span><br><span class="line">               quarantineSet.add(currentEndpoint);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> TransportException(<span class="string">"Retry limit reached; giving up on completing the request"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h3 id="Eureka-server获取"><a href="#Eureka-server获取" class="headerlink" title="Eureka server获取"></a>Eureka server获取</h3><p>我们实际注册的eureka server和配置的eureka server顺序是不一样的，比如我们配置的顺序是<code>http://localhost:8081/eureka,http://localhost:8082/eureka,http://localhost:8083/eureka</code>，原先以为会先注册到<code>http://localhost:8081/eureka</code>，但实际是先尝试注册到<code>http://localhost:8083/eureka</code>。</p>
<p>因为获取列表的时候做了一次randomize，如果是三个server实例，会交互1和3的位置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends EurekaEndpoint&gt; <span class="function">List&lt;T&gt; <span class="title">randomize</span><span class="params">(List&lt;T&gt; list)</span> </span>&#123;</span><br><span class="line">        List&lt;T&gt; randomList = <span class="keyword">new</span> ArrayList&lt;&gt;(list);</span><br><span class="line">        <span class="keyword">if</span> (randomList.size() &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> randomList;</span><br><span class="line">        &#125;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random(LOCAL_IPV4_ADDRESS.hashCode());</span><br><span class="line">        <span class="keyword">int</span> last = randomList.size() - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; last; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> pos = random.nextInt(randomList.size() - i);</span><br><span class="line">            <span class="keyword">if</span> (pos != i) &#123;</span><br><span class="line">                Collections.swap(randomList, i, pos);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> randomList;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="客户端发起注册请求"><a href="#客户端发起注册请求" class="headerlink" title="客户端发起注册请求"></a>客户端发起注册请求</h3><p>源码：<code>com.netflix.discovery.shared.transport.jersey.AbstractJerseyEurekaHttpClient#register</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> EurekaHttpResponse&lt;Void&gt; <span class="title">register</span><span class="params">(InstanceInfo info)</span> </span>&#123;</span><br><span class="line">        String urlPath = <span class="string">"apps/"</span> + info.getAppName();</span><br><span class="line">        ClientResponse response = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Builder resourceBuilder = jerseyClient.resource(serviceUrl).path(urlPath).getRequestBuilder();</span><br><span class="line">            addExtraHeaders(resourceBuilder);</span><br><span class="line">            response = resourceBuilder</span><br><span class="line">                    .header(<span class="string">"Accept-Encoding"</span>, <span class="string">"gzip"</span>)</span><br><span class="line">                    .type(MediaType.APPLICATION_JSON_TYPE)</span><br><span class="line">                    .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">                    .post(ClientResponse.class, info);</span><br><span class="line">            <span class="keyword">return</span> anEurekaHttpResponse(response.getStatus()).headers(headersOf(response)).build();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                logger.debug(<span class="string">"Jersey HTTP POST &#123;&#125;/&#123;&#125; with instance &#123;&#125;; statusCode=&#123;&#125;"</span>, serviceUrl, urlPath, info.getId(),</span><br><span class="line">                        response == <span class="keyword">null</span> ? <span class="string">"N/A"</span> : response.getStatus());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">                response.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="服务端接受注册请求"><a href="#服务端接受注册请求" class="headerlink" title="服务端接受注册请求"></a>服务端接受注册请求</h3><p>入口：<code>com.netflix.eureka.resources.ApplicationResource#addInstance</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@POST</span></span><br><span class="line">   <span class="meta">@Consumes</span>(&#123;<span class="string">"application/json"</span>, <span class="string">"application/xml"</span>&#125;)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Response <span class="title">addInstance</span><span class="params">(InstanceInfo info,</span></span></span><br><span class="line"><span class="function"><span class="params">                               @HeaderParam(PeerEurekaNode.HEADER_REPLICATION)</span> String isReplication) </span>&#123;</span><br><span class="line">       logger.debug(<span class="string">"Registering instance &#123;&#125; (replication=&#123;&#125;)"</span>, info.getId(), isReplication);</span><br><span class="line">       <span class="comment">// validate that the instanceinfo contains all the necessary required fields</span></span><br><span class="line">       <span class="keyword">if</span> (isBlank(info.getId())) &#123;</span><br><span class="line">           <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing instanceId"</span>).build();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getHostName())) &#123;</span><br><span class="line">           <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing hostname"</span>).build();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isBlank(info.getAppName())) &#123;</span><br><span class="line">           <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing appName"</span>).build();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!appName.equals(info.getAppName())) &#123;</span><br><span class="line">           <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Mismatched appName, expecting "</span> + appName + <span class="string">" but was "</span> + info.getAppName()).build();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo() == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo"</span>).build();</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (info.getDataCenterInfo().getName() == <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(<span class="string">"Missing dataCenterInfo Name"</span>).build();</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// handle cases where clients may be registering with bad DataCenterInfo with missing data</span></span><br><span class="line">       DataCenterInfo dataCenterInfo = info.getDataCenterInfo();</span><br><span class="line">       <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> UniqueIdentifier) &#123;</span><br><span class="line">           String dataCenterInfoId = ((UniqueIdentifier) dataCenterInfo).getId();</span><br><span class="line">           <span class="keyword">if</span> (isBlank(dataCenterInfoId)) &#123;</span><br><span class="line">               <span class="keyword">boolean</span> experimental = <span class="string">"true"</span>.equalsIgnoreCase(serverConfig.getExperimental(<span class="string">"registration.validation.dataCenterInfoId"</span>));</span><br><span class="line">               <span class="keyword">if</span> (experimental) &#123;</span><br><span class="line">                   String entity = <span class="string">"DataCenterInfo of type "</span> + dataCenterInfo.getClass() + <span class="string">" must contain a valid id"</span>;</span><br><span class="line">                   <span class="keyword">return</span> Response.status(<span class="number">400</span>).entity(entity).build();</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dataCenterInfo <span class="keyword">instanceof</span> AmazonInfo) &#123;</span><br><span class="line">                   AmazonInfo amazonInfo = (AmazonInfo) dataCenterInfo;</span><br><span class="line">                   String effectiveId = amazonInfo.get(AmazonInfo.MetaDataKey.instanceId);</span><br><span class="line">                   <span class="keyword">if</span> (effectiveId == <span class="keyword">null</span>) &#123;</span><br><span class="line">                       amazonInfo.getMetadata().put(AmazonInfo.MetaDataKey.instanceId.getName(), info.getId());</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   logger.warn(<span class="string">"Registering DataCenterInfo of type &#123;&#125; without an appropriate id"</span>, dataCenterInfo.getClass());</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       registry.register(info, <span class="string">"true"</span>.equals(isReplication));</span><br><span class="line">       <span class="keyword">return</span> Response.status(<span class="number">204</span>).build();  <span class="comment">// 204 to be backwards compatible</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>核心代码：<code>com.netflix.eureka.registry.AbstractInstanceRegistry</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(InstanceInfo registrant, <span class="keyword">int</span> leaseDuration, <span class="keyword">boolean</span> isReplication)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 上只读锁</span></span><br><span class="line">        read.lock();</span><br><span class="line">        <span class="comment">// 从本地MAP里面获取当前实例的信息。</span></span><br><span class="line">        Map&lt;String, Lease&lt;InstanceInfo&gt;&gt; gMap = registry.get(registrant.getAppName());</span><br><span class="line">        <span class="comment">// 增加注册次数到监控信息里面去。</span></span><br><span class="line">        REGISTER.increment(isReplication);</span><br><span class="line">        <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 如果第一次进来，那么gMap为空，则创建一个ConcurrentHashMap放入到registry里面去</span></span><br><span class="line">            <span class="keyword">final</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt; gNewMap = <span class="keyword">new</span> ConcurrentHashMap&lt;String, Lease&lt;InstanceInfo&gt;&gt;();</span><br><span class="line">            <span class="comment">// putIfAbsent方法主要是在向ConcurrentHashMap中添加键—值对的时候，它会先判断该键值对是否已经存在。</span></span><br><span class="line">            <span class="comment">// 如果不存在（新的entry），那么会向map中添加该键值对，并返回null。</span></span><br><span class="line">            <span class="comment">// 如果已经存在，那么不会覆盖已有的值，直接返回已经存在的值。</span></span><br><span class="line">            gMap = registry.putIfAbsent(registrant.getAppName(), gNewMap);</span><br><span class="line">            <span class="keyword">if</span> (gMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 表明map中确实不存在，则设置gMap为最新创建的那个</span></span><br><span class="line">                gMap = gNewMap;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从MAP中查询已经存在的Lease信息 （比如第二次来）</span></span><br><span class="line">        Lease&lt;InstanceInfo&gt; existingLease = gMap.get(registrant.getId());</span><br><span class="line">        <span class="comment">// 当Lease的对象不为空时。</span></span><br><span class="line">        <span class="keyword">if</span> (existingLease != <span class="keyword">null</span> &amp;&amp; (existingLease.getHolder() != <span class="keyword">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// 当instance已经存在是，和客户端的instance的信息做比较，时间最新的那个，为有效instance信息</span></span><br><span class="line">            Long existingLastDirtyTimestamp = existingLease.getHolder().getLastDirtyTimestamp(); <span class="comment">// server</span></span><br><span class="line">            Long registrationLastDirtyTimestamp = registrant.getLastDirtyTimestamp();   <span class="comment">// client</span></span><br><span class="line">            logger.debug(<span class="string">"Existing lease found (existing=&#123;&#125;, provided=&#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">            <span class="keyword">if</span> (existingLastDirtyTimestamp &gt; registrationLastDirtyTimestamp) &#123;</span><br><span class="line">                logger.warn(<span class="string">"There is an existing lease and the existing lease's dirty timestamp &#123;&#125; is greater"</span> +</span><br><span class="line">                        <span class="string">" than the one that is being registered &#123;&#125;"</span>, existingLastDirtyTimestamp, registrationLastDirtyTimestamp);</span><br><span class="line">                logger.warn(<span class="string">"Using the existing instanceInfo instead of the new instanceInfo as the registrant"</span>);</span><br><span class="line">                registrant = existingLease.getHolder();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 这里只有当existinglease不存在时，才会进来。 像那种恢复心跳，信息过期的，都不会进入这里。</span></span><br><span class="line">            <span class="comment">//  Eureka-Server的自我保护机制做的操作，为每分钟最大续约数+2 ，同时重新计算每分钟最小续约数</span></span><br><span class="line">            <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// Since the client wants to cancel it, reduce the threshold</span></span><br><span class="line">                    <span class="comment">// (1</span></span><br><span class="line">                    <span class="comment">// for 30 seconds, 2 for a minute)</span></span><br><span class="line">                    <span class="keyword">this</span>.expectedNumberOfRenewsPerMin = <span class="keyword">this</span>.expectedNumberOfRenewsPerMin + <span class="number">2</span>;</span><br><span class="line">                    <span class="keyword">this</span>.numberOfRenewsPerMinThreshold =</span><br><span class="line">                            (<span class="keyword">int</span>) (<span class="keyword">this</span>.expectedNumberOfRenewsPerMin * serverConfig.getRenewalPercentThreshold());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            logger.debug(<span class="string">"No previous lease information found; it is new registration"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 构建一个最新的Lease信息</span></span><br><span class="line">        Lease&lt;InstanceInfo&gt; lease = <span class="keyword">new</span> Lease&lt;InstanceInfo&gt;(registrant, leaseDuration);</span><br><span class="line">        <span class="keyword">if</span> (existingLease != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 当原来存在Lease的信息时，设置他的serviceUpTimestamp, 保证服务开启的时间一直是第一次的那个</span></span><br><span class="line">            lease.setServiceUpTimestamp(existingLease.getServiceUpTimestamp());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 放入本地Map中</span></span><br><span class="line">        gMap.put(registrant.getId(), lease);</span><br><span class="line">        <span class="comment">// 添加到最近的注册队列里面去，以时间戳作为Key， 名称作为value，主要是为了运维界面的统计数据。</span></span><br><span class="line">        <span class="keyword">synchronized</span> (recentRegisteredQueue) &#123;</span><br><span class="line">            recentRegisteredQueue.add(<span class="keyword">new</span> Pair&lt;Long, String&gt;(</span><br><span class="line">                    System.currentTimeMillis(),</span><br><span class="line">                    registrant.getAppName() + <span class="string">"("</span> + registrant.getId() + <span class="string">")"</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This is where the initial state transfer of overridden status happens</span></span><br><span class="line">        <span class="comment">// 分析instanceStatus</span></span><br><span class="line">        <span class="keyword">if</span> (!InstanceStatus.UNKNOWN.equals(registrant.getOverriddenStatus())) &#123;</span><br><span class="line">            logger.debug(<span class="string">"Found overridden status &#123;&#125; for instance &#123;&#125;. Checking to see if needs to be add to the "</span></span><br><span class="line">                            + <span class="string">"overrides"</span>, registrant.getOverriddenStatus(), registrant.getId());</span><br><span class="line">            <span class="keyword">if</span> (!overriddenInstanceStatusMap.containsKey(registrant.getId())) &#123;</span><br><span class="line">                logger.info(<span class="string">"Not found overridden id &#123;&#125; and hence adding it"</span>, registrant.getId());</span><br><span class="line">                overriddenInstanceStatusMap.put(registrant.getId(), registrant.getOverriddenStatus());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        InstanceStatus overriddenStatusFromMap = overriddenInstanceStatusMap.get(registrant.getId());</span><br><span class="line">        <span class="keyword">if</span> (overriddenStatusFromMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">"Storing overridden status &#123;&#125; from map"</span>, overriddenStatusFromMap);</span><br><span class="line">            registrant.setOverriddenStatus(overriddenStatusFromMap);</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// Set the status based on the overridden status rules</span></span><br><span class="line">        InstanceStatus overriddenInstanceStatus = getOverriddenInstanceStatus(registrant, existingLease, isReplication);</span><br><span class="line">        registrant.setStatusWithoutDirty(overriddenInstanceStatus);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// If the lease is registered with UP status, set lease service up timestamp</span></span><br><span class="line">        <span class="comment">// 得到instanceStatus，判断是否是UP状态，</span></span><br><span class="line">        <span class="keyword">if</span> (InstanceStatus.UP.equals(registrant.getStatus())) &#123;</span><br><span class="line">            lease.serviceUp();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 设置注册类型为添加</span></span><br><span class="line">        registrant.setActionType(ActionType.ADDED);</span><br><span class="line">        <span class="comment">// 租约变更记录队列，记录了实例的每次变化， 用于注册信息的增量获取、</span></span><br><span class="line">        recentlyChangedQueue.add(<span class="keyword">new</span> RecentlyChangedItem(lease));</span><br><span class="line">        registrant.setLastUpdatedTimestamp();</span><br><span class="line">        <span class="comment">// 清理缓存 ，传入的参数为key</span></span><br><span class="line">        invalidateCache(registrant.getAppName(), registrant.getVIPAddress(), registrant.getSecureVipAddress());</span><br><span class="line">        logger.info(<span class="string">"Registered instance &#123;&#125;/&#123;&#125; with status &#123;&#125; (replication=&#123;&#125;)"</span>,</span><br><span class="line">                registrant.getAppName(), registrant.getId(), registrant.getStatus(), isReplication);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        read.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，服务注册就算完啦。</p>
<h2 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h2><h3 id="Eureka-server缓存"><a href="#Eureka-server缓存" class="headerlink" title="Eureka server缓存"></a>Eureka server缓存</h3><p>eureka server默认情况下有三个地方存储了服务信息，分别是<code>com.netflix.eureka.registry.AbstractInstanceRegistry#registry</code>、<code>com.netflix.eureka.registry.ResponseCacheImpl#readWriteCacheMap</code>、<code>com.netflix.eureka.registry.ResponseCacheImpl#readOnlyCacheMap</code>。</p>
<p><img src="http://image.sunshanpeng.com/201909061109_474.png" style="zoom:60%;"></p>
<h4 id="registry"><a href="#registry" class="headerlink" title="registry"></a>registry</h4><p>数据结构<code>ConcurrentHashMap&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt;</code>，外面Map的key是AppName，就是注册在eureka上的服务；里面Map的key是IP，value是服务的具体实例。</p>
<p>  <strong>所有的服务都是注册到registry上面的，eureka server提供的UI界面查询到的服务信息也是直接从registry中获取的</strong>。</p>
<p>  入口：<code>org.springframework.cloud.netflix.eureka.server.EurekaController#status</code></p>
<p>  核心代码：<code>com.netflix.eureka.registry.AbstractInstanceRegistry#getApplicationsFromMultipleRegions</code></p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Applications <span class="title">getApplicationsFromMultipleRegions</span><span class="params">(String[] remoteRegions)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> includeRemoteRegion = <span class="keyword">null</span> != remoteRegions &amp;&amp; remoteRegions.length != <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">"Fetching applications registry with remote regions: &#123;&#125;, Regions argument &#123;&#125;"</span>,</span><br><span class="line">                includeRemoteRegion, Arrays.toString(remoteRegions));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (includeRemoteRegion) &#123;</span><br><span class="line">            GET_ALL_WITH_REMOTE_REGIONS_CACHE_MISS.increment();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            GET_ALL_CACHE_MISS.increment();</span><br><span class="line">        &#125;</span><br><span class="line">        Applications apps = <span class="keyword">new</span> Applications();</span><br><span class="line">        apps.setVersion(<span class="number">1L</span>);</span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;String, Map&lt;String, Lease&lt;InstanceInfo&gt;&gt;&gt; entry : registry.entrySet()) &#123;</span><br><span class="line">            Application app = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (entry.getValue() != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Entry&lt;String, Lease&lt;InstanceInfo&gt;&gt; stringLeaseEntry : entry.getValue().entrySet()) &#123;</span><br><span class="line">                    Lease&lt;InstanceInfo&gt; lease = stringLeaseEntry.getValue();</span><br><span class="line">                    <span class="keyword">if</span> (app == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        app = <span class="keyword">new</span> Application(lease.getHolder().getAppName());</span><br><span class="line">                    &#125;</span><br><span class="line">                    app.addInstance(decorateInstanceInfo(lease));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (app != <span class="keyword">null</span>) &#123;</span><br><span class="line">                apps.addApplication(app);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (includeRemoteRegion) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String remoteRegion : remoteRegions) &#123;</span><br><span class="line">                RemoteRegionRegistry remoteRegistry = regionNameVSRemoteRegistry.get(remoteRegion);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != remoteRegistry) &#123;</span><br><span class="line">                    Applications remoteApps = remoteRegistry.getApplications();</span><br><span class="line">                    <span class="keyword">for</span> (Application application : remoteApps.getRegisteredApplications()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (shouldFetchFromRemoteRegistry(application.getName(), remoteRegion)) &#123;</span><br><span class="line">                            logger.info(<span class="string">"Application &#123;&#125;  fetched from the remote region &#123;&#125;"</span>,</span><br><span class="line">                                    application.getName(), remoteRegion);</span><br><span class="line"></span><br><span class="line">                            Application appInstanceTillNow = apps.getRegisteredApplications(application.getName());</span><br><span class="line">                            <span class="keyword">if</span> (appInstanceTillNow == <span class="keyword">null</span>) &#123;</span><br><span class="line">                                appInstanceTillNow = <span class="keyword">new</span> Application(application.getName());</span><br><span class="line">                                apps.addApplication(appInstanceTillNow);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">for</span> (InstanceInfo instanceInfo : application.getInstances()) &#123;</span><br><span class="line">                                appInstanceTillNow.addInstance(instanceInfo);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            logger.debug(<span class="string">"Application &#123;&#125; not fetched from the remote region &#123;&#125; as there exists a "</span></span><br><span class="line">                                            + <span class="string">"whitelist and this app is not in the whitelist."</span>,</span><br><span class="line">                                    application.getName(), remoteRegion);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    logger.warn(<span class="string">"No remote registry available for the remote region &#123;&#125;"</span>, remoteRegion);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        apps.setAppsHashCode(apps.getReconcileHashCode());</span><br><span class="line">        <span class="keyword">return</span> apps;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="readWriteCacheMap"><a href="#readWriteCacheMap" class="headerlink" title="readWriteCacheMap"></a>readWriteCacheMap</h4><p>数据结构<code>LoadingCache&lt;Key, Value&gt;</code>。</p>
<p>LoadingCache是谷歌guava提供的一个缓存实现，核心代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.readWriteCacheMap =</span><br><span class="line">               CacheBuilder.newBuilder().initialCapacity(<span class="number">1000</span>)</span><br><span class="line">   					<span class="comment">//缓存失效时间，可以配置，默认180秒</span></span><br><span class="line">                       .expireAfterWrite(serverConfig.getResponseCacheAutoExpirationInSeconds(), TimeUnit.SECONDS)</span><br><span class="line">                       .removalListener(<span class="keyword">new</span> RemovalListener&lt;Key, Value&gt;() &#123;</span><br><span class="line">                           <span class="meta">@Override</span></span><br><span class="line">                           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRemoval</span><span class="params">(RemovalNotification&lt;Key, Value&gt; notification)</span> </span>&#123;</span><br><span class="line">                               Key removedKey = notification.getKey();</span><br><span class="line">                               <span class="keyword">if</span> (removedKey.hasRegions()) &#123;</span><br><span class="line">                                   Key cloneWithNoRegions = removedKey.cloneWithoutRegions();</span><br><span class="line">                                   regionSpecificKeys.remove(cloneWithNoRegions, removedKey);</span><br><span class="line">                               &#125;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;)</span><br><span class="line">   				<span class="comment">//如果key对应的value为空，调用该方法获取value并放到缓存中，该方法是线程安全的</span></span><br><span class="line">   				<span class="comment">//这里是去registry中获取</span></span><br><span class="line">                       .build(<span class="keyword">new</span> CacheLoader&lt;Key, Value&gt;() &#123;</span><br><span class="line">                           <span class="meta">@Override</span></span><br><span class="line">                           <span class="function"><span class="keyword">public</span> Value <span class="title">load</span><span class="params">(Key key)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                               <span class="keyword">if</span> (key.hasRegions()) &#123;</span><br><span class="line">                                   Key cloneWithNoRegions = key.cloneWithoutRegions();</span><br><span class="line">                                   regionSpecificKeys.put(cloneWithNoRegions, key);</span><br><span class="line">                               &#125;</span><br><span class="line">                               Value value = generatePayload(key);</span><br><span class="line">                               <span class="keyword">return</span> value;</span><br><span class="line">                           &#125;</span><br><span class="line">                       &#125;);</span><br><span class="line"></span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Generate pay load for the given key.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Value <span class="title">generatePayload</span><span class="params">(Key key)</span> </span>&#123;</span><br><span class="line">       Stopwatch tracer = <span class="keyword">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           String payload;</span><br><span class="line">           <span class="keyword">switch</span> (key.getEntityType()) &#123;</span><br><span class="line">               <span class="keyword">case</span> Application:</span><br><span class="line">                   <span class="keyword">boolean</span> isRemoteRegionRequested = key.hasRegions();</span><br><span class="line">    </span><br><span class="line">                   <span class="keyword">if</span> (ALL_APPS.equals(key.getName())) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (isRemoteRegionRequested) &#123;</span><br><span class="line">                           tracer = serializeAllAppsWithRemoteRegionTimer.start();</span><br><span class="line">                           payload = getPayLoad(key, registry.getApplicationsFromMultipleRegions(key.getRegions()));</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           tracer = serializeAllAppsTimer.start();</span><br><span class="line">                           payload = getPayLoad(key, registry.getApplications());</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ALL_APPS_DELTA.equals(key.getName())) &#123;</span><br><span class="line">                       <span class="keyword">if</span> (isRemoteRegionRequested) &#123;</span><br><span class="line">                           tracer = serializeDeltaAppsWithRemoteRegionTimer.start();</span><br><span class="line">                           versionDeltaWithRegions.incrementAndGet();</span><br><span class="line">                           versionDeltaWithRegionsLegacy.incrementAndGet();</span><br><span class="line">                           payload = getPayLoad(key, registry.getApplicationDeltasFromMultipleRegions(key.getRegions()));</span><br><span class="line">                       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                           tracer = serializeDeltaAppsTimer.start();</span><br><span class="line">                           versionDelta.incrementAndGet();</span><br><span class="line">                           versionDeltaLegacy.incrementAndGet();</span><br><span class="line">                           payload = getPayLoad(key, registry.getApplicationDeltas());</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       tracer = serializeOneApptimer.start();</span><br><span class="line">                       payload = getPayLoad(key, registry.getApplication(key.getName()));</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">case</span> VIP:</span><br><span class="line">               <span class="keyword">case</span> SVIP:</span><br><span class="line">                   tracer = serializeViptimer.start();</span><br><span class="line">                   payload = getPayLoad(key, getApplicationsForVip(key, registry));</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               <span class="keyword">default</span>:</span><br><span class="line">                   logger.error(<span class="string">"Unidentified entity type: "</span> + key.getEntityType() + <span class="string">" found in the cache key."</span>);</span><br><span class="line">                   payload = <span class="string">""</span>;</span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">new</span> Value(payload);</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">               tracer.stop();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>缓存除了到失效时间后会失效以外，每次对registry进行写操作的时候也会调用<code>com.netflix.eureka.registry.ResponseCacheImpl#invalidate</code>删除缓存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(String appName, @Nullable String vipAddress, @Nullable String secureVipAddress)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (Key.KeyType type : Key.KeyType.values()) &#123;</span><br><span class="line">          <span class="keyword">for</span> (Version v : Version.values()) &#123;</span><br><span class="line">              invalidate(</span><br><span class="line">                      <span class="keyword">new</span> Key(Key.EntityType.Application, appName, type, v, EurekaAccept.full),</span><br><span class="line">                      <span class="keyword">new</span> Key(Key.EntityType.Application, appName, type, v, EurekaAccept.compact),</span><br><span class="line">                      <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS, type, v, EurekaAccept.full),</span><br><span class="line">                      <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS, type, v, EurekaAccept.compact),</span><br><span class="line">                      <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS_DELTA, type, v, EurekaAccept.full),</span><br><span class="line">                      <span class="keyword">new</span> Key(Key.EntityType.Application, ALL_APPS_DELTA, type, v, EurekaAccept.compact)</span><br><span class="line">              );</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">null</span> != vipAddress) &#123;</span><br><span class="line">                  invalidate(<span class="keyword">new</span> Key(Key.EntityType.VIP, vipAddress, type, v, EurekaAccept.full));</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">null</span> != secureVipAddress) &#123;</span><br><span class="line">                  invalidate(<span class="keyword">new</span> Key(Key.EntityType.SVIP, secureVipAddress, type, v, EurekaAccept.full));</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invalidate</span><span class="params">(Key... keys)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">for</span> (Key key : keys) &#123;</span><br><span class="line">          logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;, &#123;&#125;"</span>,</span><br><span class="line">                  key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept());</span><br><span class="line">    </span><br><span class="line">          readWriteCacheMap.invalidate(key);</span><br><span class="line">          Collection&lt;Key&gt; keysWithRegions = regionSpecificKeys.get(key);</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">null</span> != keysWithRegions &amp;&amp; !keysWithRegions.isEmpty()) &#123;</span><br><span class="line">              <span class="keyword">for</span> (Key keysWithRegion : keysWithRegions) &#123;</span><br><span class="line">                  logger.debug(<span class="string">"Invalidating the response cache key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>,</span><br><span class="line">                          key.getEntityType(), key.getName(), key.getVersion(), key.getType(), key.getEurekaAccept());</span><br><span class="line">                  readWriteCacheMap.invalidate(keysWithRegion);</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>由此可以看出，readWriteCacheMap的数据和registry的数据基本是一致的</strong>。</p>
<h4 id="readOnlyCacheMap"><a href="#readOnlyCacheMap" class="headerlink" title="readOnlyCacheMap"></a>readOnlyCacheMap</h4><p>数据结构<code>ConcurrentMap&lt;Key, Value&gt;</code>。</p>
<p>可以用<code>useReadOnlyResponseCache</code>配置控制是否启用<code>readOnlyCacheMap</code>，默认为true启用<code>readOnlyCacheMap</code>。</p>
<p>初始化<code>com.netflix.eureka.registry.ResponseCacheImpl</code>的时候会判断<code>useReadOnlyResponseCache</code>,启用的话会开一个更新<code>readOnlyCacheMap</code>的定时任务：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (shouldUseReadOnlyResponseCache) &#123;</span><br><span class="line">            timer.schedule(getCacheUpdateTask(),</span><br><span class="line">                    <span class="keyword">new</span> Date(((System.currentTimeMillis() / responseCacheUpdateIntervalMs) * responseCacheUpdateIntervalMs)</span><br><span class="line">                            + responseCacheUpdateIntervalMs),</span><br><span class="line">                    responseCacheUpdateIntervalMs);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p><code>responseCacheUpdateIntervalMs</code>是<code>readOnlyCacheMap</code>从<code>readWriteCacheMap</code>同步缓存的时间，默认30s。</p>
<p>核心代码：<code>com.netflix.eureka.registry.ResponseCacheImpl#getCacheUpdateTask</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TimerTask <span class="title">getCacheUpdateTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> TimerTask() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">               logger.debug(<span class="string">"Updating the client cache from response cache"</span>);</span><br><span class="line">               <span class="keyword">for</span> (Key key : readOnlyCacheMap.keySet()) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">                       Object[] args = &#123;key.getEntityType(), key.getName(), key.getVersion(), key.getType()&#125;;</span><br><span class="line">                       logger.debug(<span class="string">"Updating the client cache from response cache for key : &#123;&#125; &#123;&#125; &#123;&#125; &#123;&#125;"</span>, args);</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       CurrentRequestVersion.set(key.getVersion());</span><br><span class="line">                       Value cacheValue = readWriteCacheMap.get(key);</span><br><span class="line">                       Value currentCacheValue = readOnlyCacheMap.get(key);</span><br><span class="line">                       <span class="comment">//从readWriteCacheMap取出对应Key的value，</span></span><br><span class="line">                       <span class="comment">//如果不一样以readWriteCacheMap的为准</span></span><br><span class="line">                       <span class="keyword">if</span> (cacheValue != currentCacheValue) &#123;</span><br><span class="line">                           readOnlyCacheMap.put(key, cacheValue);</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">                       logger.error(<span class="string">"Error while updating the client cache from response cache"</span>, th);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><strong>由此可以看出，默认配置下从<code>readOnlyCacheMap</code>获取的实例信息，可能有30S的缓存时间数据是不一致的。</strong></p>
<h3 id="服务消费者缓存"><a href="#服务消费者缓存" class="headerlink" title="服务消费者缓存"></a>服务消费者缓存</h3><p>服务消费者从eureka server获取实例信息并缓存在eureka client，如果用ribbon调用的话也会在ribbon内缓存一份实例信息。</p>
<p><img src="http://image.sunshanpeng.com/201909061114_23.png" style="zoom:60%;"></p>
<h4 id="Eureka-Client缓存"><a href="#Eureka-Client缓存" class="headerlink" title="Eureka Client缓存"></a>Eureka Client缓存</h4><p>Eureka Client的缓存放在<code>com.netflix.discovery.shared.Applications#appNameApplicationMap</code>中，<code>appNameApplicationMap</code>的数据结构是<code>Map&lt;String, Application&gt;</code>，key是appName。</p>
<p>应用启动初始化<code>com.netflix.discovery.DiscoveryClient</code>的时候会全量拉取一次服务信息，后面增量获取。</p>
<p><code>com.netflix.discovery.DiscoveryClient#initScheduledTasks</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (clientConfig.shouldFetchRegistry()) &#123;</span><br><span class="line">          <span class="comment">// registry cache refresh timer</span></span><br><span class="line">          <span class="keyword">int</span> registryFetchIntervalSeconds = clientConfig.getRegistryFetchIntervalSeconds();</span><br><span class="line">          <span class="keyword">int</span> expBackOffBound = clientConfig.getCacheRefreshExecutorExponentialBackOffBound();</span><br><span class="line">          scheduler.schedule(</span><br><span class="line">                  <span class="keyword">new</span> TimedSupervisorTask(</span><br><span class="line">                          <span class="string">"cacheRefresh"</span>,</span><br><span class="line">                          scheduler,</span><br><span class="line">                          cacheRefreshExecutor,</span><br><span class="line">                          registryFetchIntervalSeconds,</span><br><span class="line">                          TimeUnit.SECONDS,</span><br><span class="line">                          expBackOffBound,</span><br><span class="line">                          <span class="keyword">new</span> CacheRefreshThread()</span><br><span class="line">                  ),</span><br><span class="line">                  registryFetchIntervalSeconds, TimeUnit.SECONDS);</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>registryFetchIntervalSeconds</code>是eureka client从eureka server同步实例信息的时间，默认30S。</strong></p>
<p>核心代码：<code>com.netflix.discovery.DiscoveryClient#fetchRegistry</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">fetchRegistry</span><span class="params">(<span class="keyword">boolean</span> forceFullRegistryFetch)</span> </span>&#123;</span><br><span class="line">    Stopwatch tracer = FETCH_REGISTRY_TIMER.start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// If the delta is disabled or if it is the first time, get all</span></span><br><span class="line">        <span class="comment">// applications</span></span><br><span class="line">        Applications applications = getApplications();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (clientConfig.shouldDisableDelta()</span><br><span class="line">                || (!Strings.isNullOrEmpty(clientConfig.getRegistryRefreshSingleVipAddress()))</span><br><span class="line">                || forceFullRegistryFetch</span><br><span class="line">                || (applications == <span class="keyword">null</span>)</span><br><span class="line">                || (applications.getRegisteredApplications().size() == <span class="number">0</span>)</span><br><span class="line">                || (applications.getVersion() == -<span class="number">1</span>)) <span class="comment">//Client application does not have latest library supporting delta</span></span><br><span class="line">        &#123;</span><br><span class="line">            logger.info(<span class="string">"Disable delta property : &#123;&#125;"</span>, clientConfig.shouldDisableDelta());</span><br><span class="line">            logger.info(<span class="string">"Single vip registry refresh property : &#123;&#125;"</span>, clientConfig.getRegistryRefreshSingleVipAddress());</span><br><span class="line">            logger.info(<span class="string">"Force full registry fetch : &#123;&#125;"</span>, forceFullRegistryFetch);</span><br><span class="line">            logger.info(<span class="string">"Application is null : &#123;&#125;"</span>, (applications == <span class="keyword">null</span>));</span><br><span class="line">            logger.info(<span class="string">"Registered Applications size is zero : &#123;&#125;"</span>,</span><br><span class="line">                    (applications.getRegisteredApplications().size() == <span class="number">0</span>));</span><br><span class="line">            logger.info(<span class="string">"Application version is -1: &#123;&#125;"</span>, (applications.getVersion() == -<span class="number">1</span>));</span><br><span class="line">            <span class="comment">//全量获取</span></span><br><span class="line">            getAndStoreFullRegistry();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//增量获取</span></span><br><span class="line">            getAndUpdateDelta(applications);</span><br><span class="line">        &#125;</span><br><span class="line">        applications.setAppsHashCode(applications.getReconcileHashCode());</span><br><span class="line">        logTotalInstances();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        logger.error(PREFIX + appPathIdentifier + <span class="string">" - was unable to refresh its cache! status = "</span> + e.getMessage(), e);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (tracer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            tracer.stop();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Notify about cache refresh before updating the instance remote status</span></span><br><span class="line">    onCacheRefreshed();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update remote status based on refreshed data held in the cache</span></span><br><span class="line">    updateInstanceRemoteStatus();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// registry was fetched successfully, so return true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Ribbon缓存"><a href="#Ribbon缓存" class="headerlink" title="Ribbon缓存"></a>Ribbon缓存</h4><p>Ribbon的缓存放在<code>com.netflix.loadbalancer.BaseLoadBalancer#allServerList</code>中，应用启动的时候调用<code>com.netflix.loadbalancer.PollingServerListUpdater#start</code>启动一个更新ribbon缓存的定时任务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> UpdateAction updateAction)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isActive.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">final</span> Runnable wrapperRunnable = <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (!isActive.get()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (scheduledFuture != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            scheduledFuture.cancel(<span class="keyword">true</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        updateAction.doUpdate();</span><br><span class="line">                        lastUpdated = System.currentTimeMillis();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        logger.warn(<span class="string">"Failed one update cycle"</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            scheduledFuture = getRefreshExecutor().scheduleWithFixedDelay(</span><br><span class="line">                    wrapperRunnable,</span><br><span class="line">                    initialDelayMs,</span><br><span class="line">                    refreshIntervalMs,</span><br><span class="line">                    TimeUnit.MILLISECONDS</span><br><span class="line">            );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.info(<span class="string">"Already active, no-op"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong><code>refreshIntervalMs</code>是ribbon缓存的刷新时间，可以配置单个应用的刷新时间<code>aim-ms.ribbon.ServerListRefreshInterval</code>，也可以配置全局的刷新时间<code>ribbon.ServerListRefreshInterval</code>，都不配置的话默认是30S</strong>。</p>
<p>获取配置代码:<code>com.netflix.loadbalancer.PollingServerListUpdater</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">PollingServerListUpdater</span><span class="params">(IClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>(LISTOFSERVERS_CACHE_UPDATE_DELAY, getRefreshIntervalMs(clientConfig));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getRefreshIntervalMs</span><span class="params">(IClientConfig clientConfig)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> clientConfig.get(CommonClientConfigKey.ServerListRefreshInterval, LISTOFSERVERS_CACHE_REPEAT_INTERVAL);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>com.netflix.client.config.DefaultClientConfigImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(IClientConfigKey&lt;T&gt; key, T defaultValue)</span> </span>&#123;</span><br><span class="line">      T value = get(key);</span><br><span class="line">      <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">          value = defaultValue;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">get</span><span class="params">(IClientConfigKey&lt;T&gt; key)</span> </span>&#123;</span><br><span class="line">      Object obj = getProperty(key.key());</span><br><span class="line">      <span class="keyword">if</span> (obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      Class&lt;T&gt; type = key.type();</span><br><span class="line">      <span class="keyword">if</span> (type.isInstance(obj)) &#123;</span><br><span class="line">          <span class="keyword">return</span> type.cast(obj);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">              String stringValue = (String) obj;</span><br><span class="line">              <span class="keyword">if</span> (Integer.class.equals(type)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> (T) Integer.valueOf(stringValue);</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Boolean.class.equals(type)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> (T) Boolean.valueOf(stringValue);</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Float.class.equals(type)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> (T) Float.valueOf(stringValue);</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Long.class.equals(type)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> (T) Long.valueOf(stringValue);</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Double.class.equals(type)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> (T) Double.valueOf(stringValue);</span><br><span class="line">              &#125; <span class="keyword">else</span> <span class="keyword">if</span> (TimeUnit.class.equals(type)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> (T) TimeUnit.valueOf(stringValue);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to convert string value to desired type "</span> + type);</span><br><span class="line">          &#125;</span><br><span class="line">           </span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to convert value to desired type "</span> + type);</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Object <span class="title">getProperty</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (enableDynamicProperties) &#123;</span><br><span class="line">          String dynamicValue = <span class="keyword">null</span>;</span><br><span class="line">          DynamicStringProperty dynamicProperty = dynamicProperties.get(key);</span><br><span class="line">          <span class="keyword">if</span> (dynamicProperty != <span class="keyword">null</span>) &#123;</span><br><span class="line">              dynamicValue = dynamicProperty.get();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (dynamicValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">              dynamicValue = DynamicProperty.getInstance(getConfigKey(key)).getString();</span><br><span class="line">              <span class="keyword">if</span> (dynamicValue == <span class="keyword">null</span>) &#123;</span><br><span class="line">                  dynamicValue = DynamicProperty.getInstance(getDefaultPropName(key)).getString();</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (dynamicValue != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">return</span> dynamicValue;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> properties.get(key);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>刷新缓存代码：<code>com.netflix.loadbalancer.BaseLoadBalancer</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServersList</span><span class="params">(List lsrv)</span> </span>&#123;</span><br><span class="line">    Lock writeLock = allServerLock.writeLock();</span><br><span class="line">    logger.debug(<span class="string">"LoadBalancer [&#123;&#125;]: clearing server list (SET op)"</span>, name);</span><br><span class="line">    </span><br><span class="line">    ArrayList&lt;Server&gt; newServers = <span class="keyword">new</span> ArrayList&lt;Server&gt;();</span><br><span class="line">    writeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ArrayList&lt;Server&gt; allServers = <span class="keyword">new</span> ArrayList&lt;Server&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Object server : lsrv) &#123;</span><br><span class="line">            <span class="keyword">if</span> (server == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">                server = <span class="keyword">new</span> Server((String) server);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (server <span class="keyword">instanceof</span> Server) &#123;</span><br><span class="line">                logger.debug(<span class="string">"LoadBalancer [&#123;&#125;]:  addServer [&#123;&#125;]"</span>, name, ((Server) server).getId());</span><br><span class="line">                allServers.add((Server) server);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                        <span class="string">"Type String or Server expected, instead found:"</span></span><br><span class="line">                                + server.getClass());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> listChanged = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!allServerList.equals(allServers)) &#123;</span><br><span class="line">            listChanged = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (changeListeners != <span class="keyword">null</span> &amp;&amp; changeListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">               List&lt;Server&gt; oldList = ImmutableList.copyOf(allServerList);</span><br><span class="line">               List&lt;Server&gt; newList = ImmutableList.copyOf(allServers);                   </span><br><span class="line">               <span class="keyword">for</span> (ServerListChangeListener l: changeListeners) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       l.serverListChanged(oldList, newList);</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                       logger.error(<span class="string">"LoadBalancer [&#123;&#125;]: Error invoking server list change listener"</span>, name, e);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (isEnablePrimingConnections()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Server server : allServers) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!allServerList.contains(server)) &#123;</span><br><span class="line">                    server.setReadyToServe(<span class="keyword">false</span>);</span><br><span class="line">                    newServers.add((Server) server);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (primeConnections != <span class="keyword">null</span>) &#123;</span><br><span class="line">                primeConnections.primeConnectionsAsync(newServers, <span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// This will reset readyToServe flag to true on all servers</span></span><br><span class="line">        <span class="comment">// regardless whether</span></span><br><span class="line">        <span class="comment">// previous priming connections are success or not</span></span><br><span class="line">        allServerList = allServers;</span><br><span class="line">        <span class="keyword">if</span> (canSkipPing()) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Server s : allServerList) &#123;</span><br><span class="line">                s.setAlive(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            upServerList = allServerList;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listChanged) &#123;</span><br><span class="line">            forceQuickPing();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        writeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取应用实例"><a href="#获取应用实例" class="headerlink" title="获取应用实例"></a>获取应用实例</h3><p><img src="http://image.sunshanpeng.com/201909061120_303.png" style="zoom:60%;"></p>
<p>eureka server入口：<code>com.netflix.eureka.resources.ApplicationsResource#getContainers</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GET</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getContainers</span><span class="params">(@PathParam(<span class="string">"version"</span>)</span> String version,</span></span><br><span class="line"><span class="function">                              @<span class="title">HeaderParam</span><span class="params">(HEADER_ACCEPT)</span> String acceptHeader,</span></span><br><span class="line"><span class="function">                              @<span class="title">HeaderParam</span><span class="params">(HEADER_ACCEPT_ENCODING)</span> String acceptEncoding,</span></span><br><span class="line"><span class="function">                              @<span class="title">HeaderParam</span><span class="params">(EurekaAccept.HTTP_X_EUREKA_ACCEPT)</span> String eurekaAccept,</span></span><br><span class="line"><span class="function">                              @Context UriInfo uriInfo,</span></span><br><span class="line"><span class="function">                              @Nullable @<span class="title">QueryParam</span><span class="params">(<span class="string">"regions"</span>)</span> String regionsStr) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> isRemoteRegionRequested = <span class="keyword">null</span> != regionsStr &amp;&amp; !regionsStr.isEmpty();</span><br><span class="line">    String[] regions = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (!isRemoteRegionRequested) &#123;</span><br><span class="line">        EurekaMonitors.GET_ALL.increment();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        regions = regionsStr.toLowerCase().split(<span class="string">","</span>);</span><br><span class="line">        Arrays.sort(regions); <span class="comment">// So we don't have different caches for same regions queried in different order.</span></span><br><span class="line">        EurekaMonitors.GET_ALL_WITH_REMOTE_REGIONS.increment();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the server allows the access to the registry. The server can</span></span><br><span class="line">    <span class="comment">// restrict access if it is not</span></span><br><span class="line">    <span class="comment">// ready to serve traffic depending on various reasons.</span></span><br><span class="line">    <span class="keyword">if</span> (!registry.shouldAllowAccess(isRemoteRegionRequested)) &#123;</span><br><span class="line">        <span class="keyword">return</span> Response.status(Status.FORBIDDEN).build();</span><br><span class="line">    &#125;</span><br><span class="line">    CurrentRequestVersion.set(Version.toEnum(version));</span><br><span class="line">    KeyType keyType = Key.KeyType.JSON;</span><br><span class="line">    String returnMediaType = MediaType.APPLICATION_JSON;</span><br><span class="line">    <span class="keyword">if</span> (acceptHeader == <span class="keyword">null</span> || !acceptHeader.contains(HEADER_JSON_VALUE)) &#123;</span><br><span class="line">        keyType = Key.KeyType.XML;</span><br><span class="line">        returnMediaType = MediaType.APPLICATION_XML;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Key cacheKey = <span class="keyword">new</span> Key(Key.EntityType.Application,</span><br><span class="line">            ResponseCacheImpl.ALL_APPS,</span><br><span class="line">            keyType, CurrentRequestVersion.get(), EurekaAccept.fromString(eurekaAccept), regions</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    Response response;</span><br><span class="line">    <span class="keyword">if</span> (acceptEncoding != <span class="keyword">null</span> &amp;&amp; acceptEncoding.contains(HEADER_GZIP_VALUE)) &#123;</span><br><span class="line">        response = Response.ok(responseCache.getGZIP(cacheKey))</span><br><span class="line">                .header(HEADER_CONTENT_ENCODING, HEADER_GZIP_VALUE)</span><br><span class="line">                .header(HEADER_CONTENT_TYPE, returnMediaType)</span><br><span class="line">                .build();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        response = Response.ok(responseCache.get(cacheKey))</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心代码：<code>com.netflix.eureka.registry.ResponseCacheImpl#getValue</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Value <span class="title">getValue</span><span class="params">(<span class="keyword">final</span> Key key, <span class="keyword">boolean</span> useReadOnlyCache)</span> </span>&#123;</span><br><span class="line">        Value payload = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (useReadOnlyCache) &#123;</span><br><span class="line">                <span class="keyword">final</span> Value currentPayload = readOnlyCacheMap.get(key);</span><br><span class="line">                <span class="keyword">if</span> (currentPayload != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    payload = currentPayload;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    payload = readWriteCacheMap.get(key);</span><br><span class="line">                    readOnlyCacheMap.put(key, payload);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                payload = readWriteCacheMap.get(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            logger.error(<span class="string">"Cannot get value for key :"</span> + key, t);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> payload;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果<code>useReadOnlyCache</code>为true从<code>readOnlyCacheMap</code>中获取实例信息，如果false从<code>readWriteCacheMap</code>中获取实例信息，默认为true。</p>
<p>因为<code>readWriteCacheMap</code>用的<code>LoadingCache</code>有读写锁，使用<code>readOnlyCacheMap</code>可以增加吞吐量，中小集群可以关闭<code>readOnlyCacheMap</code>。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://blog.csdn.net/u012394095/article/details/80693713" target="_blank" rel="noopener">https://blog.csdn.net/u012394095/article/details/80693713</a></p>
<p><a href="http://blog.didispace.com/spring-cloud-eureka-register-detail/" target="_blank" rel="noopener">http://blog.didispace.com/spring-cloud-eureka-register-detail/</a></p>
<p><a href="https://www.infoq.cn/article/jlDJQ*3wtN2PcqTDyokh" target="_blank" rel="noopener">https://www.infoq.cn/article/jlDJQ*3wtN2PcqTDyokh</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/eureka/">eureka</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Kubernetes高可用架构" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/08/24/Kubernetes高可用架构/">Kubernetes高可用部署</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/08/24/Kubernetes高可用架构/" class="article-date">
	  <time datetime="2019-08-24T04:29:30.000Z" itemprop="datePublished">八月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h2><p><img src="http://image.sunshanpeng.com/Yrdoo02.jpg" alt="kubernetes"></p>
<p>Kubernetes分为Master Node和Worker Node，其中Master Node作为控制节点，调度管理整个系统；Worker Node作为工作节点，运行业务容器。</p>
<h3 id="Master-Node"><a href="#Master-Node" class="headerlink" title="Master Node"></a>Master Node</h3><ul>
<li><h4 id="api-server"><a href="#api-server" class="headerlink" title="api-server"></a>api-server</h4><p> 作为kubernetes系统的入口，对外暴露了Kubernetes API，封装了核心对象的增删改查操作，以RESTFul接口方式提供给外部客户和内部组件调用。它维护的REST对象将持久化到etcd(一个分布式强一致性的key/value存储)。</p>
</li>
<li><h4 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h4><p> 负责集群的资源调度，为新建的pod分配机器。这部分工作分出来变成一个组件，意味着可以很方便地替换成其他的调度器。</p>
</li>
<li><h4 id="controller-manager"><a href="#controller-manager" class="headerlink" title="controller-manager"></a>controller-manager</h4><p> 运行控制器，它们是处理集群中常规任务的后台线程。逻辑上，每个控制器是一个单独的进程，但为了降低复杂性，它们都被编译成独立的可执行文件，并在单个进程中运行。<br> 这些控制器包括:</p>
<ul>
<li>节点控制器: 当节点移除时，负责注意和响应。</li>
<li>副本控制器: 负责维护系统中每个副本控制器对象正确数量的 Pod。</li>
<li>端点控制器: 填充 端点(Endpoints) 对象(即连接 Services &amp; Pods)。</li>
<li>服务帐户和令牌控制器: 为新的命名空间创建默认帐户和 API 访问令牌</li>
</ul>
</li>
</ul>
<h3 id="Worker-Node"><a href="#Worker-Node" class="headerlink" title="Worker Node"></a>Worker Node</h3><ul>
<li><h4 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h4><p>kubelet是主要的节点代理,它监测已分配给其节点的 Pod(通过 apiserver 或通过本地配置文件)，提供如下功能:</p>
<ul>
<li>挂载 Pod 所需要的数据卷(Volume)。</li>
<li>下载 Pod 的 secrets。</li>
<li>通过 Docker 运行(或通过其他容器运行时)运行 Pod 的容器。</li>
<li>周期性的对容器生命周期进行探测。</li>
<li>如果需要，通过创建 镜像 Pod（Mirror Pod） 将 Pod 的状态报告回系统的其余部分。<br>将节点的状态报告回系统的其余部分。</li>
</ul>
</li>
<li><h4 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h4><p>通过维护主机上的网络规则并执行连接转发，实现了Kubernetes服务抽象。</p>
</li>
</ul>
<h3 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h3><p>Kubernetes 所有集群数据都存储在etcd里。</p>
<p>etcd通常部署在Master Node上，也可以单独部署。</p>
<p>官网地址：<a href="https://github.com/etcd-io/etcd" target="_blank" rel="noopener">https://github.com/etcd-io/etcd</a></p>
<h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3><p>CNI（Container Network Interface）是CNCF旗下的一个项目，由一组用于配置Linux容器的网络接口的规范和库组成，同时还包含了一些插件。CNI仅关心容器创建时的网络分配，和当容器被删除时释放网络资源。</p>
<p>每个pod都会有一个集群内唯一的IP，不同Node上的Pod可以互相访问。</p>
<p>常用的网络插件有<a href="https://github.com/projectcalico/calico" target="_blank" rel="noopener">Calico</a>和<a href="https://github.com/coreos/flannel" target="_blank" rel="noopener">Flannel</a>。</p>
<h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><p>CRI（Container Runtime Interface）是容器运行时接口，kubelet可以运行实现了CRI的各种容器运行时而不仅仅是Docker。</p>
<h2 id="高可用架构"><a href="#高可用架构" class="headerlink" title="高可用架构"></a>高可用架构</h2><p>要实现高可用，就要实现所有Node没有单点故障，任何一台服务器宕机均不影响Kubernetes的正常工作。Kubernetes的高可用主要是Master Node和存储的高可用，包括以下几个组件：</p>
<ul>
<li>etcd属于CP架构，保证一致性和分区容错性。因为其内部使用 Raft 协议进行选举，所以需要部署基数个实例，比如3、5、7个。可以和Master Node一起部署也可以外置部署。</li>
<li>controller-manager和scheduler的高可用相对容易，是基于etcd的锁进行leader election。相当于基于etcd的分布式锁，谁拿到谁干活，同时只会有一个实例在工作，部署2个及以上的实例数量。</li>
<li>api-server是无状态的，需要部署2个及以上的实例数量，然后使用HAProxy和Keepalived作为负载均衡实现高可用。除了HAProxy也可以使用Nginx或其他负载均衡策略。</li>
</ul>
<h3 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h3><p><img src="http://image.sunshanpeng.com/201908251648_290.png" alt="Kubernetes HA1"></p>
<p>使用三台4核8G的服务器当Master Node，上面部署api-server、scheduler、controller-manager、kubelet、kube-proxy、docker、calico、etcd、HAProxy、keepalived。</p>
<p>Worker Node的配置根据实际情况，最好CPU和内存的大小、比例都一样。上面部署kubelet、kube-proxy、docker、calico。</p>
<p>该方案集群内外连接api-server都是高可用，使用方便。但是公有云不能用虚拟IP所以不能用该方案。另外所有的网络请求都会集中到一台服务器（虚拟IP所在的服务器）进行转发，负载不均衡，HAProxy的上限即api-server的上限。</p>
<h3 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h3><p><img src="http://image.sunshanpeng.com/201908251741_884.png" alt="Kubernetes HA2"></p>
<p>使用三台4核8G的服务器当Master Node，上面部署api-server、scheduler、controller-manager、kubelet、kube-proxy、docker、calico、etcd。</p>
<p>Worker Node的配置根据实际情况，最好CPU和内存的大小、比例都一样。上面部署kubelet、kube-proxy、docker、calico、HAProxy。</p>
<p>该方案兼容自有机房和公有云，Master Node负载比较均衡。但是集群外访问api-server没有做到高可用，需要额外解决。如果Worker Node上的HAProxy宕机则该节点不能正常工作。另外如果添加和删除Master Node需要更新所有Worker Node的负载均衡配置（可选项，不修改也可以）。</p>
<h2 id="部署方式"><a href="#部署方式" class="headerlink" title="部署方式"></a>部署方式</h2><h3 id="二进制部署"><a href="#二进制部署" class="headerlink" title="二进制部署"></a>二进制部署</h3><p>所有组件均使用二进制文件部署，手动部署可以参考：<a href="https://github.com/opsnull/follow-me-install-kubernetes-cluster" target="_blank" rel="noopener">https://github.com/opsnull/follow-me-install-kubernetes-cluster</a>；ansible脚本部署可以用：<a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noopener">https://github.com/easzlab/kubeasz</a>。</p>
<h3 id="容器化部署"><a href="#容器化部署" class="headerlink" title="容器化部署"></a>容器化部署</h3><p>kubernetes的所有组件中，除了docker和kubelet是运行和管理容器的，其他组件都可以使用容器化的方式部署，最流行的方式就是使用kubeadm。</p>
<p>官网地址：<a href="https://github.com/kubernetes/kubeadm。" target="_blank" rel="noopener">https://github.com/kubernetes/kubeadm。</a></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://kubernetes.io/zh/docs/concepts/overview/components/" target="_blank" rel="noopener">https://kubernetes.io/zh/docs/concepts/overview/components/</a></p>
<p><a href="https://www.kubernetes.org.cn/2931.html" target="_blank" rel="noopener">https://www.kubernetes.org.cn/2931.html</a></p>
<p><a href="https://jimmysong.io/kubernetes-handbook/concepts/cni.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/concepts/cni.html</a></p>
<p><a href="https://jimmysong.io/kubernetes-handbook/concepts/cri.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/concepts/cri.html</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Docker常用命令" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/03/24/Docker常用命令/">Docker常用命令</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/03/24/Docker常用命令/" class="article-date">
	  <time datetime="2019-03-24T14:26:37.000Z" itemprop="datePublished">三月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker pull [OPTIONS] NAME[:TAG|@DIGEST]</code>，tag不写的话默认latest。</p>
<h2 id="登录镜像仓库"><a href="#登录镜像仓库" class="headerlink" title="登录镜像仓库"></a>登录镜像仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login --username sunshanpeng --password 123456 harbor.sunshanpeng.com</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker login [OPTIONS] [SERVER]</code></p>
<ul>
<li><p>SERVER为空的情况下默认登录<code>hub.docker.com</code></p>
</li>
<li><p>password建议不要显示在控制台上</p>
</li>
</ul>
<h2 id="列出所有镜像"><a href="#列出所有镜像" class="headerlink" title="列出所有镜像"></a>列出所有镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker images [OPTIONS] [REPOSITORY[:TAG]]</code>，可选参数显示全部镜像或者过滤镜像。</p>
<h2 id="列出所有容器"><a href="#列出所有容器" class="headerlink" title="列出所有容器"></a>列出所有容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker ps [OPTIONS]</code>，去掉<code>-a</code>显示运行中的容器。</p>
<h2 id="给镜像打tag"><a href="#给镜像打tag" class="headerlink" title="给镜像打tag"></a>给镜像打tag</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag mysql:5.6 harbor.sunshanpeng.com/database/mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</code></p>
<p>当我们从公共仓库拉取的镜像，想推送到我们自己搭建的私有仓库，需要先打一个tag；</p>
<p>当我们拉取不到一些需要翻墙才能拉取的镜像时，也可以从国内镜像仓库拉取镜像然后打个tag给成目标镜像。</p>
<h2 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push harbor.sunshanpeng.com/database/mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker push [OPTIONS] NAME[:TAG]</code></p>
<p>推送镜像必须先登录要推送的目标仓库，而且需要对目标仓库有推送的权限。</p>
<p>类似<code>docker push mysql:5.6</code>是不行的。</p>
<h2 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t simpleApp:v1 .</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker build [OPTIONS] PATH | URL | -</code>。</p>
<p>根据<code>Dockerfile</code>制作镜像。</p>
<h2 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker rmi [OPTIONS] IMAGE [IMAGE...]</code>，不能删除已经创建了容器的镜像，必须先删除对应容器。</p>
<h2 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run nginx</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</code></p>
<p>OPTIONS参数有很多，比较常用的如下：</p>
<ul>
<li><p><code>--name</code>指定容器名字</p>
</li>
<li><p><code>-p</code>指定容器映射宿主机的端口号</p>
</li>
<li><p><code>-e</code>指定环境变量</p>
</li>
<li><p><code>-v</code>指定挂载卷</p>
</li>
<li><p><code>-it</code>指定容器前台运行</p>
</li>
<li><p><code>-d</code>指定容器后台运行</p>
<p>其他还有很多指定IP、Hostname、CPU、内存、网络、内核参数、重启策略等等参数，可以通过<code>docker run --help</code>查询。</p>
<h3 id="mysql容器启动命令"><a href="#mysql容器启动命令" class="headerlink" title="mysql容器启动命令"></a>mysql容器启动命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 -v=/docker/mysql/data:/var/lib/mysql -v=/docker/mysql/my.cnf:/etc/mysql/my.cnf -v=/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime -d mysql:5.6</span><br></pre></td></tr></table></figure>
<h3 id="redis容器启动命令"><a href="#redis容器启动命令" class="headerlink" title="redis容器启动命令"></a>redis容器启动命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name redis -p 6379:6379 -v=/docker/redis/data:/data -d redis:3.2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="重命名容器"><a href="#重命名容器" class="headerlink" title="重命名容器"></a>重命名容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rename mysql mysql1</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker rename CONTAINER NEW_NAME</code>。</p>
<h2 id="停止容器"><a href="#停止容器" class="headerlink" title="停止容器"></a>停止容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker stop [OPTIONS] CONTAINER [CONTAINER...]</code>，停止多个容器用空格分隔容器名字或者容器id。</p>
<h2 id="强制停止容器"><a href="#强制停止容器" class="headerlink" title="强制停止容器"></a>强制停止容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">kill</span> mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker kill [OPTIONS] CONTAINER [CONTAINER...]</code>。</p>
<h2 id="启动-重启容器"><a href="#启动-重启容器" class="headerlink" title="启动/重启容器"></a>启动/重启容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start/restart mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker start/restart [OPTIONS] CONTAINER [CONTAINER...]</code>。</p>
<h2 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker rm [OPTIONS] CONTAINER [CONTAINER...]</code>，不带参数时只能删除已停止的容器，带上参数<code>-f</code>可以强制删除运行中的容器。</p>
<h2 id="更新容器"><a href="#更新容器" class="headerlink" title="更新容器"></a>更新容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update --restart always mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker update [OPTIONS] CONTAINER [CONTAINER...]</code>。</p>
<p>更新容器的重启策略、CPU和内存大小。</p>
<h2 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql /bin/bash</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</code>。</p>
<ul>
<li><p>CONTAINER 可以是容器Id或者容器名字；</p>
</li>
<li><p><code>/bin/bash</code>是进入容器后执行的命令，有些容器可能不存在<code>/bin/bash</code>。</p>
</li>
</ul>
<h2 id="导出镜像文件"><a href="#导出镜像文件" class="headerlink" title="导出镜像文件"></a>导出镜像文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o rook-ceph-093.tar rook/ceph:v0.9.3</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker save [OPTIONS] IMAGE [IMAGE...]</code>。</p>
<p>如果同时导出多个镜像到一个文件里，后面的镜像列表用空格来分隔。</p>
<h2 id="导入镜像文件"><a href="#导入镜像文件" class="headerlink" title="导入镜像文件"></a>导入镜像文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i /root/rook-ceph-093.tar</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker load [OPTIONS]</code></p>
<p>当不方便使用自建的镜像仓库来传输镜像时，可以用镜像的导出导入功能来移动镜像。</p>
<h2 id="查看容器资源消耗"><a href="#查看容器资源消耗" class="headerlink" title="查看容器资源消耗"></a>查看容器资源消耗</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker stats</span><br><span class="line">CONTAINER ID        NAME                               CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">63ebc0e88e5a        happy_volhard                      0.02%               35.3MiB / 15.46GiB    0.22%               11.5MB / 19MB       13.3MB / 45MB       22</span><br><span class="line">7ed66f584a25        redis                              0.08%               7.82MiB / 15.46GiB    0.05%               304kB / 274kB       5.59MB / 0B         3</span><br><span class="line">500eed21d914        dockercompose_mqbroker_1           2.98%               752.3MiB / 15.46GiB   4.75%               0B / 0B             3.07GB / 19GB       204</span><br><span class="line">ddd919a5bf52        dockercompose_mqnamesrv_1          0.21%               329.2MiB / 15.46GiB   2.08%               0B / 0B             60.3MB / 16.4kB     41</span><br></pre></td></tr></table></figure>
<h2 id="查看Docker占用磁盘"><a href="#查看Docker占用磁盘" class="headerlink" title="查看Docker占用磁盘"></a>查看Docker占用磁盘</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker system df</span><br><span class="line"></span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              29                  28                  8.575GB             1.873GB (21%)</span><br><span class="line">Containers          29                  17                  7.545GB             410.8MB (5%)</span><br><span class="line">Local Volumes       303                 23                  6.339GB             4.138GB (65%)</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure>
<p>可以查看镜像文件大小、容器大小、本地存储使用的磁盘大小。</p>
<h2 id="清理Docker镜像和容器"><a href="#清理Docker镜像和容器" class="headerlink" title="清理Docker镜像和容器"></a>清理Docker镜像和容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -a</span><br></pre></td></tr></table></figure>
<p>此命令会清除所有未运行的容器和清理所有未使用的镜像。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 72%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 36px; width: 100%;" placeholder=" Search…" value name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="Search">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Connect With Us</h3>
    <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="https://github.com/sunshanpeng" title="Github"><i class="fa fa-github" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Weibo"><i class="fa fa-weibo" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Facebook"><i class="fa fa-facebook" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Google-plus"><i class="fa fa-google-plus" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Instagram"><i class="fa fa-instagram" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a></li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>
		</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>Recent Posts</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/02/27/istio官方示例bookinfo/">istio官方示例bookinfo</a></h6>
              <span>二月 27, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/02/27/在K8S集群中安装istio/">在K8S集群中安装istio</a></h6>
              <span>二月 27, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/02/27/设置istioctl自动补全/">设置istioctl自动补全</a></h6>
              <span>二月 27, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2020/02/16/将ECS上的应用集成到istio/">将ECS上的应用集成到istio</a></h6>
              <span>二月 16, 2020</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/12/16/MySQL服务端配置/">MySQL服务端配置</a></h6>
              <span>十二月 16, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/12/16/MySQL开发规范/">MySQL开发规范</a></h6>
              <span>十二月 16, 2019</span>
            </div>

          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/istio/">istio</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/mysql/">mysql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/vue/">vue</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器/">容器</a><span class="category-list-count">13</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发规范/">开发规范</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/混沌工程/">混沌工程</a><span class="category-list-count">2</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/apollo/">apollo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/arthas/">arthas</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chaosBlade/">chaosBlade</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eureka/">eureka</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/idea/">idea</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/istio/">istio</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/">jenkins</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/">k8s</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs/">nodejs</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/apollo/" style="font-size: 12.5px;">apollo</a> <a href="/tags/arthas/" style="font-size: 17.5px;">arthas</a> <a href="/tags/chaosBlade/" style="font-size: 12.5px;">chaosBlade</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/eureka/" style="font-size: 12.5px;">eureka</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/idea/" style="font-size: 10px;">idea</a> <a href="/tags/istio/" style="font-size: 15px;">istio</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jenkins/" style="font-size: 10px;">jenkins</a> <a href="/tags/k8s/" style="font-size: 20px;">k8s</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/mysql/" style="font-size: 12.5px;">mysql</a> <a href="/tags/nodejs/" style="font-size: 10px;">nodejs</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>

    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/02/">二月 2020</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a><span class="archive-list-count">7</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">九月 2019</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">八月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a><span class="archive-list-count">1</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2020 阿鹏的博客 All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
