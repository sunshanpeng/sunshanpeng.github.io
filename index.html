<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>Page 1 | 阿鹏的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  
  <meta name="description" content="java go devops kubernetes docker">
<meta name="keywords" content="java go devops kubernetes docker">
<meta property="og:type" content="website">
<meta property="og:title" content="阿鹏的博客">
<meta property="og:url" content="http://www.sunshanpeng.com/index.html">
<meta property="og:site_name" content="阿鹏的博客">
<meta property="og:description" content="java go devops kubernetes docker">
<meta property="og:locale" content="zh_CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="阿鹏的博客">
<meta name="twitter:description" content="java go devops kubernetes docker">
  
    <link rel="alternate" href="/atom.xml" title="阿鹏的博客" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">

  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Oswald%3A300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css">
  <link rel="stylesheet" href="/css/fashion.css">
  <link rel="stylesheet" href="/css/glyphs.css">

</head>
</html>


  <body>


  
  
  <div class="site-header-image">
    <img id="originBg" width="100%" alt="Hike News" src>
  </div>

  <div id="header-blur" class="site-header-image blur" style="position: absolute; top:0; height: 207px; min-height: 207px; min-width: 100%;">
    <img id="blurBg" width="100%" style="top: 96%" alt="Hike News" src>
  </div>

  <script>
        var imgUrls = "css/images/pose01.jpg,https://source.unsplash.com/collection/954550/1920x1080,https://source.unsplash.com/collection/954550/1920x1081".split(",");
        var random = Math.floor((Math.random() * imgUrls.length ));
        if (imgUrls[random].startsWith('http') || imgUrls[random].indexOf('://') >= 0) {
          document.getElementById("originBg").src=imgUrls[random];
          document.getElementById("blurBg").src=imgUrls[random];
        } else {
          document.getElementById("originBg").src='/' + imgUrls[random];
          document.getElementById("blurBg").src='/' + imgUrls[random];
        }
    </script>




<header id="allheader" class="site-header" role="banner" style="width: 100%; position: absolute; top:0; background: rgba(255,255,255,.8);">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            
              <a href="/" title="阿鹏的博客" rel="home"> 阿鹏的博客 </a>
            
          </h1>
          
          
            <div class="site-description">java go devops kubernetes docker</div>
          
            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>

            <div class="clearfix sf-menu">
              <ul id="main-nav" class="menu sf-js-enabled sf-arrows" style="touch-action: pan-y;">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/">Home</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/archives">Archives</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/categories">Categories</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/tags">Tags</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class href="/about">About</a> </li>
                    
              </ul>
            </div>
          </nav>

      </div>
  </div>
</header>


  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-Docker常用命令" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/03/24/Docker常用命令/">Docker常用命令</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/03/24/Docker常用命令/" class="article-date">
	  <time datetime="2019-03-24T14:26:37.000Z" itemprop="datePublished">三月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="拉取镜像"><a href="#拉取镜像" class="headerlink" title="拉取镜像"></a>拉取镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker pull [OPTIONS] NAME[:TAG|@DIGEST]</code>，tag不写的话默认latest。</p>
<h2 id="登录镜像仓库"><a href="#登录镜像仓库" class="headerlink" title="登录镜像仓库"></a>登录镜像仓库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login --username sunshanpeng --password 123456 harbor.sunshanpeng.com</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker login [OPTIONS] [SERVER]</code></p>
<ul>
<li><p>SERVER为空的情况下默认登录<code>hub.docker.com</code></p>
</li>
<li><p>password建议不要显示在控制台上</p>
</li>
</ul>
<h2 id="列出所有镜像"><a href="#列出所有镜像" class="headerlink" title="列出所有镜像"></a>列出所有镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker images [OPTIONS] [REPOSITORY[:TAG]]</code>，可选参数显示全部镜像或者过滤镜像。</p>
<h2 id="列出所有容器"><a href="#列出所有容器" class="headerlink" title="列出所有容器"></a>列出所有容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker ps [OPTIONS]</code>，去掉<code>-a</code>显示运行中的容器。</p>
<h2 id="给镜像打tag"><a href="#给镜像打tag" class="headerlink" title="给镜像打tag"></a>给镜像打tag</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker tag mysql:5.6 harbor.sunshanpeng.com/database/mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</code></p>
<p>当我们从公共仓库拉取的镜像，想推送到我们自己搭建的私有仓库，需要先打一个tag；</p>
<p>当我们拉取不到一些需要翻墙才能拉取的镜像时，也可以从国内镜像仓库拉取镜像然后打个tag给成目标镜像。</p>
<h2 id="推送镜像"><a href="#推送镜像" class="headerlink" title="推送镜像"></a>推送镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push harbor.sunshanpeng.com/database/mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker push [OPTIONS] NAME[:TAG]</code></p>
<p>推送镜像必须先登录要推送的目标仓库，而且需要对目标仓库有推送的权限。</p>
<p>类似<code>docker push mysql:5.6</code>是不行的。</p>
<h2 id="制作镜像"><a href="#制作镜像" class="headerlink" title="制作镜像"></a>制作镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t simpleApp:v1 .</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker build [OPTIONS] PATH | URL | -</code>。</p>
<p>根据<code>Dockerfile</code>制作镜像。</p>
<h2 id="删除镜像"><a href="#删除镜像" class="headerlink" title="删除镜像"></a>删除镜像</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi mysql:5.6</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker rmi [OPTIONS] IMAGE [IMAGE...]</code>，不能删除已经创建了容器的镜像，必须先删除对应容器。</p>
<h2 id="运行容器"><a href="#运行容器" class="headerlink" title="运行容器"></a>运行容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run nginx</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker run [OPTIONS] IMAGE [COMMAND] [ARG...]</code></p>
<p>OPTIONS参数有很多，比较常用的如下：</p>
<ul>
<li><p><code>--name</code>指定容器名字</p>
</li>
<li><p><code>-p</code>指定容器映射宿主机的端口号</p>
</li>
<li><p><code>-e</code>指定环境变量</p>
</li>
<li><p><code>-v</code>指定挂载卷</p>
</li>
<li><p><code>-it</code>指定容器前台运行</p>
</li>
<li><p><code>-d</code>指定容器后台运行</p>
<p>其他还有很多指定IP、Hostname、CPU、内存、网络、内核参数、重启策略等等参数，可以通过<code>docker run --help</code>查询。</p>
<h3 id="mysql容器启动命令"><a href="#mysql容器启动命令" class="headerlink" title="mysql容器启动命令"></a>mysql容器启动命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 -v=/docker/mysql/lib:/var/lib/mysql -v=/docker/mysql/my.cnf:/etc/mysql/my.cnf -v=/usr/share/zoneinfo/Asia/Shanghai:/etc/localtime -d mysql:5.6</span><br></pre></td></tr></table></figure>
<h3 id="redis容器启动命令"><a href="#redis容器启动命令" class="headerlink" title="redis容器启动命令"></a>redis容器启动命令</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name redis -p 6379:6379 /docker/redis/data:/data -d redis:3.2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="重命名容器"><a href="#重命名容器" class="headerlink" title="重命名容器"></a>重命名容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rename mysql mysql1</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker rename CONTAINER NEW_NAME</code>。</p>
<h2 id="停止容器"><a href="#停止容器" class="headerlink" title="停止容器"></a>停止容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker stop [OPTIONS] CONTAINER [CONTAINER...]</code>，停止多个容器用空格分隔容器名字或者容器id。</p>
<h2 id="强制停止容器"><a href="#强制停止容器" class="headerlink" title="强制停止容器"></a>强制停止容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">kill</span> mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker kill [OPTIONS] CONTAINER [CONTAINER...]</code>。</p>
<h2 id="启动-重启容器"><a href="#启动-重启容器" class="headerlink" title="启动/重启容器"></a>启动/重启容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start/restart mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker start/restart [OPTIONS] CONTAINER [CONTAINER...]</code>。</p>
<h2 id="删除容器"><a href="#删除容器" class="headerlink" title="删除容器"></a>删除容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker rm [OPTIONS] CONTAINER [CONTAINER...]</code>，不带参数时只能删除已停止的容器，带上参数<code>-f</code>可以强制删除运行中的容器。</p>
<h2 id="更新容器"><a href="#更新容器" class="headerlink" title="更新容器"></a>更新容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker update --restart always mysql</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker update [OPTIONS] CONTAINER [CONTAINER...]</code>。</p>
<p>更新容器的重启策略、CPU和内存大小。</p>
<h2 id="进入容器"><a href="#进入容器" class="headerlink" title="进入容器"></a>进入容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mysql /bin/bash</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</code>。</p>
<ul>
<li><p>CONTAINER 可以是容器Id或者容器名字；</p>
</li>
<li><p><code>/bin/bash</code>是进入容器后执行的命令，有些容器可能不存在<code>/bin/bash</code>。</p>
</li>
</ul>
<h2 id="导出镜像文件"><a href="#导出镜像文件" class="headerlink" title="导出镜像文件"></a>导出镜像文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o rook-ceph-093.tar rook/ceph:v0.9.3</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker save [OPTIONS] IMAGE [IMAGE...]</code>。</p>
<p>如果同时导出多个镜像到一个文件里，后面的镜像列表用空格来分隔。</p>
<h2 id="导入镜像文件"><a href="#导入镜像文件" class="headerlink" title="导入镜像文件"></a>导入镜像文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i /root/rook-ceph-093.tar</span><br></pre></td></tr></table></figure>
<p>格式：<code>docker load [OPTIONS]</code></p>
<p>当不方便使用自建的镜像仓库来传输镜像时，可以用镜像的导出导入功能来移动镜像。</p>
<h2 id="查看容器资源消耗"><a href="#查看容器资源消耗" class="headerlink" title="查看容器资源消耗"></a>查看容器资源消耗</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker stats</span><br><span class="line">CONTAINER ID        NAME                               CPU %               MEM USAGE / LIMIT     MEM %               NET I/O             BLOCK I/O           PIDS</span><br><span class="line">63ebc0e88e5a        happy_volhard                      0.02%               35.3MiB / 15.46GiB    0.22%               11.5MB / 19MB       13.3MB / 45MB       22</span><br><span class="line">7ed66f584a25        redis                              0.08%               7.82MiB / 15.46GiB    0.05%               304kB / 274kB       5.59MB / 0B         3</span><br><span class="line">500eed21d914        dockercompose_mqbroker_1           2.98%               752.3MiB / 15.46GiB   4.75%               0B / 0B             3.07GB / 19GB       204</span><br><span class="line">ddd919a5bf52        dockercompose_mqnamesrv_1          0.21%               329.2MiB / 15.46GiB   2.08%               0B / 0B             60.3MB / 16.4kB     41</span><br></pre></td></tr></table></figure>
<h2 id="查看Docker占用磁盘"><a href="#查看Docker占用磁盘" class="headerlink" title="查看Docker占用磁盘"></a>查看Docker占用磁盘</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker system df</span><br><span class="line"></span><br><span class="line">TYPE                TOTAL               ACTIVE              SIZE                RECLAIMABLE</span><br><span class="line">Images              29                  28                  8.575GB             1.873GB (21%)</span><br><span class="line">Containers          29                  17                  7.545GB             410.8MB (5%)</span><br><span class="line">Local Volumes       303                 23                  6.339GB             4.138GB (65%)</span><br><span class="line">Build Cache         0                   0                   0B                  0B</span><br></pre></td></tr></table></figure>
<p>可以查看镜像文件大小、容器大小、本地存储使用的磁盘大小。</p>
<h2 id="清理Docker镜像和容器"><a href="#清理Docker镜像和容器" class="headerlink" title="清理Docker镜像和容器"></a>清理Docker镜像和容器</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker system prune -a</span><br></pre></td></tr></table></figure>
<p>此命令会清除所有未运行的容器和清理所有未使用的镜像。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Kubernetes集群配置优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/03/24/Kubernetes集群配置优化/">Kubernetes集群配置优化</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/03/24/Kubernetes集群配置优化/" class="article-date">
	  <time datetime="2019-03-24T14:26:37.000Z" itemprop="datePublished">三月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、Docker配置"><a href="#一、Docker配置" class="headerlink" title="一、Docker配置"></a>一、Docker配置</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>],</span><br><span class="line">    <span class="attr">"log-driver"</span>: <span class="string">"json-file"</span>,</span><br><span class="line">    <span class="attr">"log-opts"</span>: &#123;</span><br><span class="line">        <span class="attr">"max-size"</span>: <span class="string">"100m"</span>,</span><br><span class="line">        <span class="attr">"max-file"</span>: <span class="string">"10"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"bip"</span>: <span class="string">"169.254.123.1/24"</span>,</span><br><span class="line">    <span class="attr">"oom-score-adjust"</span>: <span class="number">-1000</span>,</span><br><span class="line">    <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://registry.docker-cn.com"</span>, <span class="string">"https://docker.mirrors.ustc.edu.cn"</span>],</span><br><span class="line">    <span class="attr">"storage-driver"</span>: <span class="string">"overlay2"</span>,</span><br><span class="line">    <span class="attr">"storage-opts"</span>:[<span class="string">"overlay2.override_kernel_check=true"</span>],</span><br><span class="line">    <span class="attr">"data-root"</span>: <span class="string">"/var/lib/docker"</span>,</span><br><span class="line">    <span class="attr">"live-restore"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="data-root"><a href="#data-root" class="headerlink" title="data-root"></a>data-root</h3><p>设置存储持久数据和资源配置的目录，默认值<code>/var/lib/docker</code>，<strong>17.05.0</strong>以下版本参数为：<code>graph</code>。</p>
<blockquote>
<p>如果只有一个系统盘可以不用指定该参数，如果有数据盘并且数据盘不是<code>/var</code>，则需要指定数据目录。</p>
</blockquote>
<h3 id="registry-mirrors"><a href="#registry-mirrors" class="headerlink" title="registry-mirrors"></a>registry-mirrors</h3><p>镜像仓库地址，用于镜像加速。</p>
<blockquote>
<p>直接连接国外dockerHub拉取镜像速度太慢，一般都会配置国内的镜像地址。</p>
</blockquote>
<h3 id="bip"><a href="#bip" class="headerlink" title="bip"></a>bip</h3><p>设置docker0网桥地址，默认是<code>172.17.0.1/16</code>。</p>
<blockquote>
<p>默认网段有可能和现有服务器的网段冲突，建议设置成<code>169.254.123.1/24</code></p>
</blockquote>
<h3 id="live-restore"><a href="#live-restore" class="headerlink" title="live-restore"></a>live-restore</h3><p>当docker daemon停止时，让容器继续运行，默认<code>false</code>关闭，设为<code>true</code>打开。</p>
<blockquote>
<p>默认情况下重启或者关闭docker daemon时，容器都会停止，通过设置live-restore让容器继续运行，在修改docker配置或者升级docker的时候很有用。（如果daemon重启之后使用了不同的bip或不同的data-root，则live restore无法正常工作）</p>
</blockquote>
<h3 id="log-opts"><a href="#log-opts" class="headerlink" title="log-opts"></a>log-opts</h3><p>docker日志设置，默认为空。</p>
<blockquote>
<p>不设置最大值的话日志文件可能会撑爆硬盘。</p>
</blockquote>
<h3 id="exec-opts"><a href="#exec-opts" class="headerlink" title="exec-opts"></a>exec-opts</h3><p>设置docker cgroup驱动。</p>
<blockquote>
<p>需要注意docker的Cgroups和kubelet的Cgroups配置是否一致。</p>
</blockquote>
<h2 id="二、Kubelet配置"><a href="#二、Kubelet配置" class="headerlink" title="二、Kubelet配置"></a>二、Kubelet配置</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf </span><br><span class="line">--kubeconfig=/etc/kubernetes/kubelet.conf </span><br><span class="line">--pod-manifest-path=/etc/kubernetes/manifests </span><br><span class="line">--allow-privileged=true --network-plugin=cni </span><br><span class="line">--cni-conf-dir=/etc/cni/net.d </span><br><span class="line">--cni-bin-dir=/opt/cni/bin </span><br><span class="line">--cluster-dns=192.168.176.10 </span><br><span class="line">--pod-infra-container-image=registry-vpc.cn-shanghai.aliyuncs.com/acs/pause-amd64:3.1 </span><br><span class="line">--enable-controller-attach-detach=false </span><br><span class="line">--enable-load-reader </span><br><span class="line">--cluster-domain=cluster.local </span><br><span class="line">--cloud-provider=external </span><br><span class="line">--hostname-override=$(NODE_NAME)</span><br><span class="line">--provider-id=cn-shanghai.i-uf657oy682jirk1oad62 </span><br><span class="line">--authorization-mode=Webhook </span><br><span class="line">--client-ca-file=/etc/kubernetes/pki/ca.crt </span><br><span class="line">--system-reserved=memory=300Mi </span><br><span class="line">--kube-reserved=memory=400Mi </span><br><span class="line">--eviction-hard=imagefs.available&lt;15%,memory.available&lt;300Mi,nodefs.available&lt;10%,nodefs.inodesFree&lt;5% </span><br><span class="line">--cgroup-driver=systemd </span><br><span class="line">--anonymous-auth=false </span><br><span class="line">--rotate-certificates=true </span><br><span class="line">--cert-dir=/var/lib/kubelet/pki</span><br><span class="line">--root-dir=/var/lib/kubelet</span><br></pre></td></tr></table></figure>
<h3 id="pod-infra-container-image"><a href="#pod-infra-container-image" class="headerlink" title="pod-infra-container-image"></a>pod-infra-container-image</h3><p>基础镜像，默认使用的<code>k8s.gcr.io/pause-amd64:3.1</code>需要翻墙，可以使用国内镜像或者自己上传的镜像。</p>
<h3 id="root-dir"><a href="#root-dir" class="headerlink" title="root-dir"></a>root-dir</h3><p>设置存储持久数据和资源配置的目录，默认值<code>/var/lib/kubelet</code>。</p>
<blockquote>
<p>用法同Docker的data-root参数。</p>
</blockquote>
<h3 id="cgroup-driver"><a href="#cgroup-driver" class="headerlink" title="cgroup-driver"></a>cgroup-driver</h3><p>设置kubelet Cgroups驱动。</p>
<blockquote>
<p>需要注意docker的Cgroups和kubelet的Cgroups配置是否一致。</p>
</blockquote>
<h3 id="system-reserved"><a href="#system-reserved" class="headerlink" title="system-reserved"></a>system-reserved</h3><p>给系统保留的资源大小，可以设置CPU、内存、硬盘。</p>
<h3 id="kube-reserved"><a href="#kube-reserved" class="headerlink" title="kube-reserved"></a>kube-reserved</h3><p>给kubernetes保留的资源大小，可以设置CPU、内存、硬盘。</p>
<h3 id="eviction-hard"><a href="#eviction-hard" class="headerlink" title="eviction-hard"></a>eviction-hard</h3><p>驱逐条件，当节点资源小于设置的驱逐条件时，kubelet开始驱逐Pod。</p>
<h2 id="三、Kube-proxy"><a href="#三、Kube-proxy" class="headerlink" title="三、Kube-proxy"></a>三、Kube-proxy</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- --proxy-mode=ipvs</span><br><span class="line">- --kubeconfig=/var/lib/kube-proxy/kubeconfig.conf</span><br><span class="line">- --cluster-cidr=172.17.0.0/18</span><br><span class="line">- --hostname-override=$(NODE_NAME)</span><br></pre></td></tr></table></figure>
<h3 id="proxy-mode"><a href="#proxy-mode" class="headerlink" title="proxy-mode"></a>proxy-mode</h3><p>ipvs可以大大提高性能。</p>
<h2 id="参考资料："><a href="#参考资料：" class="headerlink" title="参考资料："></a>参考资料：</h2><ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/dockerd/" target="_blank" rel="noopener">https://docs.docker.com/engine/reference/commandline/dockerd/</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/administer-cluster/reserve-compute-resources/</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/administer-cluster/out-of-resource/</a></li>
<li><a href="https://docs.docker.com/engine/deprecated/" target="_blank" rel="noopener">https://docs.docker.com/engine/deprecated/</a></li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Windows电脑本地开发时连接Apollo配置中心启动慢" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/03/24/Windows电脑本地开发时连接Apollo配置中心启动慢/">Windows电脑本地开发时连接Apollo配置中心启动慢</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/03/24/Windows电脑本地开发时连接Apollo配置中心启动慢/" class="article-date">
	  <time datetime="2019-03-24T14:26:37.000Z" itemprop="datePublished">三月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="表现："><a href="#表现：" class="headerlink" title="表现："></a>表现：</h3><p>启动时中间停顿了10秒左右</p>
<p><img src="http://image.sunshanpeng.com/201908181151_8.png" alt="start"></p>
<h3 id="原因："><a href="#原因：" class="headerlink" title="原因："></a>原因：</h3><p>电脑上网卡太多</p>
<p><img src="http://image.sunshanpeng.com/201908181156_911.png" alt="ip"></p>
<p><img src="http://image.sunshanpeng.com/201908181158_629.png" alt></p>
<h3 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h3><ol>
<li><p>禁用多余网卡</p>
</li>
<li><p>在启动参数指定本机IP：<code>-Dhost.ip=10.208.202.251</code></p>
<blockquote>
<p>10.208.202.251改成自己的IP地址</p>
</blockquote>
</li>
</ol>
<h3 id="原理："><a href="#原理：" class="headerlink" title="原理："></a>原理：</h3><p>指定本机IP后就会跳过查找有效IP这一步</p>
<h3 id="具体代码"><a href="#具体代码" class="headerlink" title="具体代码"></a>具体代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ctrip.framework.foundation.internals;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.Inet4Address;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.NetworkInterface;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketException;</span><br><span class="line"><span class="keyword">import</span> java.net.UnknownHostException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.Enumeration;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Objects;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> NetworkInterfaceManager &#123;</span><br><span class="line">  INSTANCE;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> InetAddress m_local;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> InetAddress m_localHost;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">NetworkInterfaceManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    load();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> InetAddress <span class="title">findValidateIp</span><span class="params">(List&lt;InetAddress&gt; addresses)</span> </span>&#123;</span><br><span class="line">    InetAddress local = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">int</span> maxWeight = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (InetAddress address : addresses) &#123;</span><br><span class="line">      <span class="keyword">if</span> (address <span class="keyword">instanceof</span> Inet4Address) &#123;</span><br><span class="line">        <span class="keyword">int</span> weight = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (address.isSiteLocalAddress()) &#123;</span><br><span class="line">          weight += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (address.isLinkLocalAddress()) &#123;</span><br><span class="line">          weight += <span class="number">4</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (address.isLoopbackAddress()) &#123;</span><br><span class="line">          weight += <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// has host name</span></span><br><span class="line">        <span class="comment">// TODO fix performance issue when calling getHostName</span></span><br><span class="line">        <span class="keyword">if</span> (!Objects.equals(address.getHostName(), address.getHostAddress())) &#123;</span><br><span class="line">          weight += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (weight &gt; maxWeight) &#123;</span><br><span class="line">          maxWeight = weight;</span><br><span class="line">          local = address;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> local;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getLocalHostAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> m_local.getHostAddress();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getLocalHostName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == m_localHost) &#123;</span><br><span class="line">        m_localHost = InetAddress.getLocalHost();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> m_localHost.getHostName();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnknownHostException e) &#123;</span><br><span class="line">      <span class="keyword">return</span> m_local.getHostName();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> String <span class="title">getProperty</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">    String value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    value = System.getProperty(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">      value = System.getenv(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">load</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String ip = getProperty(<span class="string">"host.ip"</span>);<span class="comment">//除了启动参数也可以在环境变量中指定host.ip</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ip != <span class="keyword">null</span>) &#123;<span class="comment">//如果指定了host.ip就直接拿指定IP的网卡信息</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        m_local = InetAddress.getByName(ip);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        System.err.println(e);</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Enumeration&lt;NetworkInterface&gt; interfaces = NetworkInterface.getNetworkInterfaces();</span><br><span class="line">      List&lt;NetworkInterface&gt; nis = interfaces == <span class="keyword">null</span> ? Collections.&lt;NetworkInterface&gt;emptyList() : Collections.list(interfaces);</span><br><span class="line">      List&lt;InetAddress&gt; addresses = <span class="keyword">new</span> ArrayList&lt;InetAddress&gt;();</span><br><span class="line">      InetAddress local = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (NetworkInterface ni : nis) &#123;</span><br><span class="line">          <span class="keyword">if</span> (ni.isUp() &amp;&amp; !ni.isLoopback()) &#123;</span><br><span class="line">            addresses.addAll(Collections.list(ni.getInetAddresses()));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        local = findValidateIp(addresses);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// ignore</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (local != <span class="keyword">null</span>) &#123;</span><br><span class="line">        m_local = local;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">      <span class="comment">// ignore it</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    m_local = InetAddress.getLoopbackAddress();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：</p>
<ul>
<li>官方说还可以通过改host的方式实现，但是我在win10电脑上没有成功。</li>
<li>1.4修复了该问题</li>
</ul>
<p>参考链接：<a href="https://github.com/ctripcorp/apollo/wiki/部署&amp;开发遇到的常见问题#6-客户端多块网卡造成获取ip不准如何解决" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo/wiki/%E9%83%A8%E7%BD%B2&amp;%E5%BC%80%E5%8F%91%E9%81%87%E5%88%B0%E7%9A%84%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98#6-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A4%9A%E5%9D%97%E7%BD%91%E5%8D%A1%E9%80%A0%E6%88%90%E8%8E%B7%E5%8F%96ip%E4%B8%8D%E5%87%86%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3</a></p>
<p><a href="https://github.com/ctripcorp/apollo/issues/1457" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo/issues/1457</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/apollo/">apollo</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Kubernetes介绍" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/Kubernetes介绍/">Kubernetes介绍</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/Kubernetes介绍/" class="article-date">
	  <time datetime="2019-02-24T14:52:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>有了Docker之后，单个应用进程的使用管理变的更简单了，但是如果想要管理一个集群的不同应用，处理应用之间的关系，</p>
<p>比如：一个Web应用与数据库之间的访问关系，负载均衡和后端服务之间的代理关系，门户应用与授权组件的调用关系，</p>
<p>再比如说一个服务单位的不同功能之间的关系，如一个Web应用与日志搜集组件之间的文件交换关系，</p>
<p>在传统虚拟机环境对这种关系的处理方法都比较“粗颗粒”，一股脑的部署在同一台虚拟机中，需要手动维护很多跟应用协作的守护进程，用来处理它的日志搜集、灾难恢复、数据备份等辅助工作。</p>
<p>使用容器和编排技术以后，那些原来挤在同一个虚拟机里的各个应用、组件、守护进程，都可以被分别做成镜像，然后运行在一个个专属的容器中。</p>
<p>它们之间互不干涉，拥有各自的资源配额，可以被调度在整个集群里的任何一台机器上。</p>
<p>如果只是用来封装微服务、拉取用户镜像、调度单容器，用Docker Swarm就足够了，而且方便有效，但是如果需要路由网关、水平扩展、弹性伸缩、监控、备份、灾难恢复等一系列运维能力，就需要使用kubernetes来解决了。</p>
<h2 id="Kubernetes介绍"><a href="#Kubernetes介绍" class="headerlink" title="Kubernetes介绍"></a>Kubernetes介绍</h2><p><img src="http://image.sunshanpeng.com/timg.jpg" alt="kubernetes"></p>
<p>Kubernetes是Google开源的容器编排调度引擎，它的目标不仅仅是一个编排系统，而是提供一个规范，<strong>可以用来描述集群的架构，定义服务的最终状态</strong>，Kubernetes可以将系统自动得到和维持在这个状态。</p>
<p>更直白的说，Kubernetes用户可以通过编写一个yaml或者json格式的配置文件，也可以通过工具/代码生成或直接请求Kubernetes API创建应用，该配置文件中包含了用户想要应用程序保持的状态，不论整个Kubernetes集群中的个别主机发生什么问题，都不会影响应用程序的状态，你还可以通过改变该配置文件或请求Kubernetes API来改变应用程序的状态。</p>
<p><strong>配置文件里面怎么定义的，整个系统就是怎么运行的。</strong></p>
<h2 id="kubernetes-的马斯洛需求"><a href="#kubernetes-的马斯洛需求" class="headerlink" title="kubernetes 的马斯洛需求"></a>kubernetes 的马斯洛需求</h2><p><img src="http://image.sunshanpeng.com/cae7afc329d743429328887cb831d4c5.jpg" alt="image"></p>
<h2 id="Kubernetes架构图"><a href="#Kubernetes架构图" class="headerlink" title="Kubernetes架构图"></a>Kubernetes架构图</h2><p><img src="http://image.sunshanpeng.com/Yrdoo02.jpg" alt="img"></p>
<p>Kubernets属于主从的分布式集群架构，包含Master和Node：</p>
<ol>
<li><p>Master作为控制节点，调度管理整个系统，包含以下组件：</p>
<ul>
<li>API Server作为kubernetes系统的入口，封装了核心对象的增删改查操作，以RESTFul接口方式提供给外部客户和内部组件调用。它维护的REST对象将持久化到etcd(一个分布式强一致性的key/value存储)。</li>
<li>Scheduler：负责集群的资源调度，为新建的pod分配机器。这部分工作分出来变成一个组件，意味着可以很方便地替换成其他的调度器。</li>
<li>Controller Manager：负责执行各种控制器，目前有两类：<br>（1）Endpoint Controller：定期关联service和pod(关联信息由endpoint对象维护)，保证service到pod的映射总是最新的。<br>（2）Replication Controller：定期关联replicationController和pod，保证replicationController定义的复制数量与实际运行pod的数量总是一致的。</li>
</ul>
</li>
<li><p>Node是运行节点，运行业务容器，包含以下组件：</p>
<ul>
<li>Kubelet：负责管控docker容器，如启动/停止、监控运行状态等。它会定期从etcd获取分配到本机的pod，并根据pod信息启动或停止相应的容器。同时，它也会接收apiserver的HTTP请求，汇报pod的运行状态。</li>
<li>Kube Proxy：负责为pod提供代理。它会定期从etcd获取所有的service，并根据service信息创建代理。当某个客户pod要访问其他pod时，访问请求会经过本机proxy做转发。</li>
</ul>
<blockquote>
<p>Kubernets使用Etcd作为存储和通信中间件，实现Master和Node的一致性，这是目前比较常见的做法，典型的SOA架构，解耦Master和Node。</p>
</blockquote>
</li>
</ol>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p><img src="http://image.sunshanpeng.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20181017210240.png" alt="img"></p>
<ul>
<li><h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p>Pod是Kubernetes的基本操作单元，把相关的一个或多个容器构成一个Pod，通常Pod里的容器运行相同的应用。Pod包含的容器运行在同一个Node(Host)上，看作一个统一管理单元，共享相同的volumes和network namespace/IP和Port空间。</p>
</li>
<li><h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><p>Replication Controller确保任何时候Kubernetes集群中有指定数量的pod副本(replicas)在运行， 如果少于指定数量的pod副本(replicas)，Replication Controller会启动新的Container，反之会杀死多余的以保证数量不变。</p>
<p>Replication Controller使用预先定义的pod模板创建pods，一旦创建成功，pod 模板和创建的pods没有任何关联，可以修改pod 模板而不会对已创建pods有任何影响，也可以直接更新通过Replication Controller创建的pods。</p>
<p>对于利用pod 模板创建的pods，Replication Controller根据label selector来关联，通过修改pods的label可以删除对应的pods。</p>
</li>
<li><h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Service也是Kubernetes的基本操作单元，是真实应用服务的抽象，每一个服务后面都有很多对应的容器来支持，通过Proxy的port和服务selector决定服务请求传递给后端提供服务的容器，对外表现为一个单一访问接口，外部不需要了解后端如何运行，这给扩展或维护后端带来很大的好处。</p>
</li>
<li><h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><p>Label是用于区分Pod、Service、Replication Controller的key/value键值对，Pod、Service、 Replication Controller可以有多个label，但是每个label的key只能对应一个value。Labels是Service和Replication Controller运行的基础，为了将访问Service的请求转发给后端提供服务的多个容器，正是通过标识容器的labels来选择正确的容器。同样，Replication Controller也使用labels来管理通过pod 模板创建的一组容器，这样Replication Controller可以更加容易，方便地管理多个容器，无论有多少容器。</p>
</li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Pod的意义" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/Pod的意义/">Pod的意义</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/Pod的意义/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Kubernetes 使用 Pod 来管理容器，每个 Pod 可以包含一个或多个紧密关联的容器。</p>
<p>Pod 是一组紧密关联的容器集合，它们共享 PID、IPC、Network 和 UTS namespace，是 Kubernetes 调度的基本单位。</p>
<p>Pod 内的多个容器共享网络和文件系统，可以通过进程间通信和文件共享这种简单高效的方式组合完成服务。</p>
<p><img src="http://image.sunshanpeng.com/assets%252F-LDAOok5ngY4pc1lEDes%252F-LM_rqip-tinVoiFZE0I%252F-LM_sIwx4E3-69Ml-jNW%252Fpod.png" alt="img"></p>
<h2 id="Pod的意义"><a href="#Pod的意义" class="headerlink" title="Pod的意义"></a>Pod的意义</h2><p>容器都是单进程运行的，不是因为容器只能运行一个进程，而是容器没有管理多个进程的能力。</p>
<p>容器里PID=1的进程就是应用本身，其他的进程都是这个PID=1进程的子进程。如果启动了第二个进程，那这第二个进程异常退出的时候，外部并不能感知，也就管理不了。</p>
<p>在一个真正的操作系统里，进程并不是“孤苦伶仃”地独自运行的，应用之间可能有着密切的协作关系，必须部署在同一台机器上。</p>
<p>这些密切关系包括但不限于：互相之间会发生直接的文件交换，使用localhost或者Socket文件进行本地通信，会发生非常频繁的远程调用，共享某些Linux Namespace。</p>
<h2 id="Pod的实现原理"><a href="#Pod的实现原理" class="headerlink" title="Pod的实现原理"></a>Pod的实现原理</h2><p>首先，Pod只是一个逻辑概念，是一组共享了某些资源的容器。</p>
<p>Kubernetes真正处理的，还是宿主机操作系统上Linux容器的Namespace和Cgroups，而并不存在一个所谓的Pod的边界或者隔离环境。</p>
<p>Kubernetes里，Pod的实现需要使用一个中间容器，叫做Infra容器，在Pod中，Infra容器永远都是第一个被创建的容器。</p>
<p>其他用户自定义的容器，通过Join Network Namespace的方式与Infra容器关联在一起。</p>
<p><img src="http://image.sunshanpeng.com/image2018-10-17_19-22-48.png" alt="img"></p>
<p>如图所示，这个Pod里除了两个用户容器，还有一个Infra容器。</p>
<p>这个Infra容器占用极少的资源，使用了一个非常特殊的镜像：k8s.gcr.io/pause，这个镜像永远处于“暂停”状态，100-200KB左右大小。</p>
<p>Infra容器生成NetWork Namespace后，用户容器加入Infra容器的Network Namespace中，用户容器和Infra容器在宿主机上的Namespace文件是一样的。</p>
<p>这意味着，对Pod中的容器A和容器B来说：</p>
<ul>
<li>它们可以直接使用localhost进行通信；</li>
<li>他们看到的网络设备和Infra容器的一样；</li>
<li>一个Pod只有一个IP地址，也就是容器A、容器B、Infra容器的ip地址一致；</li>
<li>所有的网络资源被改Pod中的所有容器共享；</li>
<li>Pod的生命周期只跟Infra容器一致，与容器A和B无关。</li>
</ul>
<p>对于同一个Pod里面的所有用户容器来说，它们的进出流量，都是通过Infra容器完成的。</p>
<p>Pod的本质，实际上是在扮演传统基础设施“虚拟机”的角色；容器则是这个虚拟机里运行的用户进程。</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-使用apollo配置中心生成雪花算法的workerId" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/使用apollo配置中心生成雪花算法的workerId/">使用apollo配置中心生成雪花算法的workerId</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/使用apollo配置中心生成雪花算法的workerId/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在分布式系统中，有一些需要使用全局唯一ID的场景，这时候雪花算法（snowflake）就是一种不错的解决方式。</p>
<p>但是雪花算法需要用到一个workerId，同一个应用部署多个实例的时候workerId不能相同。</p>
<p>使用环境变量或者启动参数来指定workerId的方式虽然在一定程度上解决了workerId的问题，但是给容器环境下的自动化部署或者动态扩容带来了新的挑战。</p>
<h2 id="Apollo配置中心介绍"><a href="#Apollo配置中心介绍" class="headerlink" title="Apollo配置中心介绍"></a>Apollo配置中心介绍</h2><p>Apollo（阿波罗）是携程框架部门研发的分布式配置中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。</p>
<p>GitHub地址：<a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">https://github.com/ctripcorp/apollo</a><br><img src="https://github.com/ctripcorp/apollo/raw/master/doc/images/overall-architecture.png" alt="Apollo架构图"></p>
<p>Apollo分为Client、Config Service、Admin Service、Portal四个部分：</p>
<ul>
<li>Client是一个jar包集成在业务应用里，通过Meta Server从Config Service获取配置信息；</li>
<li>Config Service提供配置的读取、推送等功能，服务对象是Apollo客户端（Client）；</li>
<li>Admin Service提供配置的修改、发布等功能，服务对象是Apollo管理界面（Portal）；</li>
<li>Portal通过Meta Server连接Admin Service修改、发布配置信息。</li>
</ul>
<blockquote>
<p>ConfigDB存储配置信息，由Config Service和Admin Service使用；</p>
</blockquote>
<blockquote>
<p>PortalDB存储权限和审计信息，由Portal使用。</p>
</blockquote>
<h2 id="改造Config-Service生成workerId"><a href="#改造Config-Service生成workerId" class="headerlink" title="改造Config Service生成workerId"></a>改造Config Service生成workerId</h2><h3 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h3><p>Client端通过<code>/configs/{appId}/{clusterName}/{namespace:.+}</code>接口拉取全量配置信息，对应方法是<code>com.ctrip.framework.apollo.configservice.controller.ConfigController#queryConfig</code>。方法的返回值ApolloConfig有5个属性：<code>appId</code>、<code>cluster</code>、<code>namespaceName</code>、<code>configurations</code>、<code>releaseKey</code>,只要把生成的workerId放到<code>configurations</code>这个Map类型的属性中，Client端就能直接通过Key值拿到workerId来使用。</p>
<h3 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h3><h4 id="一、数据库改动"><a href="#一、数据库改动" class="headerlink" title="一、数据库改动"></a>一、数据库改动</h4><p>ConfigDB库的instance表存储了使用配置的应用实例。</p>
<p>在Instance表新加一个NodeId字段用来存储生成的workerId，并且将AppId和NodeId设置为唯一索引：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `instance` (</span><br><span class="line">  `Id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &apos;自增Id&apos;,</span><br><span class="line">  `AppId` varchar(32) NOT NULL DEFAULT &apos;default&apos; COMMENT &apos;AppID&apos;,</span><br><span class="line">  `ClusterName` varchar(32) NOT NULL DEFAULT &apos;default&apos; COMMENT &apos;ClusterName&apos;,</span><br><span class="line">  `DataCenter` varchar(64) NOT NULL DEFAULT &apos;default&apos; COMMENT &apos;Data Center Name&apos;,</span><br><span class="line">  `Ip` varchar(32) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;instance ip&apos;,</span><br><span class="line">  `NodeId` int(5) DEFAULT NULL COMMENT &apos;节点id&apos;,</span><br><span class="line">  `DataChange_CreatedTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &apos;创建时间&apos;,</span><br><span class="line">  `DataChange_LastTime` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;最后修改时间&apos;,</span><br><span class="line">  PRIMARY KEY (`Id`),</span><br><span class="line">  UNIQUE KEY `IX_UNIQUE_KEY` (`AppId`,`ClusterName`,`Ip`,`DataCenter`),</span><br><span class="line">  UNIQUE KEY `uk_appId_nodeId` (`AppId`,`NodeId`) USING BTREE,</span><br><span class="line">  KEY `IX_IP` (`Ip`),</span><br><span class="line">  KEY `IX_DataChange_LastTime` (`DataChange_LastTime`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6779 DEFAULT CHARSET=utf8mb4 COMMENT=&apos;使用配置的应用实例&apos;;</span><br></pre></td></tr></table></figure></p>
<h4 id="二、代码改动"><a href="#二、代码改动" class="headerlink" title="二、代码改动"></a>二、代码改动</h4><p>原来Instance表的记录是在获取配置时调用<code>com.ctrip.framework.apollo.configservice.util.InstanceConfigAuditUtil#audit</code>异步添加的，这里需要改成获取配置时同步添加实例信息并且放到<code>ApolloConfig</code>的<code>configurations</code>属性中。</p>
<p>1.<code>com.ctrip.framework.apollo.configservice.controller.ConfigController</code></p>
<p><code>queryConfig</code>方法返回前获取实例信息并返回<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Instance instance = instanceService.findInstance(appId, clusterName, dataCenter, clientIp);</span><br><span class="line">Integer nodeId = instance.getNodeId();</span><br><span class="line"><span class="keyword">if</span> (nodeId == <span class="keyword">null</span>) &#123;</span><br><span class="line">  nodeId = -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">apolloConfig.addConfig(<span class="string">"apollo.node.id"</span>, String.valueOf(nodeId));</span><br></pre></td></tr></table></figure></p>
<p>2.<code>com.ctrip.framework.apollo.biz.service.InstanceService</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;apollo.node.minId&#125;"</span>)<span class="comment">//workerId最小值，0-1023之间</span></span><br><span class="line"><span class="keyword">private</span> Integer minId;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;apollo.node.maxId&#125;"</span>)<span class="comment">//workerId最大值，0-1023之间</span></span><br><span class="line"><span class="keyword">private</span> Integer maxId;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Integer DEFAULT_NODE_ID = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Instance <span class="title">findInstance</span><span class="params">(String appId, String clusterName, String dataCenter, String ip)</span> </span>&#123;</span><br><span class="line">  Instance instance = instanceRepository.findByAppIdAndClusterNameAndDataCenterAndIp(appId, clusterName,</span><br><span class="line">          dataCenter, ip);</span><br><span class="line">  <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">    instance = createInstance(appId, clusterName, dataCenter, ip);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (instance.getNodeId() == <span class="keyword">null</span>) &#123;</span><br><span class="line">    updateInstance(instance);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Instance <span class="title">createInstance</span><span class="params">(String appId, String clusterName, String dataCenter, String ip)</span> </span>&#123;</span><br><span class="line">  Instance instance = <span class="keyword">new</span> Instance();</span><br><span class="line">  instance.setAppId(appId);</span><br><span class="line">  instance.setClusterName(clusterName);</span><br><span class="line">  instance.setDataCenter(dataCenter);</span><br><span class="line">  instance.setIp(ip);</span><br><span class="line">  instance.setNodeId(generateNodeId(appId));</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    instance = createInstance(instance);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (DataIntegrityViolationException e) &#123;</span><br><span class="line">    <span class="comment">//使用数据库的唯一约束来保证workerId的唯一性</span></span><br><span class="line">    logger.error(<span class="string">"createInstance.error,instance=&#123;&#125;"</span>, instance);</span><br><span class="line">    instance = findInstance(appId, clusterName, dataCenter, ip);</span><br><span class="line">    <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">      instance = createInstance(appId, clusterName, dataCenter, ip);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> instance;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">updateInstance</span><span class="params">(Instance instance)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        instance.setNodeId(generateNodeId(instance.getAppId()));</span><br><span class="line">        instanceRepository.save(instance);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (DataIntegrityViolationException e) &#123;</span><br><span class="line">        logger.error(<span class="string">"updateInstance.error,instance=&#123;&#125;"</span>, instance);</span><br><span class="line">        updateInstance(instance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Integer <span class="title">generateNodeId</span><span class="params">(String appId)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//生成规则是当前appId最大workerId + 1</span></span><br><span class="line">  <span class="comment">//如果workerId已经到最大值了就拿最早的workerId（这里假设一个应用不会同时有1023（maxId）个实例在运行）</span></span><br><span class="line">  Integer maxNodeId = instanceRepository.maxNodeIdByAppId(appId);</span><br><span class="line">  <span class="keyword">if</span> (maxNodeId == <span class="keyword">null</span> || minId &gt; maxNodeId) &#123;</span><br><span class="line">    <span class="keyword">return</span> minId;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (maxNodeId &lt; maxId) &#123;</span><br><span class="line">    <span class="keyword">return</span> maxNodeId + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> getEarliestNodeId(appId);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Integer <span class="title">getEarliestNodeId</span><span class="params">(String appId)</span> </span>&#123;</span><br><span class="line">      InstanceConfig instanceConfig = instanceConfigRepository.findTopByConfigAppIdOrderByReleaseDeliveryTime(appId);</span><br><span class="line">      <span class="keyword">if</span> (instanceConfig == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> DEFAULT_NODE_ID;</span><br><span class="line">      &#125;</span><br><span class="line">      Instance instance = instanceRepository.findOne(instanceConfig.getInstanceId());</span><br><span class="line">      <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> DEFAULT_NODE_ID;</span><br><span class="line">      &#125;</span><br><span class="line">      Integer nodeId = instance.getNodeId();</span><br><span class="line">      instance.setNodeId(<span class="keyword">null</span>);</span><br><span class="line">      instanceRepository.save(instance);</span><br><span class="line">      <span class="keyword">return</span> nodeId;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="三、使用方式"><a href="#三、使用方式" class="headerlink" title="三、使用方式"></a>三、使用方式</h4><p>和其他配置的使用方式一样，直接用<code>@Value(&quot;${apollo.node.id}&quot;)</code>。</p>
<p>这种方式生成的workerId可以直接使用在只需要一个workerId参数的雪花算法，另一种需要datacenterId和workerId两个参数的雪花算法在使用时需要做一下转换：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">datacenterId=apollo.node.id &gt;&gt; 5</span><br><span class="line">workerId=apolo.node.id &amp; 31</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>取高五位的值作为datacenterId，取低五位的值作为workerId。</p>
<ul>
<li>一个workerId参数的雪花算法，workerId最大1023，二进制为1111111111；</li>
<li>datacenterId和workerId两个参数的雪花算法，datacenterId最大31，二进制为11111，workerId最大31，二进制为11111，datacenterId作为二进制的高5位，workerId作为二进制的低5位，组合起来1111111111，十进制为1023。</li>
</ul>
</blockquote>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/apollo/">apollo</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-使用同一个deployment实现金丝雀（灰度）发布" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/使用同一个deployment实现金丝雀（灰度）发布/">使用同一个deployment实现金丝雀（灰度）发布</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/使用同一个deployment实现金丝雀（灰度）发布/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一、发布前"><a href="#一、发布前" class="headerlink" title="一、发布前"></a>一、发布前</h2><p>发布前，nginx运行三个实例（pod），<em>副本（replicaset）版本编号855b564c8d</em>，此时运行状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="二、发布中"><a href="#二、发布中" class="headerlink" title="二、发布中"></a>二、发布中</h2><h3 id="步骤一：发布"><a href="#步骤一：发布" class="headerlink" title="步骤一：发布"></a>步骤一：发布</h3><p>此时进行发布，<em>新副本版本编号77b6c7b585</em>，此时发布状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                         0/1       Running            0          21s       172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="步骤二：暂停"><a href="#步骤二：暂停" class="headerlink" title="步骤二：暂停"></a>步骤二：暂停</h3><p><strong>执行暂停命令<code>kubectl rollout pause deployment -n qa nginx</code></strong></p>
<p>等待第一个实例运行成功，此时状态如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                         1/1       Running            0          1m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>此时为暂停发布状态，三个旧版本实例正常运行，一个新版本实例运行成功，流量将分摊到这四个实例上。</p>
</blockquote>
<h3 id="步骤三：恢复"><a href="#步骤三：恢复" class="headerlink" title="步骤三：恢复"></a>步骤三：恢复</h3><p><strong>执行恢复命令<code>kubectl rollout resume deployment -n qa nginx</code></strong></p>
<p>此时状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                         0/1       Running            0          33s       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                        1/1       Running            0          1m        172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>恢复后会执行正常的滚动升级操作，即新增一个新副本实例，删除一个旧副本实例。<br>滚动升级时，新旧版本同时存在，总实例最大数量不会超过目标数量的25%，最小数量不会低于目标数量的75%。</p>
</blockquote>
<h2 id="三、发布完成"><a href="#三、发布完成" class="headerlink" title="三、发布完成"></a>三、发布完成</h2><p>实例的副本版本编号都变成77b6c7b585，说明全部升级成功，此时状态如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                       1/1       Running            0          36m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                      1/1       Running            0          36m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                      1/1       Running            0          2m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="四、回滚"><a href="#四、回滚" class="headerlink" title="四、回滚"></a>四、回滚</h2><p>发布中发现功能与预期不符，需要取消发布并回滚至上个发布版本，此时可以执行回滚操作。<br><strong>执行回滚命令<code>kubectl rollout undo deployment -n qa nginx</code></strong>。<br>回滚操作在发布中，发布后都可以执行。</p>
<h3 id="发布中回滚"><a href="#发布中回滚" class="headerlink" title="发布中回滚"></a>发布中回滚</h3><p>当暂停发布进行灰度验证时，发现功能不符合预期，需要取消发布。<br>暂停时灰度验证状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                         1/1       Running            0          2m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                         1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>回滚后状态:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-jqbjk                         1/1       Running            0          2m        172.20.235.215   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>副本编号变成855b564c8d，说明回滚成功，恢复到新版本。</p>
</blockquote>
<h3 id="发布完成后回滚"><a href="#发布完成后回滚" class="headerlink" title="发布完成后回滚"></a>发布完成后回滚</h3><p>全部升级成功后，发现功能异常，回滚到之前版本。<br>回滚前状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                        1/1       Running            0          36m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                       1/1       Running            0          36m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                       1/1       Running            0          2m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>回滚后状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                      1/1       Running            0          6m       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-jqbjk                        1/1       Running            0          6m        172.20.235.215   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                      1/1       Running            0          6m       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="滚动升级状态"><a href="#滚动升级状态" class="headerlink" title="滚动升级状态"></a>滚动升级状态</h2><p>目标实例数3个，旧实例数3个，总实例数3个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-855b564c8d-5qhk7                       1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                        1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                       1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，旧实例数3个，新实例数1个，总实例数4个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-vzc9g                        1/1       Running            0          1m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-hclp9                        1/1       Running            0          12h       172.20.235.210   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，旧实例数2个，新实例数2个，总实例数4个：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-pmw2f                       1/1       Running            0          15s       172.20.190.51    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-vzc9g                        1/1       Running            0          3m        172.20.42.156    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                        1/1       Running            0          12h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-n7kn8                        1/1       Running            0          12h       172.20.35.53     10.22.19.17   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，旧实例数1个，新实例数3个，总实例数4个<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                        1/1       Running            0          35m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                       1/1       Running            0          35m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                       1/1       Running            0          1m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br><span class="line">nginx-855b564c8d-5qhk7                       1/1       Running            0          13h       172.20.199.135   10.22.19.14   &lt;none&gt;</span><br></pre></td></tr></table></figure></p>
<p>目标实例数3个，新实例数3个，总实例数3个<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx-77b6c7b585-4bt6h                        1/1       Running            0          36m       172.20.190.56    10.22.19.6    &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-g4wnx                       1/1       Running            0          36m       172.20.42.172    10.22.19.15   &lt;none&gt;</span><br><span class="line">nginx-77b6c7b585-kcsqm                       1/1       Running            0          2m        172.20.235.253   10.22.19.5    &lt;none&gt;</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-修改Kubernetes集群Pod容器的内核参数" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/修改Kubernetes集群Pod容器的内核参数/">修改Kubernetes集群Pod容器的内核参数</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/修改Kubernetes集群Pod容器的内核参数/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>容器的本质是一个进程，共享Node的内核。原以为修改了Node的内核参数容器中也会改，但实际上并不是这样，容器的内核参数可以和Node不同。</p>
<h2 id="Docker-Daemon"><a href="#Docker-Daemon" class="headerlink" title="Docker Daemon"></a>Docker Daemon</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --rm --sysctl net.core.somaxconn=65535 busybox cat /proc/sys/net/core/somaxconn</span><br></pre></td></tr></table></figure>
<p>多个参数：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --restart=always --net=host \</span><br><span class="line">--name=centos01 --hostname=centos01 \</span><br><span class="line">--sysctl kernel.msgmnb=13107200 \</span><br><span class="line">--sysctl kernel.msgmni=256 \</span><br><span class="line">--sysctl kernel.msgmax=65536 \</span><br><span class="line">--sysctl kernel.shmmax=69719476736 \</span><br><span class="line">--sysctl kernel.sem=<span class="string">'500 256000 250 1024'</span> \</span><br><span class="line">-v /mnt:/update \</span><br><span class="line">centos /bin/bash</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">docker <span class="built_in">exec</span> centos01 sysctl -a |grep -E \</span><br><span class="line"><span class="string">'kernel.msgmnb|kernel.msgmni|kernel.msgmax|kernel.shmmax|kernel.sem'</span></span><br></pre></td></tr></table></figure>
<h2 id="Kubernetes"><a href="#Kubernetes" class="headerlink" title="Kubernetes"></a>Kubernetes</h2><h3 id="Kubernetes-Sysctls"><a href="#Kubernetes-Sysctls" class="headerlink" title="Kubernetes Sysctls"></a>Kubernetes Sysctls</h3><ol>
<li><p>增加Kubelet启动参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubelet --allowed-unsafe-sysctls=net.*</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新加载配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
</li>
<li><p>重启kubelet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Pod的securityContext参数（注意是pod不是container）</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">securityContext:</span><br><span class="line">  sysctls:</span><br><span class="line">  - name: net.ipv4.tcp_keepalive_time</span><br><span class="line">    value: &quot;180&quot;</span><br></pre></td></tr></table></figure>
<p>Kubernetes允许配置的内核参数如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kernel.shm*,</span><br><span class="line">kernel.msg*,</span><br><span class="line">kernel.sem,</span><br><span class="line">fs.mqueue.*,</span><br><span class="line">net.*.</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>使用Kubernetes Sysctls推荐指定几台Node，利用污点或者节点亲和性把需要修改内核参数的pod调度到指定节点，而不是修改所有Node。</p>
</blockquote>
<h3 id="Kubernetes-Init-Container"><a href="#Kubernetes-Init-Container" class="headerlink" title="Kubernetes Init Container"></a>Kubernetes Init Container</h3><p>使用init container不需要修改kubelet参数<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">initContainers:</span></span><br><span class="line"><span class="attr">- command:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">sysctl</span></span><br><span class="line"><span class="bullet">  -</span> <span class="bullet">-w</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">net.ipv4.tcp_keepalive_time=180</span></span><br><span class="line"><span class="attr">  image:</span> <span class="attr">busybox:1.27</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">init-sysctl</span></span><br><span class="line"><span class="attr">  securityContext:</span></span><br><span class="line"><span class="attr">    privileged:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://www.cnblogs.com/DaweiJ/articles/8528687.html" target="_blank" rel="noopener">https://www.cnblogs.com/DaweiJ/articles/8528687.html</a></li>
<li><a href="https://yq.aliyun.com/articles/603745?utm_content=m_1000003707" target="_blank" rel="noopener">https://yq.aliyun.com/articles/603745?utm_content=m_1000003707</a></li>
<li><a href="https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/</a></li>
</ul>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/k8s/">k8s</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-常用的IntelliJ IDEA 插件推荐" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/常用的IntelliJ IDEA 插件推荐/">常用的IntelliJ IDEA 插件推荐</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/常用的IntelliJ IDEA 插件推荐/" class="article-date">
	  <time datetime="2019-02-24T14:29:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一、Free-Mybatis-plugin"><a href="#一、Free-Mybatis-plugin" class="headerlink" title="一、Free Mybatis plugin"></a>一、Free Mybatis plugin</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/8321-free-mybatis-plugin/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/8321-free-mybatis-plugin/</a></p>
</blockquote>
<p>1.把mybatis的xml文件和代码关联上，可以在mapper接口直接跳转到对应的SQL语句。</p>
<p><img src="http://image.sunshanpeng.com/201908181216_569.png" alt="mybatis"></p>
<p>2.如果没有对应的SQL语句，可以快捷补全（当然具体SQL语句还是要自己写）。</p>
<p><img src="http://image.sunshanpeng.com/201908181217_431.png" alt="sql"></p>
<h3 id="二、Maven-Helper"><a href="#二、Maven-Helper" class="headerlink" title="二、Maven Helper"></a>二、Maven Helper</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/7179-maven-helper/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/7179-maven-helper/</a></p>
</blockquote>
<p>简单、方便的查看maven依赖和冲突</p>
<p><img src="http://image.sunshanpeng.com/201908181217_88.png" alt="maven helper"></p>
<p><img src="http://image.sunshanpeng.com/201908181218_140.png" alt="maven helper"></p>
<h3 id="三、GenerateAllSetter"><a href="#三、GenerateAllSetter" class="headerlink" title="三、GenerateAllSetter"></a>三、GenerateAllSetter</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/9360-generateallsetter/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/9360-generateallsetter/</a></p>
</blockquote>
<p>一键调用一个对象的所有的set方法</p>
<p><img src="http://image.sunshanpeng.com/201908181219_563.png" alt="generateAllSetter"></p>
<h3 id="四、RestfulToolkit"><a href="#四、RestfulToolkit" class="headerlink" title="四、RestfulToolkit"></a>四、RestfulToolkit</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/10292-restfultoolkit/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/10292-restfultoolkit/</a></p>
</blockquote>
<p>通过URL查询对应的方法，可以根据请求方法过滤，另外支持简单的HTTP调用。</p>
<p><img src="http://image.sunshanpeng.com/201908181219_755.png" alt="restfulToolkit"></p>
<p><img src="http://image.sunshanpeng.com/201908181220_291.png" alt></p>
<h3 id="五、Key-Promoter-X"><a href="#五、Key-Promoter-X" class="headerlink" title="五、Key Promoter X"></a>五、Key Promoter X</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/9792-key-promoter-x/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/9792-key-promoter-x/</a></p>
</blockquote>
<p>帮助我们快速的掌握 <strong>IntelliJ IDEA</strong>的快捷键。</p>
<p><img src="http://image.sunshanpeng.com/201908181221_36.gif" alt></p>
<h3 id="六、GsonFormat"><a href="#六、GsonFormat" class="headerlink" title="六、GsonFormat"></a>六、GsonFormat</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/7654-gsonformat/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/7654-gsonformat/</a></p>
</blockquote>
<p>快速方便的把json字符串转换为实体类（快捷键ALT+S）。</p>
<p><img src="http://image.sunshanpeng.com/201908181221_537.png" alt></p>
<h3 id="七、String-Manipulation"><a href="#七、String-Manipulation" class="headerlink" title="七、String Manipulation"></a>七、String Manipulation</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/2162-string-manipulation/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/2162-string-manipulation/</a></p>
</blockquote>
<p>快捷方便的把字符串在驼峰、大小写等格式之间转换（快捷键Alt+M)。</p>
<p><img src="http://image.sunshanpeng.com/201908181222_332.png" alt></p>
<p><img src="https://plugins.jetbrains.com/files/2162/screenshot_16015.png" alt="Screenshot 2"></p>
<h3 id="八、Alibaba-Java-Coding-Guidelines"><a href="#八、Alibaba-Java-Coding-Guidelines" class="headerlink" title="八、Alibaba Java Coding Guidelines"></a>八、Alibaba Java Coding Guidelines</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/10046-alibaba-java-coding-guidelines/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/10046-alibaba-java-coding-guidelines/</a></p>
</blockquote>
<p>扫描代码是否符合规范</p>
<p><img src="http://image.sunshanpeng.com/201908181222_445.png" alt></p>
<h3 id="九、Lombok"><a href="#九、Lombok" class="headerlink" title="九、Lombok"></a>九、Lombok</h3><p>简化java bean的代码量，自动生成get set toString EqualsAndHashCode 构造器。</p>
<blockquote>
<p>需要引入依赖包</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; &lt;dependency&gt;  </span><br><span class="line">&gt;           &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;  </span><br><span class="line">&gt;           &lt;artifactId&gt;lombok&lt;/artifactId&gt;   </span><br><span class="line">&gt; &lt;/dependency&gt;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="十、-ignore"><a href="#十、-ignore" class="headerlink" title="十、.ignore"></a>十、.ignore</h3><blockquote>
<p><a href="https://plugins.jetbrains.com/plugin/7495--ignore/" target="_blank" rel="noopener">https://plugins.jetbrains.com/plugin/7495--ignore/</a></p>
</blockquote>
<p>使用协作或者打包工具时，方便的处理要忽略的文件和文件夹。</p>
<p><img src="https://plugins.jetbrains.com/files/7495/screenshot_14958.png" alt="Screenshot 1"></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/java/">java</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/idea/">idea</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-Docker的本质" class="article article-type-post" itemscope itemprop="blogPost">
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/2019/02/24/Docker的本质/">Docker的本质</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	<a href="/2019/02/24/Docker的本质/" class="article-date">
	  <time datetime="2019-02-24T14:26:37.000Z" itemprop="datePublished">二月 24, 2019</time>
	</a>

      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>
 
      
    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Docker容器其实是一种沙盒技术，能够像一个集装箱一样，把应用“装”起来。</p>
<p>这样应用与应用之间，就因为有了边界而<strong>不会相互干扰</strong>；</p>
<p>被装进集装箱的应用，也<strong>可以被方便地搬来搬去</strong>。</p>
<p><strong>容器的本质，是由Namespace、Cgroups和rootfs三种技术构建出来的进程的隔离环境。</strong></p>
<p>Docke容器技术的核心功能，是通过约束和修改进程的动态表现，从而为其创造出一个“边界”。</p>
<p>Namespace技术是用来修改进程视图的主要方法，Cgroups技术是用来制造约束的主要手段，rootfs技术是用来限制进程文件系统的主要方式。</p>
<h2 id="Namespace："><a href="#Namespace：" class="headerlink" title="Namespace："></a>Namespace：</h2><p>正常情况下，每当我们在宿主机上运行一个程序的时候，操作系统都会给它分配一个进程编号，比如PID=100。这是进程的唯一标识，就像员工的工号一样。</p>
<p>而通过Docker把程序运行在容器中的时候，利用Namespace技术给进程施一个“障眼法”，让它看不到其他的进程，误以为只有它一个进程。</p>
<p>这种机制对被隔离的应用的进程空间做了限制，使其只能看到重新计算过的进程编号，比如PID=1，但事实上它在宿主机的操作系统里，还是原来的100号进程。</p>
<p>除了PID Namespace，Linux系统还提供了Mount、UTS、IPC、Network和User这些Namespace，用来对各种不同的进程上下文进行“障眼法”操作。</p>
<p>比如用Mount Namespace让被隔离的进程只能看到当前Namespace里的挂载点信息；Network Namespace让被隔离的进程只能看到当前Namespace的网络设备和配置。</p>
<p>所以，实际上Docker容器只是指定了这个进程所需要启用的一组Namespace参数，从而让进程只能看到当前Namespace所限定的资源、文件、设备、状态和配置等，对宿主机和其他不相关的程序完全看不到。</p>
<p>所以也可以说，容器其实就是一种特殊的进程而已。</p>
<h3 id="虚拟机和Docker容器比较"><a href="#虚拟机和Docker容器比较" class="headerlink" title="虚拟机和Docker容器比较"></a>虚拟机和Docker容器比较</h3><p> <img src="http://image.sunshanpeng.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20181013171129.jpg" alt="img"></p>
<p>在理解Docker的时候，通常会用这张图来比较虚拟机和Docker。</p>
<p>左边画出了虚拟机的工作原理：其中Hypervisor是虚拟机最主要的部分，它通过硬件虚拟化功能，模拟出运行一个操作系统需要的各种硬件，比如CPU、内存、I/O设备等等。然后它在这些虚拟的硬件上安装了一个新的操作系统，即Guest OS。</p>
<p>这样，用户的应用进程就可以运行在这个虚拟机的机器中，它能够看到的自然也只有Guest OS的文件和目录，以及这个机器里的虚拟设备。</p>
<p>右边用一个名为Docker Engine的软件替换了Hypervisor，把虚拟机的概念套在了容器上，实际上这个说法是不严谨的，跟真正存在的虚拟机不同，实际上并没有Docker Engine这一层。</p>
<p>Docker帮助用户启动的还是原来的应用进程，只不过在创建这些进程时给它们加上了各种各样的Namespace参数。</p>
<p>这样，这些进程就会觉得自己是各自PID Namespace里的第1号进程，只能看到各自Mount Namespace里挂载的目录和文件，只能访问各自Network Namespace里的网络设备，就好像运行在一个个独立的容器里。</p>
<p><img src="http://image.sunshanpeng.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20181013173339.jpg" alt="img"></p>
<p>Docker的架构其实这样画更合适</p>
<p>如果用虚拟化技术作为应用沙盒，就必须要由Hypervisor来负责创建虚拟机，这个虚拟机是真实存在的，并且它里面必须运行一个完整的Guest OS才能执行用户的应用进程。这就不可避免的带来的额外的资源消耗和占用。</p>
<p>根据实验，一个运行着CentOS的KVM虚拟机启动后，在不做优化的情况下，虚拟机自己就需要占用100~·200内存。此外，用户应用运行在虚拟机里面，对宿主机操作系统的调用就不可避免地进过虚拟化软件的拦截和处理，这本身又是一层性能损失。</p>
<p>使用Docker容器化后的用户应用，依然还是一个宿主机上的普通进程，这就意味着因为虚拟化而带来的性能损耗都是不存在的；</p>
<p>另一方面，使用Namespace作为隔离手段的容器并不需要单独的Guest OS，这使得容器额外的资源占用几乎可以忽略不计。</p>
<p>所以“敏捷”和“高性能”是容器相较于虚拟化最大的优势。</p>
<p>当然有利就有弊，Docker容器相较于虚拟化最大的弊端就是隔离的不彻底。</p>
<p>因为容器只是运行在宿主机上的一种特殊的进程，所以多个容器之间使用的还是同一个宿主机的操作系统内核。</p>
<p>另外，很多资源和对象不能被Namespace化，比如：时间。</p>
<h2 id="Cgroups："><a href="#Cgroups：" class="headerlink" title="Cgroups："></a>Cgroups：</h2><p>虽然容器内的进程在Namespace的作用下只能看到容器里的情况，但是在宿主机上，它作为第100号进程，与其它所有的进程之间依然是平等的竞争关系。</p>
<p>这就意味着，虽然这个进程表面上被隔离起来了，但它所能够使用到的资源（CPU、内存），却是可以随时被宿主机的其他进程（或者其他容器）占用。</p>
<p>当然这个进程也可能把所有的资源吃光，而Linux Cgroups就是Linux内核中用来为进程设置资源限制的一个重要功能。</p>
<p>跟Namespace的情况类似，Cgroups对资源的限制能力也有很多不完善的地方，比如/proc文件系统的问题。</p>
<p>/proc目录存储的是记录当前内核运行状态的一系列特殊文件，用户可以通过访问这些文件，查看系统以及当前正在运行的进程的信息，比如CPU使用情况，内存占用率等。</p>
<p>当我们在容器内执行top命令的时候，会发现它显示的信息是宿主机的CPU和内存，而不是当前容器的数据。</p>
<h2 id="rootfs："><a href="#rootfs：" class="headerlink" title="rootfs："></a>rootfs：</h2><p>在Linux操作系统里，有一个名为chroot的命令，作用是帮助我们“change root file”，即改变进程的根目录到指定的位置。</p>
<p>而对于被chroot的进程来说，它并不知道自己的根目录已经被修改了。Mount Namespace就是基于chroot的不断改良被发明出来的。</p>
<p>为了让容器的根目录更加真实，一般会在这个容器的根目录下挂载一个完整操作系统的文件系统，比如Ubuntu 16.04的ISO。</p>
<p>这样，在容器启动之后，我们在容器里通过执行“ls /”查看根目录下的内容，就是Ubuntu 16.04的所有目录和文件。</p>
<p>这个挂载在容器根目录上，用来为容器进程提供隔离后执行环境的文件系统，就是容器镜像，专业名字rootfs(根文件系统)。</p>
<p>一个常见的rootfs，或者说容器镜像，会包含比如bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  test  tmp  usr  var等的目录和文件。</p>
<p>进入容器后执行的/bin/bash，就是/bin目录下的可执行文件，与宿主机的/bin/bash完全不同。</p>
<p>rootfs只是一个操作系统所包含的文件、配置和目录，并不包括操作系统内核。</p>
<p>所以说rootfs只包括了操作系统的“躯壳”，并没有包括操作系统的“灵魂”，同一台机器上的所有容器，都是共享宿主机操作系统的内核。</p>
<p>这意味着，容器进程需要配置内核参数、加载额外的内核模块，以及跟内核进行直接交互的时候，需要注意这些操作和依赖的对象，都是宿主机操作系统的内核，对该机器上的所有容器生效。</p>
<p>不过也真是由于rootfs，容器才有了一个被反复宣传至今的重要特性：一致性。</p>
<p>由于rootfs里打包的不只是应用，而是整个操作系统的文件和目录，也就意味着，应用以及它运行所需要的所有依赖，都被封装在了一起。</p>
<p>有了容器镜像“打包操作系统”的能力，这个最基础的依赖环境也变成了应用沙盒的一部分，这就赋予了容器的所谓一致性。</p>
<p>无论在本地、云端，还是在任何机器上，用户只需要解压打包好的容器镜像，那么这个应用运行所需要的完整的执行环境就被重现出来了。</p>
<p>这种深入到操作系统级别的运行环境一致性，打通了应用在本地开发和远端执行环境之间难以逾越的鸿沟。</p>
<p>另外，Docker在镜像的设计中，引入了层（layer）的概念，也就是说，用户制作镜像的每一步操作，都会生成一个层，也就是一个增量的rootfs。</p>
<p>这个设计用到了一种叫做联合文件系统（Union File System）的能力，也叫UnionFS,最主要的功能是将多个不同位置的目录联合挂载到同一个目录下。</p>
<p><img src="http://image.sunshanpeng.com/%E5%BE%AE%E4%BF%A1%E5%9B%BE%E7%89%87_20181014213926.jpg" alt="img"></p>
<p>如图所示，容器中的rootfs分为只读层、Init层、可读写层。</p>
<p>只读层：包含了操作系统的一部分。</p>
<p>Init层：夹在只读层和可读写层中间，是Docker项目单独生成的一个内部层，用来存在/etc/hosts、/etc/resolv.conf等信息。</p>
<p>可读写层：用来存放修改rootfs后产生的增量，无论增、删、改，都发生在这里。</p>
<p>使用docker commit和push指令保存并上传被修改过的容器的时候，只读层和Init层不会有任何变化，变化的只是可读写层。</p>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>实际操作中，我们不会使用docker commit命令来把一个运行中的docker容器提交成为一个docker镜像。</p>
<p>使用 <code>docker commit</code> 意味着所有对镜像的操作都是黑箱操作，生成的镜像也被称为黑箱镜像，换句话说，就是除了制作镜像的人知道执行过什么命令、怎么生成的镜像，别人根本无从得知。</p>
<p>另外结合之前的分层，任何修改的结果仅仅是在当前层进行标记、添加、修改，而不会改动上一层。</p>
<p>这样每一次修改都会让镜像更加臃肿一次，所删除的上一层的东西并不会丢失，会一直如影随形的跟着这个镜像，即使根本无法访问到。</p>
<p>把每一层修改、安装、构建、操作的命令都写入一个脚本，用这个脚本来构建、定制镜像，那么无法重复的问题、镜像构建透明性的问题、体积的问题就都会解决，这个脚本就是 Dockerfile。</p>
<p>Dockerfile 是一个文本文件，其内包含了一条条的指令(Instruction)，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建。</p>
<p>每一个 <code>RUN</code> 的行为，就和手动docker commit建立镜像的过程一样：新建立一层，在其上执行这些命令，执行结束后，<code>commit</code> 这一层的修改，构成新的镜像。</p>
<p><em>Union FS 是有最大层数限制的，比如 AUFS，曾经是最大不得超过 42 层，现在是不得超过 127 层。</em></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/容器/">容器</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

      
    </footer>
    <hr class="entry-footer-hr">
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 72%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 36px; width: 100%;" placeholder=" Search…" value name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="Search">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="Type something...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: 'Posts',
            PAGES: 'Pages',
            CATEGORIES: 'Categories',
            TAGS: 'Tags',
            UNTITLED: '(Untitled)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Connect With Us</h3>
    <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="https://github.com/sunshanpeng" title="Github"><i class="fa fa-github" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Weibo"><i class="fa fa-weibo" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Facebook"><i class="fa fa-facebook" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Google-plus"><i class="fa fa-google-plus" aria-hidden="true"></i></a></li> 

   		
   			<li><a href title="Instagram"><i class="fa fa-instagram" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a></li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>
		</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>Recent Posts</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/03/24/Docker常用命令/">Docker常用命令</a></h6>
              <span>三月 24, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/03/24/Kubernetes集群配置优化/">Kubernetes集群配置优化</a></h6>
              <span>三月 24, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/03/24/Windows电脑本地开发时连接Apollo配置中心启动慢/">Windows电脑本地开发时连接Apollo配置中心启动慢</a></h6>
              <span>三月 24, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/02/24/Kubernetes介绍/">Kubernetes介绍</a></h6>
              <span>二月 24, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/02/24/Pod的意义/">Pod的意义</a></h6>
              <span>二月 24, 2019</span>
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/2019/02/24/使用apollo配置中心生成雪花算法的workerId/">使用apollo配置中心生成雪花算法的workerId</a></h6>
              <span>二月 24, 2019</span>
            </div>

          </li>
        
      </ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java/">java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/linux/">linux</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/容器/">容器</a><span class="category-list-count">11</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/apollo/">apollo</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/idea/">idea</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/k8s/">k8s</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/apollo/" style="font-size: 13.33px;">apollo</a> <a href="/tags/docker/" style="font-size: 16.67px;">docker</a> <a href="/tags/idea/" style="font-size: 10px;">idea</a> <a href="/tags/k8s/" style="font-size: 20px;">k8s</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>

    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">一月 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">2</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/categories" class="mobile-nav-link">Categories</a>
  
    <a href="/tags" class="mobile-nav-link">Tags</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      &copy; 2019 阿鹏的博客 All Rights Reserved.
        
            <span id="busuanzi_container_site_uv">
              本站访客数<span id="busuanzi_value_site_uv"></span>人次  
              本站总访问量<span id="busuanzi_value_site_pv"></span>次
            </span>
          
      </div>
      <div class="site-credit">
        Theme by <a href="https://github.com/iTimeTraveler/hexo-theme-hipaper" target="_blank">hipaper</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";


    <!-- headerblur min height -->
    
      var headerblur = document.getElementById("header-blur");
      headerblur.style.minHeight = window.getComputedStyle(document.getElementById("allheader"), null).height;
    
    
</script>
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>







  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
  </div>



	<script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>






  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
</body>
</html>
